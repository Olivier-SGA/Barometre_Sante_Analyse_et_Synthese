<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidation Baromètre Santé 2025</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .file-input-wrapper {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            margin: 10px;
        }

        .upload-btn:hover {
            background: #2980b9;
        }

        .file-count {
            margin-top: 20px;
            font-weight: bold;
            color: #27ae60;
        }

        .results-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px;
        }

        .btn-primary {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #27ae60;
            color: white;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .detailed-results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .chart-wrapper canvas {
            max-width: 100%;
            height: auto !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Consolidation Baromètre Santé 2025</h1>
            <p>Interface d'analyse et de génération de rapports</p>
        </div>

        <div class="upload-section">
            <h2>Import des fichiers JSON</h2>
            <div class="file-input-wrapper" id="dropZone">
                <p><strong>Cliquez ici pour sélectionner vos fichiers JSON</strong></p>
                <input type="file" id="fileInput" style="display: none;" multiple accept=".json">
                <button type="button" class="upload-btn" id="selectButton" onclick="document.getElementById('fileInput').click()">Choisir les fichiers</button>
            </div>
            <div id="fileCount" class="file-count"></div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="loading" id="loading">
            <p>Traitement des données en cours...</p>
        </div>

        <div class="results-section" id="resultsSection">
            <h2>Résultats de l'analyse</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" id="pdfButton">Générer rapport PDF</button>
                <button class="btn btn-secondary" onclick="window.print()">Imprimer</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalResponses">0</span>
                    <span>Réponses analysées</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="avgPhysicalHealth">-</span>
                    <span>Santé physique moyenne</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="avgPsychHealth">-</span>
                    <span>Santé psychologique moyenne</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stressPercentage">-</span>
                    <span>Avec charge de travail élevée</span>
                </div>
            </div>

            <div class="detailed-results" id="detailedResults">
                <!-- Résultats détaillés -->
            </div>

            <div class="chart-container">
                <div class="chart-title">Répartition par profil professionnel</div>
                <div class="chart-wrapper">
                    <canvas id="profilChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Répartition par tranche d'âge</div>
                <div class="chart-wrapper">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Scores de santé moyens</div>
                <div class="chart-wrapper">
                    <canvas id="healthChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Sources de stress principales</div>
                <div class="chart-wrapper">
                    <canvas id="stressChart"></canvas>
                </div>
            </div>

            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h4>Status du système :</h4>
                <div id="system-status">
                    <p>Chart.js : <span id="chartjs-status">Chargement...</span></p>
                    <p>jsPDF : <span id="jspdf-status">Chargement...</span></p>
                    <p>Données : <span id="data-status">Aucune donnée importée</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chargement des bibliothèques externes AVANT le script principal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // TEST IMMÉDIAT pour vérifier que le JavaScript fonctionne
        console.log("=== SCRIPT CHARGÉ ===");
        
        // Variables globales
        window.analysisData = {
            responses: [],
            summary: {}
        };

        window.chartInstances = {
            profil: null,
            age: null,
            health: null,
            stress: null
        };

        window.librariesLoaded = {
            chartjs: false,
            jspdf: false
        };

        // Fonction de log sécurisée
        function safeLog(message) {
            console.log(message);
        }

        // Fonction de gestion d'erreur
        function handleError(error, context) {
            console.error('Erreur dans ' + context + ':', error);
            var errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.innerHTML = '<strong>Erreur:</strong> ' + error.toString();
                errorDiv.style.display = 'block';
            }
        }

        // FONCTION PRINCIPALE - Gestion de la sélection de fichiers
        window.handleFileSelection = function(files) {
            console.log("=== handleFileSelection appelée ===");
            console.log("Nombre de fichiers:", files ? files.length : 0);
            
            if (!files || files.length === 0) {
                console.log("Aucun fichier sélectionné");
                return;
            }
            
            var fileCountDiv = document.getElementById('fileCount');
            if (fileCountDiv) {
                fileCountDiv.textContent = files.length + ' fichier(s) sélectionné(s)';
            }
            
            var loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'block';
            }
            
            // Traitement asynchrone
            setTimeout(function() {
                processFiles(files);
            }, 100);
        };

        // Traitement des fichiers JSON
        function processFiles(files) {
            console.log("=== processFiles appelée ===");
            window.analysisData.responses = [];
            var validFiles = 0;
            var errors = [];

            function processNextFile(index) {
                if (index >= files.length) {
                    finishProcessing(validFiles, errors);
                    return;
                }

                var file = files[index];
                
                if (!file.name.toLowerCase().endsWith('.json')) {
                    errors.push(file.name + ': Format non supporté');
                    processNextFile(index + 1);
                    return;
                }

                var reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        var content = e.target.result;
                        var data = JSON.parse(content);
                        
                        if (!data.id) {
                            errors.push(file.name + ': ID manquant');
                        } else {
                            cleanDataDuplicates(data);
                            window.analysisData.responses.push(data);
                            validFiles++;
                            console.log("Fichier traité avec succès:", file.name);
                        }
                    } catch (parseError) {
                        errors.push(file.name + ': ' + parseError.toString());
                    }
                    
                    processNextFile(index + 1);
                };
                
                reader.onerror = function() {
                    errors.push(file.name + ': Erreur de lecture');
                    processNextFile(index + 1);
                };
                
                reader.readAsText(file);
            }

            processNextFile(0);
        }

        // Finalisation du traitement
        function finishProcessing(validFiles, errors) {
            console.log("=== finishProcessing ===");
            console.log("Fichiers valides:", validFiles);
            
            var loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }

            var fileCountDiv = document.getElementById('fileCount');
            if (fileCountDiv) {
                fileCountDiv.textContent = validFiles + ' fichier(s) traité(s) avec succès';
            }

            if (errors.length > 0) {
                var errorDiv = document.getElementById('errorMessage');
                if (errorDiv) {
                    errorDiv.innerHTML = '<strong>Erreurs:</strong><br>' + errors.join('<br>');
                    errorDiv.style.display = 'block';
                }
            }

            if (validFiles > 0) {
                document.getElementById('data-status').textContent = validFiles + ' fichier(s) chargé(s)';
                analyzeData();
                displayResults();
                
                setTimeout(function() {
                    checkLibrariesStatus();
                    if (window.librariesLoaded.chartjs) {
                        createAllCharts();
                    }
                }, 500);
            }
        }

        // Nettoyage des doublons
        function cleanDataDuplicates(data) {
            var fieldsToClean = ['sources_stress', 'symptomes_stress', 'obstacles_sport', 'ameliorations_prioritaires'];
            
            for (var i = 0; i < fieldsToClean.length; i++) {
                var field = fieldsToClean[i];
                if (data[field] && Array.isArray(data[field])) {
                    var unique = [];
                    for (var j = 0; j < data[field].length; j++) {
                        var value = data[field][j];
                        if (value && unique.indexOf(value) === -1) {
                            unique.push(value);
                        }
                    }
                    data[field] = unique;
                }
            }
        }

        // Analyse des données
        function analyzeData() {
            console.log("=== analyzeData ===");
            var responses = window.analysisData.responses;
            var summary = {};

            summary.total = responses.length;
            summary.dateAnalyse = new Date().toLocaleDateString('fr-FR');
            
            // Calcul des moyennes
            var physicalScores = [];
            var psychScores = [];
            
            for (var i = 0; i < responses.length; i++) {
                var r = responses[i];
                
                var physical = parseFloat(r.sante_physique);
                if (!isNaN(physical) && physical > 0 && physical <= 10) {
                    physicalScores.push(physical);
                }
                
                var psych = parseFloat(r.sante_psychologique);
                if (!isNaN(psych) && psych > 0 && psych <= 10) {
                    psychScores.push(psych);
                }
            }

            if (physicalScores.length > 0) {
                var sum = 0;
                for (var i = 0; i < physicalScores.length; i++) {
                    sum += physicalScores[i];
                }
                summary.avgPhysical = (sum / physicalScores.length).toFixed(1);
            } else {
                summary.avgPhysical = 'N/A';
            }

            if (psychScores.length > 0) {
                var sum = 0;
                for (var i = 0; i < psychScores.length; i++) {
                    sum += psychScores[i];
                }
                summary.avgPsych = (sum / psychScores.length).toFixed(1);
            } else {
                summary.avgPsych = 'N/A';
            }

            // Charge de travail
            var workloadIssues = 0;
            for (var i = 0; i < responses.length; i++) {
                if (responses[i].charge_travail === 'non') {
                    workloadIssues++;
                }
            }
            summary.workloadPercentage = ((workloadIssues / responses.length) * 100).toFixed(0);

            summary.profils = analyzeField(responses, 'profil');
            summary.ages = analyzeField(responses, 'age');
            summary.stressSources = analyzeMultipleChoiceField(responses, 'sources_stress');

            window.analysisData.summary = summary;
            console.log('Analyse terminée');
        }

        // Analyse d'un champ simple
        function analyzeField(responses, fieldName) {
            var counts = {};
            for (var i = 0; i < responses.length; i++) {
                var value = responses[i][fieldName] || 'Non renseigné';
                counts[value] = (counts[value] || 0) + 1;
            }
            return counts;
        }

        // Analyse d'un champ à choix multiples
        function analyzeMultipleChoiceField(responses, fieldName) {
            var counts = {};
            for (var i = 0; i < responses.length; i++) {
                var values = responses[i][fieldName];
                if (Array.isArray(values)) {
                    for (var j = 0; j < values.length; j++) {
                        var value = values[j];
                        if (value) {
                            counts[value] = (counts[value] || 0) + 1;
                        }
                    }
                }
            }
            return counts;
        }

        // Affichage des résultats
        function displayResults() {
            console.log("=== displayResults ===");
            var summary = window.analysisData.summary;
            
            document.getElementById('totalResponses').textContent = summary.total;
            document.getElementById('avgPhysicalHealth').textContent = summary.avgPhysical;
            document.getElementById('avgPsychHealth').textContent = summary.avgPsych;
            document.getElementById('stressPercentage').textContent = summary.workloadPercentage + '%';

            displayDetailedResults();

            document.getElementById('resultsSection').style.display = 'block';
        }

        // Affichage des résultats détaillés
        function displayDetailedResults() {
            var summary = window.analysisData.summary;
            var container = document.getElementById('detailedResults');
            
            if (!container) return;
            
            var html = '<h3>Analyse détaillée</h3>';
            
            // Profils
            html += '<h4>Répartition par profil:</h4><ul>';
            for (var key in summary.profils) {
                var count = summary.profils[key];
                var percentage = ((count / summary.total) * 100).toFixed(1);
                html += '<li>' + formatProfil(key) + ': ' + count + ' (' + percentage + '%)</li>';
            }
            html += '</ul>';
            
            // Ages
            html += '<h4>Répartition par âge:</h4><ul>';
            for (var key in summary.ages) {
                var count = summary.ages[key];
                var percentage = ((count / summary.total) * 100).toFixed(1);
                html += '<li>' + formatAge(key) + ': ' + count + ' (' + percentage + '%)</li>';
            }
            html += '</ul>';
            
            // Sources de stress
            if (summary.stressSources) {
                html += '<h4>Sources de stress:</h4><ul>';
                
                var stressArray = [];
                for (var key in summary.stressSources) {
                    stressArray.push({key: key, count: summary.stressSources[key]});
                }
                stressArray.sort(function(a, b) { return b.count - a.count; });
                
                for (var i = 0; i < Math.min(10, stressArray.length); i++) {
                    var item = stressArray[i];
                    var displayKey = formatStressSource(item.key);
                    html += '<li>' + displayKey + ': ' + item.count + ' mentions</li>';
                }
                html += '</ul>';
            }
            
            container.innerHTML = html;
        }

        // Vérification des bibliothèques
        function checkLibrariesStatus() {
            window.librariesLoaded.chartjs = typeof Chart !== 'undefined';
            window.librariesLoaded.jspdf = typeof window.jspdf !== 'undefined';
            
            document.getElementById('chartjs-status').textContent = window.librariesLoaded.chartjs ? 'Chargé' : 'Non chargé';
            document.getElementById('jspdf-status').textContent = window.librariesLoaded.jspdf ? 'Chargé' : 'Non chargé';
            
            return window.librariesLoaded.chartjs && window.librariesLoaded.jspdf;
        }

        // Création de tous les graphiques
        function createAllCharts() {
            console.log("=== createAllCharts ===");
            
            if (!window.Chart) {
                console.error('Chart.js non disponible');
                return;
            }

            // Destruction des graphiques existants
            if (window.chartInstances.profil) window.chartInstances.profil.destroy();
            if (window.chartInstances.age) window.chartInstances.age.destroy();
            if (window.chartInstances.health) window.chartInstances.health.destroy();
            if (window.chartInstances.stress) window.chartInstances.stress.destroy();

            createProfilChart();
            createAgeChart();
            createHealthChart();
            createStressChart();
        }

        // Graphique des profils
        function createProfilChart() {
            var ctx = document.getElementById('profilChart');
            if (!ctx) return;
            
            var data = window.analysisData.summary.profils;
            if (!data || Object.keys(data).length === 0) return;
            
            var labels = [];
            var values = [];
            var colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'];
            
            for (var key in data) {
                labels.push(formatProfil(key));
                values.push(data[key]);
            }
            
            window.chartInstances.profil = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Graphique des âges
        function createAgeChart() {
            var ctx = document.getElementById('ageChart');
            if (!ctx) return;
            
            var data = window.analysisData.summary.ages;
            if (!data || Object.keys(data).length === 0) return;
            
            var labels = [];
            var values = [];
            
            var ageOrder = ['moins_25', '25_30', '30_40', '40_50', '50_60', 'plus_60'];
            
            for (var i = 0; i < ageOrder.length; i++) {
                var key = ageOrder[i];
                if (data[key]) {
                    labels.push(formatAge(key));
                    values.push(data[key]);
                }
            }
            
            window.chartInstances.age = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre de répondants',
                        data: values,
                        backgroundColor: 'rgba(103, 126, 234, 0.7)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Graphique santé
        function createHealthChart() {
            var ctx = document.getElementById('healthChart');
            if (!ctx) return;
            
            var summary = window.analysisData.summary;
            var physicalScore = parseFloat(summary.avgPhysical) || 0;
            var psychScore = parseFloat(summary.avgPsych) || 0;
            
            window.chartInstances.health = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Santé Physique', 'Santé Psychologique'],
                    datasets: [{
                        label: 'Score moyen',
                        data: [physicalScore, psychScore],
                        backgroundColor: ['rgba(46, 204, 113, 0.7)', 'rgba(155, 89, 182, 0.7)'],
                        borderColor: ['#2ecc71', '#9b59b6'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }

        // Graphique stress
        function createStressChart() {
            var ctx = document.getElementById('stressChart');
            if (!ctx) return;
            
            var data = window.analysisData.summary.stressSources;
            if (!data || Object.keys(data).length === 0) return;
            
            var stressArray = [];
            for (var key in data) {
                stressArray.push({key: key, count: data[key]});
            }
            stressArray.sort(function(a, b) { return b.count - a.count; });
            
            var labels = [];
            var values = [];
            
            for (var i = 0; i < Math.min(5, stressArray.length); i++) {
                labels.push(formatStressSource(stressArray[i].key));
                values.push(stressArray[i].count);
            }
            
            window.chartInstances.stress = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(230, 126, 34, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(155, 89, 182, 0.7)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Fonctions de formatage
        function formatProfil(key) {
            var mapping = {
                'auditeur': 'Auditeur/Auditrice',
                'chef_mission': 'Chef de mission',
                'directeur_mission': 'Directeur de mission'
            };
            return mapping[key] || key;
        }

        function formatAge(key) {
            var mapping = {
                'moins_25': 'Moins de 25 ans',
                '25_30': '25-30 ans',
                '30_40': '30-40 ans',
                '40_50': '40-50 ans',
                '50_60': '50-60 ans',
                'plus_60': 'Plus de 60 ans'
            };
            return mapping[key] || key;
        }

        function formatStressSource(key) {
            var mapping = {
                'gestion_clients': 'Gestion des clients',
                'complexite_dossiers': 'Complexité des dossiers',
                'tenue_delais': 'Tenue des délais',
                'pression_hierarchique': 'Pression hiérarchique',
                'outils_inefficaces': 'Outils inefficaces',
                'horaires_contraintes': 'Contraintes horaires',
                'manque_formation': 'Manque de formation',
                'pas_stresse': 'Pas de stress'
            };
            return mapping[key] || key;
        }

        // GÉNÉRATION PDF (fonction simplifiée pour les tests)
        window.generatePDF = function() {
            console.log("=== generatePDF appelée ===");
            alert("Génération PDF - Cette fonction sera implémentée après que l'import fonctionne");
        };

        // INITIALISATION AU CHARGEMENT
        document.addEventListener('DOMContentLoaded', function() {
            console.log
