<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barom√®tre Sant√© 2025 - Analyse des R√©sultats</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header h2 {
            color: #667eea;
            font-size: 1.3rem;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: #f0f4ff;
        }

        .upload-zone.dragover {
            border-color: #764ba2;
            background: #e6f3ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #4a5568;
            margin-bottom: 15px;
        }

        .upload-subtext {
            color: #666;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .file-list {
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            padding: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            color: #667eea;
            font-size: 1.2rem;
        }

        .remove-file {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .analysis-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #cce7ff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analyse des R√©sultats</h1>
            <h2>Barom√®tre Sant√© 2025 - Cabinet Saint Germain Audit</h2>
            <p>Importez les fichiers JSON des r√©ponses pour g√©n√©rer une synth√®se compl√®te</p>
        </div>

        <div class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Cliquez pour s√©lectionner ou glissez-d√©posez les fichiers JSON</div>
                <div class="upload-subtext">S√©lectionnez tous les fichiers de r√©ponses (.json) du barom√®tre sant√©</div>
                <input type="file" id="fileInput" class="file-input" multiple accept=".json">
            </div>

            <div id="fileList" class="file-list" style="display: none;">
                <h3>Fichiers s√©lectionn√©s :</h3>
                <div id="fileListContent"></div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button id="analyzeBtn" class="btn" disabled>Analyser les donn√©es</button>
                <button id="clearBtn" class="btn" style="background: #e53e3e;">Effacer tout</button>
            </div>

            <div id="alerts"></div>
        </div>

        <div class="analysis-section" id="analysisSection">
            <h2>Synth√®se des R√©sultats</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalResponses">0</div>
                    <div class="stat-label">R√©ponses collect√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSantePhysique">0</div>
                    <div class="stat-label">Sant√© physique moyenne (/10)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSantePsycho">0</div>
                    <div class="stat-label">Sant√© psychologique moyenne (/10)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stressLevel">0%</div>
                    <div class="stat-label">Collaborateurs stress√©s</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">R√©partition par Profil Professionnel</div>
                <canvas id="profileChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">R√©partition par Tranche d'√Çge</div>
                <canvas id="ageChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">√âvaluation de la Sant√© (Notes moyennes)</div>
                <canvas id="healthChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Qualit√© de Vie au Travail</div>
                <canvas id="qvtChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Sources de Stress Principales</div>
                <canvas id="stressChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">R√©partition du T√©l√©travail</div>
                <canvas id="teletravailChart"></canvas>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button id="exportPdfBtn" class="btn">üìÑ G√©n√©rer le rapport PDF</button>
            </div>
        </div>
    </div>

    <script>
        class HealthSurveyAnalyzer {
            constructor() {
                this.responses = [];
                this.charts = {};
                this.init();
            }

            init() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                const uploadZone = document.getElementById('uploadZone');
                const fileInput = document.getElementById('fileInput');
                const analyzeBtn = document.getElementById('analyzeBtn');
                const clearBtn = document.getElementById('clearBtn');
                const exportPdfBtn = document.getElementById('exportPdfBtn');

                // Upload zone events
                uploadZone.addEventListener('click', () => fileInput.click());
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });
                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    this.handleFiles(e.dataTransfer.files);
                });

                // File input
                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });

                // Buttons
                analyzeBtn.addEventListener('click', () => this.analyzeData());
                clearBtn.addEventListener('click', () => this.clearAll());
                exportPdfBtn.addEventListener('click', () => this.exportToPDF());
            }

            handleFiles(files) {
                const jsonFiles = Array.from(files).filter(file => file.name.endsWith('.json'));
                
                if (jsonFiles.length === 0) {
                    this.showAlert('Aucun fichier JSON valide s√©lectionn√©', 'error');
                    return;
                }

                this.loadJsonFiles(jsonFiles);
            }

            async loadJsonFiles(files) {
                const fileList = document.getElementById('fileList');
                const fileListContent = document.getElementById('fileListContent');
                const analyzeBtn = document.getElementById('analyzeBtn');
                
                fileListContent.innerHTML = '';
                this.responses = [];

                for (const file of files) {
                    try {
                        const content = await this.readFile(file);
                        const data = JSON.parse(content);
                        
                        if (this.validateResponseData(data)) {
                            this.responses.push(data);
                            this.addFileToList(file.name, fileListContent);
                        } else {
                            this.showAlert(`Fichier ${file.name} : format non valide`, 'error');
                        }
                    } catch (error) {
                        this.showAlert(`Erreur lecture ${file.name} : ${error.message}`, 'error');
                    }
                }

                if (this.responses.length > 0) {
                    fileList.style.display = 'block';
                    analyzeBtn.disabled = false;
                    this.showAlert(`${this.responses.length} fichier(s) charg√©(s) avec succ√®s`, 'success');
                } else {
                    analyzeBtn.disabled = true;
                }
            }

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(new Error('Erreur de lecture du fichier'));
                    reader.readAsText(file);
                });
            }

            validateResponseData(data) {
                console.log('Validation des donn√©es:', data);
                // V√©rification plus permissive de la structure des donn√©es
                const isValid = data && 
                       typeof data === 'object' &&
                       data.id && 
                       (data.cabinet === 'Saint Germain Audit' || data.version_barometre);
                       
                console.log('Donn√©es valides:', isValid);
                return isValid;
            }

            addFileToList(fileName, container) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">üìÑ</span>
                        <span>${fileName}</span>
                    </div>
                    <button class="remove-file" onclick="this.parentNode.remove()">Supprimer</button>
                `;
                container.appendChild(fileItem);
            }

            analyzeData() {
                console.log('D√©but de l\'analyse, nombre de r√©ponses:', this.responses.length);
                
                if (this.responses.length === 0) {
                    this.showAlert('Aucune donn√©e √† analyser', 'error');
                    return;
                }

                try {
                    this.showAlert('Analyse en cours...', 'info');
                    this.calculateStatistics();
                    this.createCharts();
                    document.getElementById('analysisSection').style.display = 'block';
                    document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
                    this.showAlert('Analyse termin√©e avec succ√®s', 'success');
                } catch (error) {
                    console.error('Erreur lors de l\'analyse:', error);
                    this.showAlert(`Erreur lors de l'analyse: ${error.message}`, 'error');
                }
            }

            calculateStatistics() {
                const total = this.responses.length;
                
                // Sant√© physique moyenne
                const avgSantePhysique = this.responses
                    .filter(r => r.sante_physique)
                    .reduce((sum, r) => sum + parseInt(r.sante_physique), 0) / 
                    this.responses.filter(r => r.sante_physique).length || 0;

                // Sant√© psychologique moyenne
                const avgSantePsycho = this.responses
                    .filter(r => r.sante_psychologique)
                    .reduce((sum, r) => sum + parseInt(r.sante_psychologique), 0) / 
                    this.responses.filter(r => r.sante_psychologique).length || 0;

                // Niveau de stress
                const stressedResponses = this.responses.filter(r => 
                    r.sources_stress && r.sources_stress.length > 0 && 
                    !r.sources_stress.includes('pas_stresse')
                ).length;
                const stressLevel = (stressedResponses / total) * 100;

                // Mise √† jour de l'interface
                document.getElementById('totalResponses').textContent = total;
                document.getElementById('avgSantePhysique').textContent = avgSantePhysique.toFixed(1);
                document.getElementById('avgSantePsycho').textContent = avgSantePsycho.toFixed(1);
                document.getElementById('stressLevel').textContent = Math.round(stressLevel) + '%';
            }

            createCharts() {
                this.createProfileChart();
                this.createAgeChart();
                this.createHealthChart();
                this.createQvtChart();
                this.createStressChart();
                this.createTeletravailChart();
            }

            createProfileChart() {
                const ctx = document.getElementById('profileChart').getContext('2d');
                const profileCounts = {};
                
                this.responses.forEach(r => {
                    if (r.profil) {
                        profileCounts[r.profil] = (profileCounts[r.profil] || 0) + 1;
                    }
                });

                const profileLabels = {
                    'auditeur': 'Auditeur/Auditrice',
                    'chef_mission': 'Chef de mission',
                    'directeur_mission': 'Directeur de mission'
                };

                if (this.charts.profile) this.charts.profile.destroy();
                this.charts.profile = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(profileCounts).map(k => profileLabels[k] || k),
                        datasets: [{
                            data: Object.values(profileCounts),
                            backgroundColor: ['#667eea', '#764ba2', '#48bb78', '#ed8936']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            createAgeChart() {
                const ctx = document.getElementById('ageChart').getContext('2d');
                const ageCounts = {};
                
                this.responses.forEach(r => {
                    if (r.age) {
                        ageCounts[r.age] = (ageCounts[r.age] || 0) + 1;
                    }
                });

                const ageLabels = {
                    'moins_25': 'Moins de 25 ans',
                    '25_30': '25-30 ans',
                    '30_40': '30-40 ans',
                    '40_50': '40-50 ans',
                    '50_60': '50-60 ans',
                    'plus_60': 'Plus de 60 ans'
                };

                if (this.charts.age) this.charts.age.destroy();
                this.charts.age = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(ageCounts).map(k => ageLabels[k] || k),
                        datasets: [{
                            label: 'Nombre de r√©pondants',
                            data: Object.values(ageCounts),
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            createHealthChart() {
                const ctx = document.getElementById('healthChart').getContext('2d');
                
                const avgSantePhysique = this.responses
                    .filter(r => r.sante_physique)
                    .reduce((sum, r) => sum + parseInt(r.sante_physique), 0) / 
                    this.responses.filter(r => r.sante_physique).length || 0;

                const avgSantePsycho = this.responses
                    .filter(r => r.sante_psychologique)
                    .reduce((sum, r) => sum + parseInt(r.sante_psychologique), 0) / 
                    this.responses.filter(r => r.sante_psychologique).length || 0;

                if (this.charts.health) this.charts.health.destroy();
                this.charts.health = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Sant√© Physique', 'Sant√© Psychologique'],
                        datasets: [{
                            label: 'Note moyenne (/10)',
                            data: [avgSantePhysique, avgSantePsycho],
                            backgroundColor: ['#48bb78', '#667eea']
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                });
            }

            createQvtChart() {
                const ctx = document.getElementById('qvtChart').getContext('2d');
                const qvtCounts = {};
                
                this.responses.forEach(r => {
                    if (r.qvt) {
                        qvtCounts[r.qvt] = (qvtCounts[r.qvt] || 0) + 1;
                    }
                });

                const qvtLabels = {
                    'excellente': 'Excellente',
                    'bonne': 'Bonne',
                    'correcte': 'Correcte',
                    'decevante': 'D√©cevante',
                    'nocive': 'Nocive'
                };

                if (this.charts.qvt) this.charts.qvt.destroy();
                this.charts.qvt = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(qvtCounts).map(k => qvtLabels[k] || k),
                        datasets: [{
                            data: Object.values(qvtCounts),
                            backgroundColor: ['#48bb78', '#68d391', '#fbb040', '#f56565', '#e53e3e']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            createStressChart() {
                const ctx = document.getElementById('stressChart').getContext('2d');
                const stressCounts = {};
                
                this.responses.forEach(r => {
                    if (r.sources_stress && Array.isArray(r.sources_stress)) {
                        r.sources_stress.forEach(source => {
                            if (source !== 'pas_stresse') {
                                stressCounts[source] = (stressCounts[source] || 0) + 1;
                            }
                        });
                    }
                });

                const stressLabels = {
                    'gestion_clients': 'Gestion clients',
                    'complexite_dossiers': 'Complexit√© dossiers',
                    'tenue_delais': 'Respect d√©lais',
                    'outils_inefficaces': 'Outils inefficaces',
                    'pression_hierarchique': 'Pression hi√©rarchique',
                    'horaires_contraintes': 'Contraintes horaires',
                    'manque_formation': 'Manque formation'
                };

                if (this.charts.stress) this.charts.stress.destroy();
                this.charts.stress = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(stressCounts).map(k => stressLabels[k] || k),
                        datasets: [{
                            label: 'Nombre de mentions',
                            data: Object.values(stressCounts),
                            backgroundColor: '#f56565'
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            createTeletravailChart() {
                const ctx = document.getElementById('teletravailChart').getContext('2d');
                const teletravailCounts = {};
                
                this.responses.forEach(r => {
                    if (r.rythme_teletravail) {
                        teletravailCounts[r.rythme_teletravail] = (teletravailCounts[r.rythme_teletravail] || 0) + 1;
                    }
                });

                const teletravailLabels = {
                    'jamais_cabinet_interdit': 'Jamais (interdit)',
                    'jamais_choix': 'Jamais (choix)',
                    '1j_semaine': '1 jour/semaine',
                    '2j_semaine': '2 jours/semaine',
                    'plus_2j_semaine': '+ 2 jours/semaine',
                    '100_pourcent': '100% t√©l√©travail'
                };

                if (this.charts.teletravail) this.charts.teletravail.destroy();
                this.charts.teletravail = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(teletravailCounts).map(k => teletravailLabels[k] || k),
                        datasets: [{
                            data: Object.values(teletravailCounts),
                            backgroundColor: ['#e53e3e', '#f56565', '#fbb040', '#68d391', '#48bb78', '#667eea']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            exportToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuration
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                let yPosition = 30;

                // En-t√™te
                doc.setFontSize(20);
                doc.text('BAROMETRE SANTE 2025', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 10;
                
                doc.setFontSize(14);
                doc.text('Cabinet Saint Germain Audit', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;
                
                doc.setFontSize(10);
                doc.text(`Rapport g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`, 
                         pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 20;

                // Statistiques g√©n√©rales
                doc.setFontSize(16);
                doc.text('STATISTIQUES GENERALES', margin, yPosition);
                yPosition += 10;

                doc.setFontSize(12);
                const totalResponses = this.responses.length;
                const avgSantePhysique = this.responses
                    .filter(r => r.sante_physique)
                    .reduce((sum, r) => sum + parseInt(r.sante_physique), 0) / 
                    this.responses.filter(r => r.sante_physique).length || 0;
                const avgSantePsycho = this.responses
                    .filter(r => r.sante_psychologique)
                    .reduce((sum, r) => sum + parseInt(r.sante_psychologique), 0) / 
                    this.responses.filter(r => r.sante_psychologique).length || 0;

                const stats = [
                    `‚Ä¢ Nombre de r√©pondants : ${totalResponses}`,
                    `‚Ä¢ Sant√© physique moyenne : ${avgSantePhysique.toFixed(1)}/10`,
                    `‚Ä¢ Sant√© psychologique moyenne : ${avgSantePsycho.toFixed(1)}/10`,
                    `‚Ä¢ P√©riode d'analyse : ${new Date().getFullYear()}`
                ];

                stats.forEach(stat => {
                    doc.text(stat, margin, yPosition);
                    yPosition += 8;
                });

                yPosition += 10;

                // R√©partition par profil
                doc.setFontSize(14);
                doc.text('REPARTITION PAR PROFIL', margin, yPosition);
                yPosition += 8;

                const profileCounts = {};
                this.responses.forEach(r => {
                    if (r.profil) {
                        profileCounts[r.profil] = (profileCounts[r.profil] || 0) + 1;
                    }
                });

                const profileLabels = {
                    'auditeur': 'Auditeur/Auditrice',
                    'chef_mission': 'Chef de mission',
                    'directeur_mission': 'Directeur de mission'
                };

                doc.setFontSize(10);
                Object.entries(profileCounts).forEach(([key, count]) => {
                    const percentage = ((count / totalResponses) * 100).toFixed(1);
                    doc.text(`‚Ä¢ ${profileLabels[key] || key} : ${count} (${percentage}%)`, margin, yPosition);
                    yPosition += 6;
                });

                yPosition += 10;

                // Qualit√© de vie au travail
                doc.setFontSize(14);
                doc.text('QUALITE DE VIE AU TRAVAIL', margin, yPosition);
                yPosition += 8;

                const qvtCounts = {};
                this.responses.forEach(r => {
                    if (r.qvt) {
                        qvtCounts[r.qvt] = (qvtCounts[r.qvt] || 0) + 1;
                    }
                });

                const qvtLabels = {
                    'excellente': 'Excellente',
                    'bonne': 'Bonne',
                    'correcte': 'Correcte',
                    'decevante': 'D√©cevante',
                    'nocive': 'Nocive'
                };

                doc.setFontSize(10);
                Object.entries(qvtCounts).forEach(([key, count]) => {
                    const percentage = ((count / totalResponses) * 100).toFixed(1);
                    doc.text(`‚Ä¢ ${qvtLabels[key] || key} : ${count} (${percentage}%)`, margin, yPosition);
                    yPosition += 6;
                });

                yPosition += 10;

                // Sources de stress
                doc.setFontSize(14);
                doc.text('PRINCIPALES SOURCES DE STRESS', margin, yPosition);
                yPosition += 8;

                const stressCounts = {};
                this.responses.forEach(r => {
                    if (r.sources_stress && Array.isArray(r.sources_stress)) {
                        r.sources_stress.forEach(source => {
                            if (source !== 'pas_stresse') {
                                stressCounts[source] = (stressCounts[source] || 0) + 1;
                            }
                        });
                    }
                });

                const stressLabels = {
                    'gestion_clients': 'Gestion des clients',
                    'complexite_dossiers': 'Complexit√© des dossiers',
                    'tenue_delais': 'Respect des d√©lais',
                    'outils_inefficaces': 'Outils inefficaces',
                    'pression_hierarchique': 'Pression hi√©rarchique',
                    'horaires_contraintes': 'Contraintes horaires',
                    'manque_formation': 'Manque de formation'
                };

                // Trier par nombre d√©croissant
                const sortedStress = Object.entries(stressCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5); // Top 5

                doc.setFontSize(10);
                sortedStress.forEach(([key, count]) => {
                    const percentage = ((count / totalResponses) * 100).toFixed(1);
                    doc.text(`‚Ä¢ ${stressLabels[key] || key} : ${count} mentions (${percentage}%)`, margin, yPosition);
                    yPosition += 6;
                });

                // Nouvelle page si n√©cessaire
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 30;
                }

                yPosition += 10;

                // T√©l√©travail
                doc.setFontSize(14);
                doc.text('REPARTITION DU TELETRAVAIL', margin, yPosition);
                yPosition += 8;

                const teletravailCounts = {};
                this.responses.forEach(r => {
                    if (r.rythme_teletravail) {
                        teletravailCounts[r.rythme_teletravail] = (teletravailCounts[r.rythme_teletravail] || 0) + 1;
                    }
                });

                const teletravailLabels = {
                    'jamais_cabinet_interdit': 'Jamais (cabinet ne le permet pas)',
                    'jamais_choix': 'Jamais (choix personnel)',
                    '1j_semaine': '1 jour par semaine',
                    '2j_semaine': '2 jours par semaine',
                    'plus_2j_semaine': 'Plus de 2 jours par semaine',
                    '100_pourcent': '100% en t√©l√©travail'
                };

                doc.setFontSize(10);
                Object.entries(teletravailCounts).forEach(([key, count]) => {
                    const percentage = ((count / totalResponses) * 100).toFixed(1);
                    doc.text(`‚Ä¢ ${teletravailLabels[key] || key} : ${count} (${percentage}%)`, margin, yPosition);
                    yPosition += 6;
                });

                yPosition += 15;

                // Recommandations
                doc.setFontSize(14);
                doc.text('RECOMMANDATIONS', margin, yPosition);
                yPosition += 8;

                doc.setFontSize(10);
                const recommendations = this.generateRecommendations();
                recommendations.forEach(rec => {
                    const lines = doc.splitTextToSize(`‚Ä¢ ${rec}`, pageWidth - 2 * margin);
                    lines.forEach(line => {
                        if (yPosition > 280) {
                            doc.addPage();
                            yPosition = 30;
                        }
                        doc.text(line, margin, yPosition);
                        yPosition += 6;
                    });
                    yPosition += 3;
                });

                // Pied de page
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`Page ${i} sur ${pageCount}`, pageWidth - margin, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
                }

                // Sauvegarde
                const fileName = `Barometre_Sante_2025_Synthese_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(fileName);

                this.showAlert(`Rapport PDF g√©n√©r√© : ${fileName}`, 'success');
            }

            generateRecommendations() {
                const recommendations = [];
                const totalResponses = this.responses.length;

                // Analyse de la sant√©
                const avgSantePhysique = this.responses
                    .filter(r => r.sante_physique)
                    .reduce((sum, r) => sum + parseInt(r.sante_physique), 0) / 
                    this.responses.filter(r => r.sante_physique).length || 0;

                const avgSantePsycho = this.responses
                    .filter(r => r.sante_psychologique)
                    .reduce((sum, r) => sum + parseInt(r.sante_psychologique), 0) / 
                    this.responses.filter(r => r.sante_psychologique).length || 0;

                if (avgSantePhysique < 6) {
                    recommendations.push('Mettre en place des actions de pr√©vention sant√© physique : am√©nagement ergonomique des postes, formation aux gestes et postures.');
                }

                if (avgSantePsycho < 6) {
                    recommendations.push('Organiser des s√©ances de gestion du stress et proposer un accompagnement psychologique si n√©cessaire.');
                }

                // Analyse du stress
                const stressCounts = {};
                this.responses.forEach(r => {
                    if (r.sources_stress && Array.isArray(r.sources_stress)) {
                        r.sources_stress.forEach(source => {
                            if (source !== 'pas_stresse') {
                                stressCounts[source] = (stressCounts[source] || 0) + 1;
                            }
                        });
                    }
                });

                const topStressSource = Object.entries(stressCounts).sort(([,a], [,b]) => b - a)[0];
                if (topStressSource && topStressSource[1] > totalResponses * 0.3) {
                    switch (topStressSource[0]) {
                        case 'tenue_delais':
                            recommendations.push('Revoir la planification des missions et l\'allocation des ressources pour r√©duire la pression li√©e aux d√©lais.');
                            break;
                        case 'gestion_clients':
                            recommendations.push('Proposer des formations en gestion de la relation client et techniques de communication.');
                            break;
                        case 'outils_inefficaces':
                            recommendations.push('√âvaluer et moderniser les outils de travail pour am√©liorer l\'efficacit√© op√©rationnelle.');
                            break;
                    }
                }

                // Analyse QVT
                const qvtNegative = this.responses.filter(r => 
                    r.qvt && (r.qvt === 'decevante' || r.qvt === 'nocive')
                ).length;

                if (qvtNegative > totalResponses * 0.2) {
                    recommendations.push('Conduire un audit approfondi de la qualit√© de vie au travail et mettre en place un plan d\'action sp√©cifique.');
                }

                // T√©l√©travail
                const noTeletravail = this.responses.filter(r => 
                    r.rythme_teletravail && r.rythme_teletravail === 'jamais_cabinet_interdit'
                ).length;

                if (noTeletravail > totalResponses * 0.3) {
                    recommendations.push('√âtudier la faisabilit√© d\'une politique de t√©l√©travail pour am√©liorer l\'√©quilibre vie professionnelle/personnelle.');
                }

                if (recommendations.length === 0) {
                    recommendations.push('Les r√©sultats montrent une situation globalement positive. Maintenir les bonnes pratiques actuelles.');
                }

                return recommendations;
            }

            clearAll() {
                this.responses = [];
                document.getElementById('fileList').style.display = 'none';
                document.getElementById('fileListContent').innerHTML = '';
                document.getElementById('analyzeBtn').disabled = true;
                document.getElementById('analysisSection').style.display = 'none';
                document.getElementById('fileInput').value = '';
                document.getElementById('alerts').innerHTML = '';
                
                // D√©truire les graphiques
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};

                this.showAlert('Toutes les donn√©es ont √©t√© effac√©es', 'info');
            }

            showAlert(message, type) {
                const alertsContainer = document.getElementById('alerts');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.textContent = message;
                
                alertsContainer.appendChild(alert);
                
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            new HealthSurveyAnalyzer();
        });
    </script>
</body>
</html>
