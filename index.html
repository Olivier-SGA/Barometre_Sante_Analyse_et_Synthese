<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barom√®tre Sant√© 2025 - Analyse des R√©sultats</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6; color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      text-align: center; background: rgba(255, 255, 255, 0.95);
      border-radius: 20px; padding: 30px; margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .header h1 { color: #2d3748; font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
    .header h2 { color: #667eea; font-size: 1.3rem; margin-bottom: 20px; font-weight: 500; }
    .upload-section, .analysis-section {
      background: rgba(255, 255, 255, 0.95); border-radius: 20px;
      padding: 30px; margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .upload-zone {
      border: 3px dashed #667eea; border-radius: 15px; padding: 40px;
      text-align: center; background: #f8f9ff; transition: all 0.3s ease;
      cursor: pointer;
    }
    .upload-zone:hover { border-color: #764ba2; background: #f0f4ff; }
    .upload-zone.dragover { border-color: #764ba2; background: #e6f3ff; transform: scale(1.02); }
    .upload-icon { font-size: 3rem; color: #667eea; margin-bottom: 15px; }
    .upload-text { font-size: 1.2rem; color: #4a5568; margin-bottom: 15px; }
    .upload-subtext { color: #666; font-size: 0.9rem; }
    .file-input { display: none; }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; padding: 12px 25px;
      font-size: 1rem; font-weight: 600;
      border-radius: 10px; cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin: 10px 5px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102,126,234,0.3); }
    .file-list { margin-top: 20px; background: white; border-radius: 10px; padding: 20px; }
    .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
    .file-item:last-child { border-bottom: none; }
    .file-info { display: flex; align-items: center; gap: 10px; }
    .file-icon { color: #667eea; font-size: 1.2rem; }
    .remove-file { background: #e53e3e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
    .analysis-section { display: none; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card {
      background: #f8f9ff; padding: 20px; border-radius: 10px;
      border-left: 5px solid #667eea; text-align: center;
    }
    .stat-number { font-size: 2rem; font-weight: bold; color: #667eea; margin-bottom: 5px; }
    .stat-label { color: #666; font-size: 0.9rem; }
    .chart-container { margin: 30px 0; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .chart-title { font-size: 1.2rem; font-weight: 600; color: #2d3748; margin-bottom: 15px; text-align: center; }
    .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .alert-error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .alert-info { background: #cce7ff; border: 1px solid #b3d9ff; color: #004085; }
    @media (max-width: 768px) {
      .container { padding: 10px; }
      .header h1 { font-size: 2rem; }
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Analyse des R√©sultats</h1>
      <h2>Barom√®tre Sant√© 2025 - Cabinet Saint Germain Audit</h2>
      <p>Importez les fichiers JSON des r√©ponses pour g√©n√©rer une synth√®se compl√®te</p>
    </div>

    <div class="upload-section">
      <div class="upload-zone" id="uploadZone">
        <div class="upload-icon">üìÅ</div>
        <div class="upload-text">Cliquez pour s√©lectionner ou glissez-d√©posez les fichiers JSON</div>
        <div class="upload-subtext">S√©lectionnez tous les fichiers de r√©ponses (.json) du barom√®tre sant√©</div>
        <input type="file" id="fileInput" class="file-input" multiple accept=".json">
      </div>

      <div id="fileList" class="file-list" style="display: none;">
        <h3>Fichiers s√©lectionn√©s :</h3>
        <div id="fileListContent"></div>
      </div>

      <div id="alerts"></div>
    </div>

    <div class="analysis-section" id="analysisSection">
      <h2>Synth√®se des R√©sultats</h2>
      
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-number" id="totalResponses">0</div><div class="stat-label">R√©ponses collect√©es</div></div>
        <div class="stat-card"><div class="stat-number" id="avgSantePhysique">0</div><div class="stat-label">Sant√© physique moyenne (/10)</div></div>
        <div class="stat-card"><div class="stat-number" id="avgSantePsycho">0</div><div class="stat-label">Sant√© psychologique moyenne (/10)</div></div>
        <div class="stat-card"><div class="stat-number" id="stressLevel">0%</div><div class="stat-label">Collaborateurs stress√©s</div></div>
      </div>

      <div class="chart-container" id="satisfactionContainer">
        <div class="chart-title">Notes Moyennes de Satisfaction (/10)</div>
        <div id="satisfactionCharts"></div>
      </div>

      <div class="chart-container"><div class="chart-title">R√©partition par Profil Professionnel</div><canvas id="profileChart"></canvas></div>
      <div class="chart-container"><div class="chart-title">R√©partition par Tranche d'√Çge</div><canvas id="ageChart"></canvas></div>
      <div class="chart-container"><div class="chart-title">√âvaluation de la Sant√© (Notes moyennes)</div><canvas id="healthChart"></canvas></div>
      <div class="chart-container"><div class="chart-title">Qualit√© de Vie au Travail</div><canvas id="qvtChart"></canvas></div>
      <div class="chart-container"><div class="chart-title">Sources de Stress Principales</div><canvas id="stressChart"></canvas></div>
      <div class="chart-container"><div class="chart-title">R√©partition du T√©l√©travail</div><canvas id="teletravailChart"></canvas></div>

      <div style="text-align: center; margin-top: 30px;">
        <button id="exportPdfBtn" class="btn">üìÑ G√©n√©rer le rapport PDF</button>
      </div>
    </div>
  </div>

  <script>
    // === CLASSE ANALYSEUR ===
    function HealthSurveyAnalyzer() {
      this.responses = [];
      this.charts = {};
      this.calculatedStats = {};
      this.init();
    }

    HealthSurveyAnalyzer.prototype.init = function() {
      this.setupEventListeners();
    };

    HealthSurveyAnalyzer.prototype.setupEventListeners = function() {
      var self = this;
      var uploadZone = document.getElementById('uploadZone');
      var fileInput = document.getElementById('fileInput');
      var exportPdfBtn = document.getElementById('exportPdfBtn');

      uploadZone.addEventListener('click', function() { fileInput.click(); });
      uploadZone.addEventListener('dragover', function(e) { e.preventDefault(); uploadZone.classList.add('dragover'); });
      uploadZone.addEventListener('dragleave', function() { uploadZone.classList.remove('dragover'); });
      uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        self.handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', function(e) {
        self.handleFiles(e.target.files);
      });

      exportPdfBtn.addEventListener('click', function() { self.exportToPDF(); });
    };

    HealthSurveyAnalyzer.prototype.handleFiles = function(files) {
      var jsonFiles = [];
      for (var i = 0; i < files.length; i++) {
        if (files[i].name.endsWith('.json')) jsonFiles.push(files[i]);
      }

      if (jsonFiles.length === 0) {
        this.showAlert('Aucun fichier JSON valide s√©lectionn√©', 'error');
        return;
      }

      document.getElementById('fileInput').value = ''; // reset input
      this.loadJsonFiles(jsonFiles);
    };

    HealthSurveyAnalyzer.prototype.loadJsonFiles = function(files) {
      var self = this;
      var fileList = document.getElementById('fileList');
      var fileListContent = document.getElementById('fileListContent');

      fileListContent.innerHTML = '';
      this.responses = [];

      var promises = [];
      for (var i = 0; i < files.length; i++) {
        promises.push(this.readFile(files[i]));
      }

      Promise.all(promises).then(function(results) {
        for (var i = 0; i < results.length; i++) {
          try {
            var data = JSON.parse(results[i]);
            if (self.validateResponseData(data)) {
              self.responses.push(data);
              self.addFileToList(files[i].name, fileListContent);
            } else {
              self.showAlert('Fichier ' + files[i].name + ' : format non valide', 'error');
            }
          } catch (error) {
            self.showAlert('Erreur lecture ' + files[i].name + ' : ' + error.message, 'error');
          }
        }

        if (self.responses.length > 0) {
          fileList.style.display = 'block';
          self.analyzeData(); // üî• Analyse directe apr√®s import
        } else {
          self.showAlert('Aucune donn√©e exploitable', 'error');
        }
      });
    };

    HealthSurveyAnalyzer.prototype.readFile = function(file) {
      return new Promise(function(resolve, reject) {
        var reader = new FileReader();
        reader.onload = function(e) { resolve(e.target.result); };
        reader.onerror = function() { reject(new Error('Erreur de lecture du fichier')); };
        reader.readAsText(file);
      });
    };

    // === Exemple : recalcul, stats, PDF, etc. ===
    // (tu gardes ton code existant pour calculateStatistics, calculateSatisfactionScores, createProfileChart, createAgeChart, createHealthChart, createQvtChart, createStressChart, createTeletravailChart, exportToPDF...)

    // === NOUVELLE FONCTION : un graphique par question ===
    HealthSurveyAnalyzer.prototype.createSatisfactionCharts = function() {
      var container = document.getElementById('satisfactionCharts');
      container.innerHTML = '';

      var scores = this.calculatedStats.satisfactionScores;

      var labels = {
        'gestion_pression': 'Gestion de la pression',
        'climat_social': 'Climat social',
        'qvt': 'Qualit√© de vie au travail',
        'qualite_sommeil': 'Qualit√© du sommeil',
        'charge_travail': 'Charge de travail raisonnable',
        'sommeil_suffisant': 'Temps de sommeil suffisant',
        'alimentation_saine': 'Alimentation saine',
        'offre_restauration': 'Offre de restauration'
      };

      for (var key in scores) {
        if (scores[key] > 0) {
          var chartDiv = document.createElement('div');
          chartDiv.className = "chart-container";
          chartDiv.style.marginBottom = "20px";

          var title = document.createElement('div');
          title.className = "chart-title";
          title.textContent = labels[key] || key;

          var canvas = document.createElement('canvas');
          chartDiv.appendChild(title);
          chartDiv.appendChild(canvas);
          container.appendChild(chartDiv);

          var color = scores[key] >= 8 ? '#48bb78' : (scores[key] >= 6 ? '#ed8936' : '#f56565');

          new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
              labels: [labels[key] || key],
              datasets: [{
                label: 'Note moyenne (/10)',
                data: [scores[key]],
                backgroundColor: [color]
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, max: 10, ticks: { stepSize: 1 } }
              },
              plugins: { legend: { display: false } }
            }
          });
        }
      }
    };

    // === Initialisation ===
    document.addEventListener('DOMContentLoaded', function() {
      new HealthSurveyAnalyzer();
    });
  </script>
</body>
</html>
