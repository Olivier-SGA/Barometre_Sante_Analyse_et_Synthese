<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidation Baromètre Santé 2025</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .file-input-wrapper {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            margin: 10px;
        }

        .file-count {
            margin-top: 20px;
            font-weight: bold;
            color: #27ae60;
        }

        .results-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px;
        }

        .btn-primary {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #27ae60;
            color: white;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .detailed-results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .chart-container {
            margin-bottom: 40px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
        }

        .chart-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .status-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .status-item {
            margin: 5px 0;
            font-size: 14px;
        }

        .chart-status {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 0.9rem;
        }

        .test-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
        }

        .test-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Consolidation Baromètre Santé 2025</h1>
            <p>Interface d'analyse et de génération de rapports</p>
        </div>

        <div class="upload-section">
            <h2>Import des fichiers JSON</h2>
            <div class="file-input-wrapper" id="dropZone">
                <p><strong>Cliquez ici pour sélectionner vos fichiers JSON</strong></p>
                <input type="file" id="fileInput" class="file-input" multiple accept=".json">
                <button class="upload-btn" id="selectButton">Choisir les fichiers</button>
            </div>
            <div id="fileCount" class="file-count"></div>
        </div>

        <div class="test-section">
            <h4>Tests de fonctionnement :</h4>
            <button class="test-btn" id="testCanvas">Tester Canvas</button>
            <button class="test-btn" id="testData">Générer données test</button>
            <button class="test-btn" id="showResults">Afficher résultats</button>
            <div id="testResults" style="margin-top: 10px; font-size: 12px;"></div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="loading" id="loading">
            <p>Traitement des données en cours...</p>
        </div>

        <div class="results-section" id="resultsSection">
            <h2>Résultats de l'analyse</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" id="pdfButton">Générer rapport PDF</button>
                <button class="btn btn-secondary" onclick="window.print()">Imprimer</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalResponses">0</span>
                    <span>Réponses analysées</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="avgPhysicalHealth">-</span>
                    <span>Santé physique moyenne</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="avgPsychHealth">-</span>
                    <span>Santé psychologique moyenne</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stressPercentage">-</span>
                    <span>Avec charge de travail élevée</span>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Répartition par profil professionnel</div>
                <div class="chart-wrapper">
                    <canvas id="profilChart" width="400" height="400"></canvas>
                </div>
                <div class="chart-status" id="profilChart-status">En attente de données...</div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Répartition par tranche d'âge</div>
                <div class="chart-wrapper">
                    <canvas id="ageChart" width="400" height="400"></canvas>
                </div>
                <div class="chart-status" id="ageChart-status">En attente de données...</div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Scores de santé moyens</div>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="healthChart" width="400" height="300"></canvas>
                </div>
                <div class="chart-status" id="healthChart-status">En attente de données...</div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Sources de stress principales</div>
                <div class="chart-wrapper">
                    <canvas id="stressChart" width="400" height="400"></canvas>
                </div>
                <div class="chart-status" id="stressChart-status">En attente de données...</div>
            </div>

            <div class="detailed-results" id="detailedResults">
                <!-- Résultats détaillés -->
            </div>
        </div>

        <div class="status-section">
            <h4>Statut du système :</h4>
            <div id="system-status">
                <div class="status-item">Application : <span id="app-status">Initialisation...</span></div>
                <div class="status-item">Canvas : <span id="canvas-status">Test...</span></div>
                <div class="status-item">Données : <span id="data-status">Aucune donnée importée</span></div>
                <div class="status-item">Graphiques : <span id="charts-status">En attente</span></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        var analysisData = {
            responses: [],
            summary: {},
            charts: {}
        };

        var isDebugMode = true;

        // Fonction de log avec debug
        function debugLog(message) {
            if (console && console.log) {
                console.log('[DEBUG] ' + message);
            }
            
            // Affichage dans l'interface aussi
            var testResults = document.getElementById('testResults');
            if (testResults && isDebugMode) {
                testResults.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
            }
        }

        // Fonction de mise à jour des statuts
        function updateStatus(elementId, message) {
            try {
                var element = document.getElementById(elementId);
                if (element) {
                    element.innerHTML = message;
                    debugLog('Status updated - ' + elementId + ': ' + message);
                } else {
                    debugLog('Element not found: ' + elementId);
                }
            } catch (error) {
                debugLog('Erreur updateStatus: ' + error.toString());
            }
        }

        // Test du Canvas
        function testCanvas() {
            debugLog('Test du Canvas en cours...');
            
            try {
                var canvas = document.getElementById('profilChart');
                if (!canvas) {
                    debugLog('ERREUR: Canvas profilChart introuvable');
                    return false;
                }
                
                debugLog('Canvas trouvé: ' + canvas.tagName + ', size: ' + canvas.width + 'x' + canvas.height);
                
                var ctx = canvas.getContext('2d');
                if (!ctx) {
                    debugLog('ERREUR: Contexte 2D non disponible');
                    return false;
                }
                
                debugLog('Contexte 2D obtenu avec succès');
                
                // Test de dessin simple
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Fond
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Cercle test
                ctx.beginPath();
                ctx.arc(200, 200, 80, 0, 2 * Math.PI);
                ctx.fillStyle = '#3498db';
                ctx.fill();
                ctx.strokeStyle = '#2980b9';
                ctx.lineWidth = 4;
                ctx.stroke();
                
                // Texte
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('TEST CANVAS OK!', 200, 320);
                
                updateStatus('canvas-status', 'Test réussi ✓');
                updateStatus('profilChart-status', 'Canvas fonctionnel ✓');
                
                debugLog('Test Canvas terminé avec succès');
                return true;
                
            } catch (error) {
                debugLog('ERREUR Test Canvas: ' + error.toString());
                updateStatus('canvas-status', 'Erreur: ' + error.message);
                return false;
            }
        }

        // Génération de données de test
        function generateTestData() {
            debugLog('Génération de données de test...');
            
            var testResponses = [
                {
                    id: 'test1',
                    profil: 'Médecin',
                    age: '30-40',
                    sante_physique: '7',
                    sante_psychologique: '6',
                    charge_travail: 'non',
                    sources_stress: ['Charge de travail excessive', 'Manque de temps']
                },
                {
                    id: 'test2',
                    profil: 'Infirmier',
                    age: '25-35',
                    sante_physique: '6',
                    sante_psychologique: '5',
                    charge_travail: 'non',
                    sources_stress: ['Relations interpersonnelles', 'Horaires irréguliers']
                },
                {
                    id: 'test3',
                    profil: 'Administratif',
                    age: '40-50',
                    sante_physique: '8',
                    sante_psychologique: '7',
                    charge_travail: 'oui',
                    sources_stress: ['Stress organisationnel']
                }
            ];
            
            analysisData.responses = testResponses;
            
            debugLog('Données test générées: ' + testResponses.length + ' réponses');
            updateStatus('data-status', 'Données test générées ✓');
            
            // Analyse immédiate
            analyzeData();
            displayResults();
            
            return true;
        }

        // Analyse des données (version corrigée)
        function analyzeData() {
            debugLog('Début analyse des données...');
            
            try {
                var responses = analysisData.responses;
                if (!responses || responses.length === 0) {
                    debugLog('ERREUR: Aucune donnée à analyser');
                    return;
                }
                
                var summary = {};
                summary.total = responses.length;
                summary.dateAnalyse = new Date().toLocaleDateString('fr-FR');
                
                debugLog('Analyse de ' + summary.total + ' réponses');
                
                // Calcul moyennes santé
                var physicalScores = [];
                var psychScores = [];
                
                for (var i = 0; i < responses.length; i++) {
                    var r = responses[i];
                    
                    var physical = parseFloat(r.sante_physique);
                    if (!isNaN(physical) && physical > 0 && physical <= 10) {
                        physicalScores.push(physical);
                    }
                    
                    var psych = parseFloat(r.sante_psychologique);
                    if (!isNaN(psych) && psych > 0 && psych <= 10) {
                        psychScores.push(psych);
                    }
                }

                // Moyennes
                if (physicalScores.length > 0) {
                    var sum = physicalScores.reduce(function(a, b) { return a + b; }, 0);
                    summary.avgPhysical = (sum / physicalScores.length).toFixed(1);
                } else {
                    summary.avgPhysical = 'N/A';
                }

                if (psychScores.length > 0) {
                    var sum = psychScores.reduce(function(a, b) { return a + b; }, 0);
                    summary.avgPsych = (sum / psychScores.length).toFixed(1);
                } else {
                    summary.avgPsych = 'N/A';
                }

                // Charge de travail
                var workloadIssues = 0;
                for (var i = 0; i < responses.length; i++) {
                    if (responses[i].charge_travail === 'non') {
                        workloadIssues++;
                    }
                }
                summary.workloadPercentage = ((workloadIssues / responses.length) * 100).toFixed(0);

                // Analyses par catégories
                summary.profils = analyzeField(responses, 'profil');
                summary.ages = analyzeField(responses, 'age');
                summary.stressSources = analyzeMultipleChoiceField(responses, 'sources_stress');

                analysisData.summary = summary;
                
                debugLog('Analyse terminée - Profils: ' + Object.keys(summary.profils).length + 
                        ', Ages: ' + Object.keys(summary.ages).length + 
                        ', Sources stress: ' + Object.keys(summary.stressSources).length);
                
            } catch (error) {
                debugLog('ERREUR analyzeData: ' + error.toString());
            }
        }

        // Analyse d'un champ simple
        function analyzeField(responses, fieldName) {
            var counts = {};
            for (var i = 0; i < responses.length; i++) {
                var value = responses[i][fieldName] || 'Non renseigné';
                counts[value] = (counts[value] || 0) + 1;
            }
            return counts;
        }

        // Analyse d'un champ à choix multiples
        function analyzeMultipleChoiceField(responses, fieldName) {
            var counts = {};
            for (var i = 0; i < responses.length; i++) {
                var values = responses[i][fieldName];
                if (Array.isArray(values)) {
                    for (var j = 0; j < values.length; j++) {
                        var value = values[j];
                        if (value) {
                            counts[value] = (counts[value] || 0) + 1;
                        }
                    }
                }
            }
            return counts;
        }

        // Affichage des résultats
        function displayResults() {
            debugLog('Affichage des résultats...');
            
            try {
                var summary = analysisData.summary;
                if (!summary) {
                    debugLog('ERREUR: Pas de summary disponible');
                    return;
                }
                
                // Mise à jour des statistiques
                updateElementText('totalResponses', summary.total);
                updateElementText('avgPhysicalHealth', summary.avgPhysical);
                updateElementText('avgPsychHealth', summary.avgPsych);
                updateElementText('stressPercentage', summary.workloadPercentage + '%');

                // Affichage des résultats détaillés
                displayDetailedResults();

                // Création des graphiques
                createAllCharts();

                // Affichage de la section résultats
                var resultsSection = document.getElementById('resultsSection');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                    debugLog('Section résultats affichée');
                } else {
                    debugLog('ERREUR: Section résultats introuvable');
                }
                
            } catch (error) {
                debugLog('ERREUR displayResults: ' + error.toString());
            }
        }

        // Fonction utilitaire pour mettre à jour le texte
        function updateElementText(elementId, value) {
            var element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                debugLog('Mis à jour ' + elementId + ': ' + value);
            } else {
                debugLog('ERREUR: Element ' + elementId + ' introuvable');
            }
        }

        // Affichage des résultats détaillés
        function displayDetailedResults() {
            try {
                var summary = analysisData.summary;
                var container = document.getElementById('detailedResults');
                
                if (!container) {
                    debugLog('ERREUR: Container détaillé introuvable');
                    return;
                }
                
                var html = '<h3>Analyse détaillée</h3>';
                
                // Profils
                if (summary.profils && Object.keys(summary.profils).length > 0) {
                    html += '<h4>Répartition par profil:</h4><ul>';
                    for (var key in summary.profils) {
                        var count = summary.profils[key];
                        var percentage = ((count / summary.total) * 100).toFixed(1);
                        html += '<li>' + key + ': ' + count + ' (' + percentage + '%)</li>';
                    }
                    html += '</ul>';
                }
                
                // Ages
                if (summary.ages && Object.keys(summary.ages).length > 0) {
                    html += '<h4>Répartition par âge:</h4><ul>';
                    for (var key in summary.ages) {
                        var count = summary.ages[key];
                        var percentage = ((count / summary.total) * 100).toFixed(1);
                        html += '<li>' + key + ': ' + count + ' (' + percentage + '%)</li>';
                    }
                    html += '</ul>';
                }
                
                container.innerHTML = html;
                debugLog('Résultats détaillés affichés');
                
            } catch (error) {
                debugLog('ERREUR displayDetailedResults: ' + error.toString());
            }
        }

        // Création de tous les graphiques
        function createAllCharts() {
            debugLog('Création de tous les graphiques...');
            
            try {
                var summary = analysisData.summary;
                if (!summary || !summary.total) {
                    debugLog('ERREUR: Pas de données pour les graphiques');
                    return;
                }
                
                var chartsCreated = 0;
                
                // Graphique profils
                if (summary.profils && Object.keys(summary.profils).length > 0) {
                    if (createNativePieChart('profilChart', summary.profils, 'Profils')) {
                        chartsCreated++;
                        updateStatus('profilChart-status', 'Graphique créé ✓');
                    }
                }
                
                // Graphique âges
                if (summary.ages && Object.keys(summary.ages).length > 0) {
                    if (createNativePieChart('ageChart', summary.ages, 'Âges')) {
                        chartsCreated++;
                        updateStatus('ageChart-status', 'Graphique créé ✓');
                    }
                }
                
                // Graphique santé
                var healthData = {};
                if (summary.avgPhysical !== 'N/A') healthData['Physique'] = parseFloat(summary.avgPhysical);
                if (summary.avgPsych !== 'N/A') healthData['Psychologique'] = parseFloat(summary.avgPsych);
                
                if (Object.keys(healthData).length > 0) {
                    if (createNativeBarChart('healthChart', healthData, 'Santé')) {
                        chartsCreated++;
                        updateStatus('healthChart-status', 'Graphique créé ✓');
                    }
                }
                
                // Graphique stress (top 5)
                if (summary.stressSources && Object.keys(summary.stressSources).length > 0) {
                    var topStress = getTopItems(summary.stressSources, 5);
                    if (createNativePieChart('stressChart', topStress, 'Sources de stress')) {
                        chartsCreated++;
                        updateStatus('stressChart-status', 'Graphique créé ✓');
                    }
                }
                
                updateStatus('charts-status', chartsCreated + ' graphiques créés ✓');
                debugLog('Création graphiques terminée: ' + chartsCreated + ' créés');
                
            } catch (error) {
                debugLog('ERREUR createAllCharts: ' + error.toString());
            }
        }

        // Obtenir les top N items d'un objet
        function getTopItems(data, n) {
            var items = [];
            for (var key in data) {
                items.push({key: key, value: data[key]});
            }
            items.sort(function(a, b) { return b.value - a.value; });
            
            var result = {};
            for (var i = 0; i < Math.min(n, items.length); i++) {
                result[items[i].key] = items[i].value;
            }
            return result;
        }

        // Création d'un graphique en secteurs natif
        function createNativePieChart(canvasId, data, title) {
            debugLog('Création graphique secteurs: ' + canvasId);
            
            try {
                var canvas = document.getElementById(canvasId);
                if (!canvas) {
                    debugLog('ERREUR: Canvas ' + canvasId + ' introuvable');
                    return false;
                }
                
                var ctx = canvas.getContext('2d');
                if (!ctx) {
                    debugLog('ERREUR: Contexte 2D indisponible pour ' + canvasId);
                    return false;
                }
                
                var width = canvas.width;
                var height = canvas.height;
                var centerX = width / 2;
                var centerY = height / 2;
                var radius = Math.min(width, height) / 3;
                
                // Effacer le canvas
                ctx.clearRect(0, 0, width, height);
                
                // Fond
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);
                
                // Calcul du total
                var total = 0;
                for (var key in data) {
                    total += data[key];
                }
                
                if (total === 0) {
                    debugLog('ERREUR: Total = 0 pour ' + canvasId);
                    return false;
                }
                
                // Couleurs
                var colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e', '#e67e22'];
                var colorIndex = 0;
                
                var currentAngle = 0;
                var legendY = 20;
                
                // Dessin des secteurs
                for (var key in data) {
                    var value = data[key];
                    var sliceAngle = (value / total) * 2 * Math.PI;
                    
                    // Secteur
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.closePath();
                    
                    ctx.fillStyle = colors[colorIndex % colors.length];
                    ctx.fill();
                    
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // Légende
                    var percentage = ((value / total) * 100).toFixed(1);
                    var legendText = key + ': ' + percentage + '%';
                    
                    // Rectangle couleur
                    ctx.fillStyle = colors[colorIndex % colors.length];
                    ctx.fillRect(10, legendY, 15, 15);
                    
                    // Texte légende
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText(legendText, 30, legendY + 12);
                    
                    legendY += 20;
                    currentAngle += sliceAngle;
                    colorIndex++;
                }
                
                debugLog('Graphique secteurs créé: ' + canvasId + ' (' + Object.keys(data).length + ' sections)');
                return true;
                
            } catch (error) {
                debugLog('ERREUR createNativePieChart: ' + error.toString());
                return false;
            }
        }

        // Création d'un graphique en barres natif
        function createNativeBarChart(canvasId, data, title) {
            debugLog('Création graphique barres: ' + canvasId);
            
            try {
                var canvas = document.getElementById(canvasId);
                if (!canvas) {
                    debugLog('ERREUR: Canvas ' + canvasId + ' introuvable');
                    return false;
                }
                
                var ctx = canvas.getContext('2d');
                if (!ctx) {
                    debugLog('ERREUR: Contexte 2D indisponible pour ' + canvasId);
                    return false;
                }
                
                var width = canvas.width;
                var height = canvas.height;
                var margin = 60;
                var chartWidth = width - 2 * margin;
                var chartHeight = height - 2 * margin;
                
                // Effacer le canvas
                ctx.clearRect(0, 0, width, height);
                
                // Fond
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);
                
                var keys = Object.keys(data);
                if (keys.length === 0) {
                    debugLog('ERREUR: Pas de données pour ' + canvasId);
                    return false;
                }
                
                // Trouver la valeur max
                var maxValue = 0;
                for (var key in data) {
                    if (data[key] > maxValue) {
                        maxValue = data[key];
                    }
                }
                
                if (maxValue === 0) {
                    debugLog('ERREUR: Valeur max = 0 pour ' + canvasId);
                    return false;
                }
                
                // Paramètres des barres
                var barWidth = chartWidth / keys.length * 0.8;
                var barSpacing = chartWidth / keys.length * 0.2;
                var colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12'];
                
                // Dessiner les axes
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
                
                // Axe Y
                ctx.beginPath();
                ctx.moveTo(margin, margin);
                ctx.lineTo(margin, height - margin);
                ctx.stroke();
                
                // Axe X
                ctx.beginPath();
                ctx.moveTo(margin, height - margin);
                ctx.lineTo(width - margin, height - margin);
                ctx.stroke();
                
                // Dessiner les barres
                for (var i = 0; i < keys.length; i++) {
                    var key = keys[i];
                    var value = data[key];
                    
                    var barHeight = (value / maxValue) * chartHeight;
                    var barX = margin + i * (barWidth + barSpacing) + barSpacing / 2;
                    var barY = height - margin - barHeight;
                    
                    // Barre
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.fillRect(barX, barY, barWidth, barHeight);
                    
                    // Contour
                    ctx.strokeStyle = '#2c3e50';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(barX, barY, barWidth, barHeight);
                    
                    // Label en bas
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(key, barX + barWidth / 2, height - margin + 20);
                    
                    // Valeur au-dessus de la barre
                    ctx.fillText(value.toString(), barX + barWidth / 2, barY - 10);
                }
                
                // Échelle Y
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                for (var i = 0; i <= 5; i++) {
                    var yValue = (maxValue / 5) * i;
                    var yPos = height - margin - (i / 5) * chartHeight;
                    ctx.fillText(yValue.toFixed(1), margin - 10, yPos + 3);
                    
                    // Ligne de grille
                    if (i > 0) {
                        ctx.strokeStyle = '#e0e0e0';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(margin, yPos);
                        ctx.lineTo(width - margin, yPos);
                        ctx.stroke();
                    }
                }
                
                debugLog('Graphique barres créé: ' + canvasId + ' (' + keys.length + ' barres)');
                return true;
                
            } catch (error) {
                debugLog('ERREUR createNativeBarChart: ' + error.toString());
                return false;
            }
        }

        // Gestion des fichiers (version simplifiée pour test)
        function handleFileSelection(files) {
            debugLog('Sélection de ' + files.length + ' fichiers');
            
            try {
                var fileCountDiv = document.getElementById('fileCount');
                if (fileCountDiv) {
                    fileCountDiv.textContent = files.length + ' fichier(s) sélectionné(s)';
                }
                
                var loadingDiv = document.getElementById('loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'block';
                }
                
                // Simulation du traitement
                setTimeout(function() {
                    processFiles(files);
                }, 500);
                
            } catch (error) {
                debugLog('ERREUR handleFileSelection: ' + error.toString());
            }
        }

        // Traitement des fichiers JSON
        function processFiles(files) {
            debugLog('Traitement des fichiers...');
            
            try {
                analysisData.responses = [];
                var validFiles = 0;
                var errors = [];
                var filesProcessed = 0;

                function processNextFile(index) {
                    if (index >= files.length) {
                        finishProcessing(validFiles, errors);
                        return;
                    }

                    var file = files[index];
                    
                    if (!file.name.toLowerCase().endsWith('.json')) {
                        errors.push(file.name + ': Format non supporté');
                        processNextFile(index + 1);
                        return;
                    }

                    var reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            var content = e.target.result;
                            var data = JSON.parse(content);
                            
                            if (!data.id) {
                                errors.push(file.name + ': ID manquant');
                            } else {
                                analysisData.responses.push(data);
                                validFiles++;
                            }
                        } catch (parseError) {
                            errors.push(file.name + ': ' + parseError.toString());
                        }
                        
                        processNextFile(index + 1);
                    };
                    
                    reader.onerror = function() {
                        errors.push(file.name + ': Erreur de lecture');
                        processNextFile(index + 1);
                    };
                    
                    reader.readAsText(file);
                }

                processNextFile(0);
                
            } catch (error) {
                debugLog('ERREUR processFiles: ' + error.toString());
            }
        }

        // Finalisation du traitement
        function finishProcessing(validFiles, errors) {
            debugLog('Finalisation: ' + validFiles + ' fichiers valides, ' + errors.length + ' erreurs');
            
            try {
                var loadingDiv = document.getElementById('loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }

                var fileCountDiv = document.getElementById('fileCount');
                if (fileCountDiv) {
                    fileCountDiv.textContent = validFiles + ' fichier(s) traité(s) avec succès';
                }

                if (errors.length > 0) {
                    var errorDiv = document.getElementById('errorMessage');
                    if (errorDiv) {
                        errorDiv.innerHTML = '<strong>Erreurs:</strong><br>' + errors.join('<br>');
                        errorDiv.style.display = 'block';
                    }
                }

                if (validFiles > 0) {
                    updateStatus('data-status', validFiles + ' fichier(s) analysé(s) ✓');
                    analyzeData();
                    displayResults();
                }
                
            } catch (error) {
                debugLog('ERREUR finishProcessing: ' + error.toString());
            }
        }

        // Génération PDF simplifiée
        function generatePDF() {
            debugLog('Tentative génération PDF...');
            
            try {
                // Version basique sans bibliothèque
                var content = 'Rapport Baromètre Santé 2025\n\n';
                content += 'Total réponses: ' + (analysisData.summary ? analysisData.summary.total : 'N/A') + '\n';
                content += 'Date: ' + new Date().toLocaleDateString('fr-FR') + '\n';
                
                // Téléchargement sous forme de fichier texte
                var blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'rapport_barometre_sante_2025.txt';
                link.click();
                
                debugLog('Rapport texte généré');
                
            } catch (error) {
                debugLog('ERREUR generatePDF: ' + error.toString());
            }
        }

        // Initialisation de l'application
        function initializeApp() {
            debugLog('Initialisation de l\'application...');
            
            try {
                updateStatus('app-status', 'Démarrage...');
                
                // Configuration des événements
                var selectButton = document.getElementById('selectButton');
                var fileInput = document.getElementById('fileInput');
                var pdfButton = document.getElementById('pdfButton');
                var testCanvasBtn = document.getElementById('testCanvas');
                var testDataBtn = document.getElementById('testData');
                var showResultsBtn = document.getElementById('showResults');
                
                if (selectButton && fileInput) {
                    selectButton.onclick = function() {
                        debugLog('Bouton sélection fichier cliqué');
                        fileInput.click();
                    };
                    
                    fileInput.onchange = function(event) {
                        handleFileSelection(event.target.files);
                    };
                }
                
                if (pdfButton) {
                    pdfButton.onclick = generatePDF;
                }
                
                if (testCanvasBtn) {
                    testCanvasBtn.onclick = testCanvas;
                }
                
                if (testDataBtn) {
                    testDataBtn.onclick = function() {
                        generateTestData();
                    };
                }
                
                if (showResultsBtn) {
                    showResultsBtn.onclick = function() {
                        var resultsSection = document.getElementById('resultsSection');
                        if (resultsSection) {
                            resultsSection.style.display = 'block';
                            debugLog('Section résultats forcée visible');
                        }
                    };
                }
                
                updateStatus('app-status', 'Prêt ✓');
                debugLog('Application initialisée avec succès');
                
                // Test automatique du Canvas
                setTimeout(function() {
                    testCanvas();
                }, 1000);
                
            } catch (error) {
                debugLog('ERREUR initializeApp: ' + error.toString());
                updateStatus('app-status', 'Erreur: ' + error.message);
            }
        }

        // Démarrage automatique
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM chargé');
            initializeApp();
        });

        // Fallback si DOMContentLoaded a déjà été déclenché
        if (document.readyState === 'loading') {
            debugLog('DOM en cours de chargement');
        } else {
            debugLog('DOM déjà chargé, initialisation immédiate');
            setTimeout(initializeApp, 100);
        }
    </script>
</body>
</html>
