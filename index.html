<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidation Baromètre Santé 2025</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .file-input-wrapper {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            margin: 10px;
        }

        .file-count {
            margin-top: 20px;
            font-weight: bold;
            color: #27ae60;
        }

        .results-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px;
        }

        .btn-primary {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #27ae60;
            color: white;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .detailed-results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .chart-placeholder {
            background: #e9ecef;
            border: 2px dashed #6c757d;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Consolidation Baromètre Santé 2025</h1>
            <p>Interface d'analyse et de génération de rapports</p>
        </div>

        <div class="upload-section">
            <h2>Import des fichiers JSON</h2>
            <div class="file-input-wrapper" id="dropZone">
                <p><strong>Cliquez ici pour sélectionner vos fichiers JSON</strong></p>
                <input type="file" id="fileInput" class="file-input" multiple accept=".json">
                <button class="upload-btn" id="selectButton">Choisir les fichiers</button>
            </div>
            <div id="fileCount" class="file-count"></div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="loading" id="loading">
            <p>Traitement des données en cours...</p>
        </div>

        <div class="results-section" id="resultsSection">
            <h2>Résultats de l'analyse</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" id="pdfButton">Générer rapport PDF</button>
                <button class="btn btn-secondary" onclick="window.print()">Imprimer</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalResponses">0</span>
                    <span>Réponses analysées</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="avgPhysicalHealth">-</span>
                    <span>Santé physique moyenne</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="avgPsychHealth">-</span>
                    <span>Santé psychologique moyenne</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stressPercentage">-</span>
                    <span>Avec charge de travail élevée</span>
                </div>
            </div>

            <div class="detailed-results" id="detailedResults">
                <!-- Résultats détaillés -->
            </div>

            <div class="chart-placeholder">
                <p>Graphiques disponibles après chargement de Chart.js</p>
            </div>
        </div>
    </div>

    <script>
        // Variables globales avec gestion sécurisée
        var analysisData = {
            responses: [],
            summary: {}
        };

        var librariesLoaded = {
            chartjs: false,
            jspdf: false
        };

        // Fonction de log sécurisée
        function safeLog(message) {
            try {
                console.log(message);
            } catch (e) {
                // Ignore si console non disponible
            }
        }

        // Fonction de gestion d'erreur sécurisée
        function handleError(error, context) {
            safeLog('Erreur dans ' + context + ': ' + error.toString());
            
            var errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.innerHTML = '<strong>Erreur:</strong> ' + error.toString();
                errorDiv.style.display = 'block';
            }
        }

        // Initialisation principale avec gestion d'erreurs
        function initializeApp() {
            try {
                safeLog('Initialisation de l\'application...');
                
                // Configuration des événements
                var selectButton = document.getElementById('selectButton');
                var fileInput = document.getElementById('fileInput');
                var pdfButton = document.getElementById('pdfButton');
                
                if (selectButton && fileInput) {
                    selectButton.onclick = function() {
                        fileInput.click();
                    };
                    
                    fileInput.onchange = function(event) {
                        handleFileSelection(event.target.files);
                    };
                }
                
                if (pdfButton) {
                    pdfButton.onclick = function() {
                        generatePDF();
                    };
                }
                
                // Chargement des bibliothèques
                loadExternalLibraries();
                
                safeLog('Application initialisée avec succès');
                
            } catch (error) {
                handleError(error, 'initializeApp');
            }
        }

        // Chargement sécurisé des bibliothèques externes
        function loadExternalLibraries() {
            try {
                // Chart.js
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js', function() {
                    librariesLoaded.chartjs = true;
                    safeLog('Chart.js chargé');
                });

                // jsPDF
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', function() {
                    librariesLoaded.jspdf = true;
                    safeLog('jsPDF chargé');
                });
                
            } catch (error) {
                handleError(error, 'loadExternalLibraries');
            }
        }

        // Fonction de chargement de script sécurisée
        function loadScript(url, callback) {
            try {
                var script = document.createElement('script');
                script.src = url;
                
                script.onload = function() {
                    if (callback) callback();
                };
                
                script.onerror = function() {
                    safeLog('Impossible de charger: ' + url);
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                handleError(error, 'loadScript');
            }
        }

        // Gestion de la sélection de fichiers
        function handleFileSelection(files) {
            try {
                if (!files || files.length === 0) {
                    return;
                }
                
                safeLog('Traitement de ' + files.length + ' fichiers');
                
                var fileCountDiv = document.getElementById('fileCount');
                if (fileCountDiv) {
                    fileCountDiv.textContent = files.length + ' fichier(s) sélectionné(s)';
                }
                
                var loadingDiv = document.getElementById('loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'block';
                }
                
                // Traitement asynchrone des fichiers
                setTimeout(function() {
                    processFiles(files);
                }, 100);
                
            } catch (error) {
                handleError(error, 'handleFileSelection');
            }
        }

        // Traitement des fichiers JSON
        function processFiles(files) {
            try {
                analysisData.responses = [];
                var validFiles = 0;
                var errors = [];
                var filesProcessed = 0;

                function processNextFile(index) {
                    if (index >= files.length) {
                        // Tous les fichiers traités
                        finishProcessing(validFiles, errors);
                        return;
                    }

                    var file = files[index];
                    
                    if (!file.name.toLowerCase().endsWith('.json')) {
                        errors.push(file.name + ': Format non supporté');
                        processNextFile(index + 1);
                        return;
                    }

                    var reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            var content = e.target.result;
                            var data = JSON.parse(content);
                            
                            if (!data.id) {
                                errors.push(file.name + ': ID manquant');
                            } else {
                                // Nettoyage des doublons
                                cleanDataDuplicates(data);
                                analysisData.responses.push(data);
                                validFiles++;
                            }
                        } catch (parseError) {
                            errors.push(file.name + ': ' + parseError.toString());
                        }
                        
                        processNextFile(index + 1);
                    };
                    
                    reader.onerror = function() {
                        errors.push(file.name + ': Erreur de lecture');
                        processNextFile(index + 1);
                    };
                    
                    reader.readAsText(file);
                }

                processNextFile(0);
                
            } catch (error) {
                handleError(error, 'processFiles');
            }
        }

        // Finalisation du traitement
        function finishProcessing(validFiles, errors) {
            try {
                var loadingDiv = document.getElementById('loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }

                var fileCountDiv = document.getElementById('fileCount');
                if (fileCountDiv) {
                    fileCountDiv.textContent = validFiles + ' fichier(s) traité(s) avec succès';
                }

                if (errors.length > 0) {
                    var errorDiv = document.getElementById('errorMessage');
                    if (errorDiv) {
                        errorDiv.innerHTML = '<strong>Erreurs:</strong><br>' + errors.join('<br>');
                        errorDiv.style.display = 'block';
                    }
                }

                if (validFiles > 0) {
                    analyzeData();
                    displayResults();
                }
                
            } catch (error) {
                handleError(error, 'finishProcessing');
            }
        }

        // Nettoyage des doublons
        function cleanDataDuplicates(data) {
            try {
                var fieldsToClean = ['sources_stress', 'symptomes_stress', 'obstacles_sport', 'ameliorations_prioritaires'];
                
                for (var i = 0; i < fieldsToClean.length; i++) {
                    var field = fieldsToClean[i];
                    if (data[field] && Array.isArray(data[field])) {
                        // Suppression des doublons
                        var unique = [];
                        for (var j = 0; j < data[field].length; j++) {
                            var value = data[field][j];
                            if (value && unique.indexOf(value) === -1) {
                                unique.push(value);
                            }
                        }
                        data[field] = unique;
                    }
                }
            } catch (error) {
                handleError(error, 'cleanDataDuplicates');
            }
        }

        // Analyse des données
        function analyzeData() {
            try {
                var responses = analysisData.responses;
                var summary = {};

                summary.total = responses.length;
                summary.dateAnalyse = new Date().toLocaleDateString('fr-FR');
                
                // Calcul des moyennes de santé
                var physicalScores = [];
                var psychScores = [];
                
                for (var i = 0; i < responses.length; i++) {
                    var r = responses[i];
                    
                    var physical = parseFloat(r.sante_physique);
                    if (!isNaN(physical) && physical > 0 && physical <= 10) {
                        physicalScores.push(physical);
                    }
                    
                    var psych = parseFloat(r.sante_psychologique);
                    if (!isNaN(psych) && psych > 0 && psych <= 10) {
                        psychScores.push(psych);
                    }
                }

                if (physicalScores.length > 0) {
                    var sum = 0;
                    for (var i = 0; i < physicalScores.length; i++) {
                        sum += physicalScores[i];
                    }
                    summary.avgPhysical = (sum / physicalScores.length).toFixed(1);
                } else {
                    summary.avgPhysical = 'N/A';
                }

                if (psychScores.length > 0) {
                    var sum = 0;
                    for (var i = 0; i < psychScores.length; i++) {
                        sum += psychScores[i];
                    }
                    summary.avgPsych = (sum / psychScores.length).toFixed(1);
                } else {
                    summary.avgPsych = 'N/A';
                }

                // Charge de travail
                var workloadIssues = 0;
                for (var i = 0; i < responses.length; i++) {
                    if (responses[i].charge_travail === 'non') {
                        workloadIssues++;
                    }
                }
                summary.workloadPercentage = ((workloadIssues / responses.length) * 100).toFixed(0);

                // Analyses par catégories
                summary.profils = analyzeField(responses, 'profil');
                summary.ages = analyzeField(responses, 'age');
                summary.stressSources = analyzeMultipleChoiceField(responses, 'sources_stress');

                analysisData.summary = summary;
                safeLog('Analyse terminée');
                
            } catch (error) {
                handleError(error, 'analyzeData');
            }
        }

        // Analyse d'un champ simple
        function analyzeField(responses, fieldName) {
            var counts = {};
            for (var i = 0; i < responses.length; i++) {
                var value = responses[i][fieldName] || 'Non renseigné';
                counts[value] = (counts[value] || 0) + 1;
            }
            return counts;
        }

        // Analyse d'un champ à choix multiples
        function analyzeMultipleChoiceField(responses, fieldName) {
            var counts = {};
            for (var i = 0; i < responses.length; i++) {
                var values = responses[i][fieldName];
                if (Array.isArray(values)) {
                    for (var j = 0; j < values.length; j++) {
                        var value = values[j];
                        if (value) {
                            counts[value] = (counts[value] || 0) + 1;
                        }
                    }
                }
            }
            return counts;
        }

        // Affichage des résultats
        function displayResults() {
            try {
                var summary = analysisData.summary;
                
                // Mise à jour des statistiques
                var totalEl = document.getElementById('totalResponses');
                var physicalEl = document.getElementById('avgPhysicalHealth');
                var psychEl = document.getElementById('avgPsychHealth');
                var stressEl = document.getElementById('stressPercentage');
                
                if (totalEl) totalEl.textContent = summary.total;
                if (physicalEl) physicalEl.textContent = summary.avgPhysical;
                if (psychEl) psychEl.textContent = summary.avgPsych;
                if (stressEl) stressEl.textContent = summary.workloadPercentage + '%';

                // Affichage des résultats détaillés
                displayDetailedResults();

                // Affichage de la section résultats
                var resultsSection = document.getElementById('resultsSection');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                }
                
            } catch (error) {
                handleError(error, 'displayResults');
            }
        }

        // Affichage des résultats détaillés
        function displayDetailedResults() {
            try {
                var summary = analysisData.summary;
                var container = document.getElementById('detailedResults');
                
                if (!container) return;
                
                var html = '<h3>Analyse détaillée</h3>';
                
                // Profils
                html += '<h4>Répartition par profil:</h4><ul>';
                for (var key in summary.profils) {
                    var count = summary.profils[key];
                    var percentage = ((count / summary.total) * 100).toFixed(1);
                    html += '<li>' + key + ': ' + count + ' (' + percentage + '%)</li>';
                }
                html += '</ul>';
                
                // Ages
                html += '<h4>Répartition par âge:</h4><ul>';
                for (var key in summary.ages) {
                    var count = summary.ages[key];
                    var percentage = ((count / summary.total) * 100).toFixed(1);
                    html += '<li>' + key + ': ' + count + ' (' + percentage + '%)</li>';
                }
                html += '</ul>';
                
                // Sources de stress
                if (summary.stressSources) {
                    html += '<h4>Sources de stress:</h4><ul>';
                    
                    // Tri par nombre de mentions
                    var stressArray = [];
                    for (var key in summary.stressSources) {
                        stressArray.push({key: key, count: summary.stressSources[key]});
                    }
                    stressArray.sort(function(a, b) { return b.count - a.count; });
                    
                    for (var i = 0; i < Math.min(10, stressArray.length); i++) {
                        var item = stressArray[i];
                        var displayKey = formatStressSource(item.key);
                        html += '<li>' + displayKey + ': ' + item.count + ' mentions</li>';
                    }
                    html += '</ul>';
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                handleError(error, 'displayDetailedResults');
            }
        }

        // Formatage des sources de stress
        function formatStressSource(key) {
            var mapping = {
                'gestion_clients': 'Gestion des clients',
                'complexite_dossiers': 'Complexité des dossiers',
                'tenue_delais': 'Tenue des délais',
                'pression_hierarchique': 'Pression hiérarchique',
                'outils_inefficaces': 'Outils inefficaces',
                'horaires_contraintes': 'Contraintes horaires',
                'manque_formation': 'Manque de formation',
                'pas_stresse': 'Pas de stress'
            };
            return mapping[key] || key;
        }

        // Génération PDF
        function generatePDF() {
            try {
                if (!librariesLoaded.jspdf || !window.jspdf) {
                    alert('La génération PDF n\'est pas disponible');
                    return;
                }

                var jsPDF = window.jspdf.jsPDF;
                var doc = new jsPDF();
                var summary = analysisData.summary;
                
                var yPos = 20;
                
                // Titre
                doc.setFontSize(20);
                doc.text('BAROMETRE SANTE 2025', 20, yPos);
                yPos += 20;
                
                // Informations générales
                doc.setFontSize(12);
                doc.text('Date: ' + summary.dateAnalyse, 20, yPos);
                yPos += 10;
                doc.text('Nombre de réponses: ' + summary.total, 20, yPos);
                yPos += 20;
                
                // Statistiques
                doc.text('Santé physique moyenne: ' + summary.avgPhysical + '/10', 20, yPos);
                yPos += 8;
                doc.text('Santé psychologique moyenne: ' + summary.avgPsych + '/10', 20, yPos);
                yPos += 8;
                doc.text('Charge de travail problématique: ' + summary.workloadPercentage + '%', 20, yPos);
                yPos += 20;
                
                // Profils
                doc.text('Répartition par profil:', 20, yPos);
                yPos += 10;
                
                for (var key in summary.profils) {
                    var count = summary.profils[key];
                    var percentage = ((count / summary.total) * 100).toFixed(1);
                    doc.text('• ' + key + ': ' + count + ' (' + percentage + '%)', 25, yPos);
                    yPos += 6;
                }
                
                var fileName = 'barometre_sante_rapport.pdf';
                doc.save(fileName);
                
            } catch (error) {
                handleError(error, 'generatePDF');
            }
        }

        // Initialisation au chargement de la page
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
