<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barom√®tre Sant√© 2025 - Analyse</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .upload-zone {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .analysis-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            display: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number { font-size: 2em; font-weight: bold; color: #667eea; }
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; }
        .file-list { margin-top: 20px; }
        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analyse Barom√®tre Sant√© 2025</h1>
            <p>Cabinet Saint Germain Audit</p>
        </div>

        <div class="upload-section">
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <h3>üìÅ Importer les fichiers JSON</h3>
                <p>Cliquez pour s√©lectionner les fichiers de r√©ponses</p>
                <input type="file" id="fileInput" multiple accept=".json" style="display: none">
            </div>
            
            <div id="fileList" class="file-list" style="display: none"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="analyzeBtn" class="btn" disabled onclick="analyzeData()">Analyser</button>
                <button class="btn" onclick="clearAll()" style="background: #dc3545;">Effacer</button>
            </div>
            
            <div id="alerts"></div>
        </div>

        <div class="analysis-section" id="analysisSection">
            <h2>R√©sultats de l'Analyse</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalResponses">0</div>
                    <div>R√©ponses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgHealth">0</div>
                    <div>Sant√© moyenne (/10)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stressPercent">0%</div>
                    <div>Stress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="qvtScore">0</div>
                    <div>QVT moyenne (/10)</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Profils Professionnels</h3>
                <canvas id="profileChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <h3>Notes de Satisfaction</h3>
                <canvas id="satisfactionChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <h3>Sources de Stress</h3>
                <canvas id="stressChart" width="400" height="200"></canvas>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="exportPDF()">üìÑ Exporter PDF</button>
            </div>
        </div>
    </div>

    <script>
        let responses = [];
        let charts = {};

        document.getElementById('fileInput').addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            responses = [];
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            fileList.style.display = 'none';

            let fileCount = 0;
            for (let i = 0; i < files.length; i++) {
                if (files[i].name.endsWith('.json')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data && data.id) {
                                responses.push(data);
                                const fileItem = document.createElement('div');
                                fileItem.className = 'file-item';
                                fileItem.innerHTML = '<span>üìÑ ' + files[i].name + '</span><span>‚úÖ</span>';
                                fileList.appendChild(fileItem);
                            }
                        } catch (error) {
                            showAlert('Erreur fichier ' + files[i].name, 'error');
                        }
                        fileCount++;
                        if (fileCount === files.length) {
                            if (responses.length > 0) {
                                fileList.style.display = 'block';
                                document.getElementById('analyzeBtn').disabled = false;
                                showAlert(responses.length + ' fichier(s) charg√©(s)', 'success');
                            }
                        }
                    };
                    reader.readAsText(files[i]);
                }
            }
        }

        function analyzeData() {
            if (responses.length === 0) return;

            try {
                // Calculs statistiques
                const total = responses.length;
                let totalSante = 0;
                let santeCount = 0;
                let stressCount = 0;
                let qvtTotal = 0;
                let qvtCount = 0;

                responses.forEach(function(r) {
                    if (r.sante_physique) {
                        totalSante += parseInt(r.sante_physique);
                        santeCount++;
                    }
                    if (r.sante_psychologique) {
                        totalSante += parseInt(r.sante_psychologique);
                        santeCount++;
                    }
                    if (r.sources_stress && r.sources_stress.length > 0) {
                        let hasStress = false;
                        for (let j = 0; j < r.sources_stress.length; j++) {
                            if (r.sources_stress[j] !== 'pas_stresse') {
                                hasStress = true;
                                break;
                            }
                        }
                        if (hasStress) stressCount++;
                    }
                    if (r.qvt) {
                        const qvtValues = {
                            'excellente': 10, 'bonne': 8, 'correcte': 6, 'decevante': 4, 'nocive': 2
                        };
                        if (qvtValues[r.qvt]) {
                            qvtTotal += qvtValues[r.qvt];
                            qvtCount++;
                        }
                    }
                });

                // Mise √† jour des statistiques
                document.getElementById('totalResponses').textContent = total;
                document.getElementById('avgHealth').textContent = santeCount > 0 ? (totalSante / santeCount).toFixed(1) : '0';
                document.getElementById('stressPercent').textContent = Math.round((stressCount / total) * 100) + '%';
                document.getElementById('qvtScore').textContent = qvtCount > 0 ? (qvtTotal / qvtCount).toFixed(1) : '0';

                createCharts();
                document.getElementById('analysisSection').style.display = 'block';
                showAlert('Analyse termin√©e', 'success');
            } catch (error) {
                showAlert('Erreur analyse: ' + error.message, 'error');
            }
        }

        function createCharts() {
            createProfileChart();
            createSatisfactionChart();
            createStressChart();
        }

        function createProfileChart() {
            const ctx = document.getElementById('profileChart').getContext('2d');
            const profileCounts = {};
            
            responses.forEach(function(r) {
                if (r.profil) {
                    profileCounts[r.profil] = (profileCounts[r.profil] || 0) + 1;
                }
            });

            const labels = [];
            const data = [];
            const labelMap = {
                'auditeur': 'Auditeur',
                'chef_mission': 'Chef de mission',
                'directeur_mission': 'Directeur'
            };

            for (let key in profileCounts) {
                labels.push(labelMap[key] || key);
                data.push(profileCounts[key]);
            }

            if (charts.profile) charts.profile.destroy();
            charts.profile = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#667eea', '#764ba2', '#48bb78']
                    }]
                },
                options: { responsive: true }
            });
        }

        function createSatisfactionChart() {
            const ctx = document.getElementById('satisfactionChart').getContext('2d');
            const scores = {};
            
            // Calcul des scores de satisfaction
            const mappings = {
                'gestion_pression': { 'tres_bien': 10, 'bien': 8, 'moyennement': 6, 'difficilement': 4, 'tres_difficilement': 2 },
                'qvt': { 'excellente': 10, 'bonne': 8, 'correcte': 6, 'decevante': 4, 'nocive': 2 },
                'climat_social': { 'tres_bon': 10, 'bon': 8, 'correct': 6, 'difficile': 4, 'tres_difficile': 2 }
            };

            for (let question in mappings) {
                const values = [];
                responses.forEach(function(r) {
                    if (r[question] && mappings[question][r[question]]) {
                        values.push(mappings[question][r[question]]);
                    }
                });
                if (values.length > 0) {
                    scores[question] = values.reduce((a,b) => a+b, 0) / values.length;
                }
            }

            const labels = [];
            const data = [];
            const labelMap = {
                'gestion_pression': 'Gestion pression',
                'qvt': 'Qualit√© vie travail',
                'climat_social': 'Climat social'
            };

            for (let key in scores) {
                labels.push(labelMap[key] || key);
                data.push(scores[key]);
            }

            if (charts.satisfaction) charts.satisfaction.destroy();
            charts.satisfaction = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Note (/10)',
                        data: data,
                        backgroundColor: '#48bb78'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                }
            });
        }

        function createStressChart() {
            const ctx = document.getElementById('stressChart').getContext('2d');
            const stressCounts = {};
            
            responses.forEach(function(r) {
                if (r.sources_stress && Array.isArray(r.sources_stress)) {
                    r.sources_stress.forEach(function(source) {
                        if (source !== 'pas_stresse') {
                            stressCounts[source] = (stressCounts[source] || 0) + 1;
                        }
                    });
                }
            });

            const labels = [];
            const data = [];
            const labelMap = {
                'gestion_clients': 'Clients',
                'tenue_delais': 'D√©lais',
                'pression_hierarchique': 'Hi√©rarchie',
                'complexite_dossiers': 'Complexit√©'
            };

            for (let key in stressCounts) {
                labels.push(labelMap[key] || key);
                data.push(stressCounts[key]);
            }

            if (charts.stress) charts.stress.destroy();
            charts.stress = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Mentions',
                        data: data,
                        backgroundColor: '#f56565'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('BAROMETRE SANTE 2025', 105, 30, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text('Cabinet Saint Germain Audit', 105, 45, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text('Nombre de repondants: ' + responses.length, 20, 70);
            doc.text('Date: ' + new Date().toLocaleDateString('fr-FR'), 20, 80);
            
            const fileName = 'Barometre_Sante_' + new Date().toISOString().slice(0, 10) + '.pdf';
            doc.save(fileName);
            
            showAlert('PDF g√©n√©r√©: ' + fileName, 'success');
        }

        function clearAll() {
            responses = [];
            document.getElementById('fileList').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('alerts').innerHTML = '';
            for (let key in charts) {
                if (charts[key]) charts[key].destroy();
            }
            charts = {};
            showAlert('Donn√©es effac√©es', 'info');
        }

        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = 'alert alert-' + type;
            alert.textContent = message;
            alertsContainer.appendChild(alert);
            
            setTimeout(function() {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>
