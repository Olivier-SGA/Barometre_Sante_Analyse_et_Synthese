<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barom√®tre Sant√© 2025 - Analyse Compl√®te</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .header {
            background: rgba(255, 255, 255, 0.98);
            padding: 40px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .header h1 { 
            color: #1a365d; 
            font-size: 3rem; 
            margin-bottom: 15px;
            font-weight: 700;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header h2 { 
            color: #2d5aa0; 
            font-size: 1.4rem; 
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .header p {
            color: #4a5568;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 35px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(10px);
        }
        
        .upload-zone {
            border: 3px dashed #4299e1;
            padding: 60px 30px;
            text-align: center;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.4s ease;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        }
        
        .upload-zone:hover { 
            border-color: #2b6cb0; 
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(66, 153, 225, 0.15);
        }
        
        .upload-zone h3 {
            font-size: 1.6rem;
            color: #2d3748;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .upload-zone p {
            color: #4a5568;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #4299e1 0%, #2b6cb0 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            margin: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover { 
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.4);
        }
        
        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }
        
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
        }
        
        .analysis-section {
            background: rgba(255, 255, 255, 0.97);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
            display: none;
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            text-align: center;
            font-size: 2.2rem;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 40px;
            position: relative;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, #4299e1, #2b6cb0);
            border-radius: 2px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 30px 25px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid transparent;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #4299e1, #2b6cb0, #1e3c72);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            border-color: #4299e1;
        }
        
        .stat-number { 
            font-size: 3rem; 
            font-weight: 800; 
            background: linear-gradient(135deg, #1e3c72, #2b6cb0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            line-height: 1;
        }
        
        .stat-label { 
            color: #4a5568; 
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 35px;
            margin-bottom: 50px;
        }
        
        .chart-container {
            background: #ffffff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            height: 450px;
        }
        
        .chart-container:hover {
            transform: translateY(-5px);
        }
        
        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 25px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 3px solid #e2e8f0;
            position: relative;
        }
        
        .chart-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #4299e1, #2b6cb0);
        }
        
        .chart-canvas {
            height: 350px !important;
        }
        
        .file-list { 
            margin-top: 25px; 
            background: #ffffff; 
            border-radius: 16px; 
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 500;
        }
        
        .file-item:last-child { 
            border-bottom: none; 
        }
        
        .alert {
            padding: 18px 24px;
            margin: 20px 0;
            border-radius: 12px;
            font-weight: 500;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .alert-success { 
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); 
            border: 2px solid #68d391; 
            color: #1a202c; 
        }
        
        .alert-error { 
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%); 
            border: 2px solid #f56565; 
            color: #1a202c; 
        }
        
        .alert-info { 
            background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%); 
            border: 2px solid #4299e1; 
            color: #1a202c; 
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #4299e1;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #2b6cb0);
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .charts-grid { 
                grid-template-columns: 1fr; 
            }
            .stats-grid { 
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            }
            .header h1 { 
                font-size: 2.2rem; 
            }
            .btn {
                padding: 14px 24px;
                font-size: 1rem;
            }
            .chart-container {
                height: 400px;
            }
            .chart-canvas {
                height: 300px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Barom√®tre Sant√© 2025</h1>
            <h2>Cabinet Saint Germain Audit</h2>
            <p>Analyse compl√®te et professionnelle des r√©sultats avec export PDF d√©taill√©</p>
        </div>

        <div class="upload-section">
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <h3>üìä Importer les fichiers JSON</h3>
                <p>Cliquez ici ou glissez-d√©posez vos fichiers de r√©ponses du barom√®tre</p>
                <p style="font-size: 0.9rem; color: #718096;">Formats accept√©s: .json uniquement</p>
                <input type="file" id="fileInput" multiple accept=".json" style="display: none;">
            </div>
            
            <div id="progressSection" style="display: none;">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <p id="progressText" style="text-align: center; color: #4a5568;">Traitement en cours...</p>
            </div>
            
            <div id="fileList" class="file-list" style="display: none;"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="analyzeBtn" class="btn" disabled onclick="analyzeData()">
                    üîç Analyser les donn√©es
                </button>
                <button class="btn btn-danger" onclick="clearAll()">
                    üóëÔ∏è Tout effacer
                </button>
            </div>
            
            <div id="alerts"></div>
        </div>

        <div class="analysis-section" id="analysisSection">
            <h2 class="section-title">üìà R√©sultats de l'Analyse</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalResponses">0</div>
                    <div class="stat-label">R√©pondants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgHealthPhys">0</div>
                    <div class="stat-label">Sant√© Physique (/10)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgHealthPsych">0</div>
                    <div class="stat-label">Sant√© Psychologique (/10)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stressCount">0%</div>
                    <div class="stat-label">Personnes Stress√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="qvtGood">0%</div>
                    <div class="stat-label">QVT Satisfaisante</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="burnoutRisk">0%</div>
                    <div class="stat-label">Risque Burnout</div>
                </div>
            </div>

            <div class="charts-grid" id="chartsContainer"></div>

            <div style="text-align: center; margin-top: 50px;">
                <button class="btn" onclick="exportDetailedPDF()" style="font-size: 1.2rem; padding: 20px 40px;">
                    üìÑ G√©n√©rer Rapport PDF Complet
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let responses = [];
        let charts = {};
        let analysisData = {};

        // Palette de couleurs √©tendue et professionnelle
        const colorPalette = [
            '#1e3c72', '#2a5298', '#4299e1', '#63b3ed', '#90cdf4',
            '#38a169', '#48bb78', '#68d391', '#9ae6b4', '#c6f6d5',
            '#d69e2e', '#ed8936', '#f6ad55', '#fbb6ce', '#fed7d7',
            '#e53e3e', '#f56565', '#fc8181', '#feb2b2', '#fed7d7',
            '#2d3748', '#4a5568', '#718096', '#a0aec0', '#cbd5e0'
        ];

        // Labels fran√ßais pour une interface professionnelle
        const frenchLabels = {
            profils: {
                'auditeur': 'Auditeur/Auditrice',
                'chef_mission': 'Chef de mission',
                'directeur_mission': 'Directeur de mission',
                'manager': 'Manager',
                'senior': 'Senior',
                'junior': 'Junior'
            },
            qvt: {
                'excellente': 'Excellente',
                'bonne': 'Bonne',
                'correcte': 'Correcte',
                'moyenne': 'Moyenne',
                'decevante': 'D√©cevante',
                'mauvaise': 'Mauvaise',
                'nocive': 'Nocive'
            },
            stress: {
                'gestion_clients': 'Gestion des clients',
                'tenue_delais': 'Respect des d√©lais',
                'pression_hierarchique': 'Pression hi√©rarchique',
                'complexite_dossiers': 'Complexit√© des dossiers',
                'charge_travail': 'Charge de travail',
                'manque_reconnaissance': 'Manque de reconnaissance',
                'equilibre_vie': '√âquilibre vie pro/perso',
                'pas_stresse': 'Pas stress√©',
                'aucun': 'Aucun stress'
            },
            ages: {
                '20-25': '20-25 ans',
                '26-30': '26-30 ans',
                '31-35': '31-35 ans',
                '36-40': '36-40 ans',
                '41-45': '41-45 ans',
                '46-50': '46-50 ans',
                '51+': '51+ ans'
            }
        };

        // Initialisation s√©curis√©e
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Barom√®tre Sant√© 2025 - Application charg√©e');
            
            try {
                // V√©rification des √©l√©ments critiques
                const requiredElements = ['fileInput', 'analyzeBtn', 'alerts', 'chartsContainer'];
                const missingElements = requiredElements.filter(id => !document.getElementById(id));
                
                if (missingElements.length > 0) {
                    console.error('‚ùå √âl√©ments manquants:', missingElements);
                    return;
                }
                
                // √âv√©nements de fichier
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileSelect);
                }

                // Support drag & drop
                const uploadZone = document.querySelector('.upload-zone');
                if (uploadZone) {
                    uploadZone.addEventListener('dragover', handleDragOver);
                    uploadZone.addEventListener('drop', handleDrop);
                    uploadZone.addEventListener('dragleave', handleDragLeave);
                }
                
                console.log('‚úÖ Initialisation termin√©e avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
                showAlert('Erreur lors de l\'initialisation de l\'application', 'error');
            }
        });

        // Gestion s√©curis√©e du drag & drop
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.borderColor = '#2b6cb0';
            event.currentTarget.style.backgroundColor = '#e6fffa';
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.borderColor = '#4299e1';
            event.currentTarget.style.backgroundColor = '';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            handleDragLeave(event);
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        }

        // Gestion de la s√©lection de fichiers
        function handleFileSelect(event) {
            const files = event.target.files;
            console.log('üìÅ Fichiers s√©lectionn√©s:', files.length);
            
            if (files.length > 0) {
                handleFiles(files);
            }
        }

        // Traitement robuste des fichiers
        function handleFiles(files) {
            if (!files || files.length === 0) {
                showAlert('Aucun fichier s√©lectionn√©', 'error');
                return;
            }
            
            // R√©initialisation
            responses = [];
            showProgressSection();
            
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<h3 style="color: #2d3748; margin-bottom: 20px;">üìã Traitement des fichiers...</h3>';
            fileList.style.display = 'block';

            let processed = 0;
            let valid = 0;
            const total = files.length;

            // Traitement asynchrone de chaque fichier
            Array.from(files).forEach((file, index) => {
                console.log(`üìÑ Traitement fichier ${index + 1}/${total}: ${file.name}`);

                if (!file.name.toLowerCase().endsWith('.json')) {
                    addFileStatus(file.name, 'Format non support√© (.json requis)', false);
                    processed++;
                    updateProgress(processed, total);
                    checkComplete();
                    return;
                }

                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const rawData = e.target.result;
                        if (!rawData || rawData.trim() === '') {
                            throw new Error('Fichier vide');
                        }
                        
                        const data = JSON.parse(rawData);
                        console.log(`‚úÖ JSON pars√© pour ${file.name}`);
                        
                        if (validateAndCleanData(data)) {
                            responses.push(data);
                            valid++;
                            addFileStatus(file.name, `‚úÖ Charg√© avec succ√®s (ID: ${data.id})`, true);
                        } else {
                            addFileStatus(file.name, '‚ùå Structure de donn√©es invalide', false);
                        }
                    } catch (error) {
                        console.error(`‚ùå Erreur pour ${file.name}:`, error);
                        addFileStatus(file.name, `‚ùå Erreur: ${error.message}`, false);
                    }
                    
                    processed++;
                    updateProgress(processed, total);
                    checkComplete();
                };
                
                reader.onerror = function() {
                    addFileStatus(file.name, '‚ùå Erreur de lecture du fichier', false);
                    processed++;
                    updateProgress(processed, total);
                    checkComplete();
                };
                
                reader.readAsText(file, 'UTF-8');
            });

            function updateProgress(current, total) {
                const percent = Math.round((current / total) * 100);
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                if (progressFill && progressText) {
                    progressFill.style.width = percent + '%';
                    progressText.textContent = `Traitement ${current}/${total} fichiers (${percent}%)`;
                }
            }

            function checkComplete() {
                if (processed === total) {
                    hideProgressSection();
                    console.log(`‚úÖ Traitement termin√©. Fichiers valides: ${valid}/${total}`);
                    
                    if (valid > 0) {
                        document.getElementById('analyzeBtn').disabled = false;
                        showAlert(`üéâ ${valid} fichier(s) charg√©(s) avec succ√®s sur ${total}`, 'success');
                        
                        // Pr√©-validation des donn√©es
                        const validationResult = validateDataIntegrity();
                        if (validationResult.warnings.length > 0) {
                            showAlert(`‚ö†Ô∏è ${validationResult.warnings.join(', ')}`, 'info');
                        }
                    } else {
                        showAlert('‚ùå Aucun fichier valide trouv√©. V√©rifiez le format JSON et la structure des donn√©es.', 'error');
                    }
                }
            }
        }

        // Validation et nettoyage robuste des donn√©es
        function validateAndCleanData(data) {
            try {
                if (!data || typeof data !== 'object') {
                    return false;
                }

                // ID obligatoire
                if (!data.id && data.id !== 0) {
                    return false;
                }

                // Champs essentiels du barom√®tre
                const essentialFields = [
                    'profil', 'age', 'sante_physique', 'sante_psychologique', 
                    'qvt', 'climat_social', 'sources_stress', 'charge_travail',
                    'pression_echeances', 'reconnaissance', 'equilibre_vie'
                ];

                let hasEssentialData = false;
                
                essentialFields.forEach(field => {
                    if (data[field] !== undefined && data[field] !== null && data[field] !== '') {
                        hasEssentialData = true;
                        
                        // Nettoyage des donn√©es num√©riques
                        if (['sante_physique', 'sante_psychologique', 'age'].includes(field)) {
                            const num = parseFloat(data[field]);
                            if (!isNaN(num) && num >= 0) {
                                data[field] = num;
                            }
                        }
                        
                        // Nettoyage des cha√Ænes
                        if (typeof data[field] === 'string') {
                            data[field] = data[field].trim().toLowerCase();
                        }
                    }
                });

                return hasEssentialData;
            } catch (error) {
                console.error('Erreur validation:', error);
                return false;
            }
        }

        // Validation de l'int√©grit√© globale des donn√©es
        function validateDataIntegrity() {
            const warnings = [];
            let totalFields = 0;
            let missingFields = 0;
            
            const expectedFields = [
                'profil', 'age', 'sante_physique', 'sante_psychologique', 
                'qvt', 'sources_stress', 'charge_travail'
            ];
            
            responses.forEach(response => {
                expectedFields.forEach(field => {
                    totalFields++;
                    if (!response[field] || response[field] === '' || response[field] === null) {
                        missingFields++;
                    }
                });
            });
            
            const missingPercent = totalFields > 0 ? (missingFields / totalFields) * 100 : 0;
            if (missingPercent > 20) {
                warnings.push(`${Math.round(missingPercent)}% de donn√©es manquantes d√©tect√©es`);
            }
            
            return { warnings };
        }

        // Affichage des statuts de fichiers
        function addFileStatus(fileName, status, isValid) {
            const fileList = document.getElementById('fileList');
            if (!fileList) return;
            
            const item = document.createElement('div');
            item.className = 'file-item';
            
            const fileInfo = document.createElement('span');
            fileInfo.style.fontWeight = '600';
            fileInfo.textContent = `üìÑ ${fileName}`;
            
            const statusInfo = document.createElement('span');
            statusInfo.style.color = isValid ? '#38a169' : '#e53e3e';
            statusInfo.style.fontWeight = '600';
            statusInfo.textContent = status;
            
            item.appendChild(fileInfo);
            item.appendChild(statusInfo);
            fileList.appendChild(item);
        }

        // Gestion de la barre de progression
        function showProgressSection() {
            const section = document.getElementById('progressSection');
            if (section) section.style.display = 'block';
        }

        function hideProgressSection() {
            setTimeout(() => {
                const section = document.getElementById('progressSection');
                if (section) section.style.display = 'none';
            }, 1000);
        }

        // Analyse compl√®te des donn√©es
        function analyzeData() {
            console.log('üîÑ D√©but analyse avec', responses.length, 'r√©ponses');
            
            if (responses.length === 0) {
                showAlert('‚ùå Aucune donn√©e √† analyser', 'error');
                return;
            }

            // Animation du bouton
            const btn = document.getElementById('analyzeBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Analyse en cours...';
            btn.disabled = true;

            try {
                setTimeout(() => {
                    try {
                        calculateComprehensiveStats();
                        createAllCharts();
                        
                        const analysisSection = document.getElementById('analysisSection');
                        if (analysisSection) {
                            analysisSection.style.display = 'block';
                            analysisSection.scrollIntoView({ behavior: 'smooth' });
                        }
                        
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        
                        showAlert('üéâ Analyse termin√©e avec succ√®s !', 'success');
                    } catch (error) {
                        throw error;
                    }
                }, 800);
                
            } catch (error) {
                console.error('‚ùå Erreur analyse:', error);
                showAlert(`‚ùå Erreur lors de l'analyse: ${error.message}`, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Calculs statistiques complets et pr√©cis
        function calculateComprehensiveStats() {
            const total = responses.length;
            
            // Sant√© physique et psychologique s√©par√©es
            let physSum = 0, physCount = 0;
            let psychoSum = 0, psychoCount = 0;
            
            responses.forEach(r => {
                if (r.sante_physique !== undefined && !isNaN(parseFloat(r.sante_physique))) {
                    physSum += parseFloat(r.sante_physique);
                    physCount++;
                }
                if (r.sante_psychologique !== undefined && !isNaN(parseFloat(r.sante_psychologique))) {
                    psychoSum += parseFloat(r.sante_psychologique);
                    psychoCount++;
                }
            });

            const avgHealthPhys = physCount > 0 ? physSum / physCount : 0;
            const avgHealthPsych = psychoCount > 0 ? psychoSum / psychoCount : 0;

            // Calcul pr√©cis du stress
            let stressCount = 0;
            responses.forEach(r => {
                let hasStress = false;
                
                if (r.sources_stress) {
                    if (Array.isArray(r.sources_stress)) {
                        hasStress = r.sources_stress.some(s => 
                            s && s !== 'pas_stresse' && s !== 'aucun' && s.trim() !== ''
                        );
                    } else if (typeof r.sources_stress === 'string') {
                        const stress = r.sources_stress.trim().toLowerCase();
                        hasStress = stress !== 'pas_stresse' && stress !== 'aucun' && stress !== '';
                    }
                }
                
                if (hasStress) stressCount++;
            });

            // QVT satisfaisante (bonne + excellente)
            let qvtGoodCount = 0;
            responses.forEach(r => {
                if (r.qvt === 'excellente' || r.qvt === 'bonne') {
                    qvtGoodCount++;
                }
            });

            // Risque de burnout (algorithme multicrit√®res)
            let burnoutRiskCount = 0;
            responses.forEach(r => {
                const lowHealthPhys = r.sante_physique && parseFloat(r.sante_physique) < 5;
                const lowHealthPsych = r.sante_psychologique && parseFloat(r.sante_psychologique) < 5;
                
                let highStress = false;
                if (r.sources_stress && Array.isArray(r.sources_stress)) {
                    highStress = r.sources_stress.filter(s => 
                        s && s !== 'pas_stresse' && s !== 'aucun'
                    ).length > 2;
                } else if (r.sources_stress && typeof r.sources_stress === 'string') {
                    highStress = r.sources_stress !== 'pas_stresse' && r.sources_stress !== 'aucun';
                }
                
                const poorQVT = ['decevante', 'mauvaise', 'nocive'].includes(r.qvt);
                
                // Crit√®res de risque combin√©s
                const riskFactors = [lowHealthPhys, lowHealthPsych, highStress, poorQVT].filter(Boolean).length;
                if (riskFactors >= 2) {
                    burnoutRiskCount++;
                }
            });

            // Mise √† jour s√©curis√©e de l'interface
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };

            updateElement('totalResponses', total);
            updateElement('avgHealthPhys', avgHealthPhys.toFixed(1));
            updateElement('avgHealthPsych', avgHealthPsych.toFixed(1));
            updateElement('stressCount', Math.round((stressCount / total) * 100) + '%');
            updateElement('qvtGood', Math.round((qvtGoodCount / total) * 100) + '%');
            updateElement('burnoutRisk', Math.round((burnoutRiskCount / total) * 100) + '%');

            // Stockage pour export PDF
            analysisData = {
                total: total,
                avgHealthPhys: avgHealthPhys,
                avgHealthPsych: avgHealthPsych,
                stressPercent: (stressCount / total) * 100,
                qvtGoodPercent: (qvtGoodCount / total) * 100,
                burnoutPercent: (burnoutRiskCount / total) * 100,
                profiles: getProfileData(),
                stress: getStressData(),
                qvt: getQVTData(),
                ages: getAgeData(),
                health: {
                    physique: avgHealthPhys,
                    psychologique: avgHealthPsych
                },
                workload: getWorkloadData()
            };

            console.log('üìä Donn√©es analys√©es:', analysisData);
        }

        // Collecte des donn√©es par profil
        function getProfileData() {
            const counts = {};
            responses.forEach(r => {
                if (r.profil && typeof r.profil === 'string' && r.profil.trim() !== '') {
                    const profil = r.profil.toLowerCase().trim();
                    counts[profil] = (counts[profil] || 0) + 1;
                }
            });
            return counts;
        }

        // Collecte des donn√©es de stress
        function getStressData() {
            const sources = {};
            responses.forEach(r => {
                if (r.sources_stress) {
                    if (Array.isArray(r.sources_stress)) {
                        r.sources_stress.forEach(s => {
                            if (s && typeof s === 'string' && s !== 'pas_stresse' && s !== 'aucun' && s.trim() !== '') {
                                const stress = s.toLowerCase().trim();
                                sources[stress] = (sources[stress] || 0) + 1;
                            }
                        });
                    } else if (typeof r.sources_stress === 'string') {
                        const stress = r.sources_stress.toLowerCase().trim();
                        if (stress !== 'pas_stresse' && stress !== 'aucun' && stress !== '') {
                            sources[stress] = (sources[stress] || 0) + 1;
                        }
                    }
                }
            });
            return sources;
        }

        // Collecte des donn√©es QVT
        function getQVTData() {
            const counts = {};
            responses.forEach(r => {
                if (r.qvt && typeof r.qvt === 'string' && r.qvt.trim() !== '') {
                    const qvt = r.qvt.toLowerCase().trim();
                    counts[qvt] = (counts[qvt] || 0) + 1;
                }
            });
            return counts;
        }

        // Collecte des donn√©es d'√¢ge
        function getAgeData() {
            const counts = {};
            responses.forEach(r => {
                if (r.age !== undefined && r.age !== null) {
                    let ageGroup;
                    const age = typeof r.age === 'number' ? r.age : parseInt(r.age);
                    
                    if (!isNaN(age) && age > 0) {
                        if (age <= 25) ageGroup = '20-25';
                        else if (age <= 30) ageGroup = '26-30';
                        else if (age <= 35) ageGroup = '31-35';
                        else if (age <= 40) ageGroup = '36-40';
                        else if (age <= 45) ageGroup = '41-45';
                        else if (age <= 50) ageGroup = '46-50';
                        else ageGroup = '51+';
                        
                        counts[ageGroup] = (counts[ageGroup] || 0) + 1;
                    } else if (typeof r.age === 'string' && r.age.trim() !== '') {
                        const ageStr = r.age.toLowerCase().trim();
                        counts[ageStr] = (counts[ageStr] || 0) + 1;
                    }
                }
            });
            return counts;
        }

        // Collecte des donn√©es de charge de travail
        function getWorkloadData() {
            const pressure = {};
            const workload = {};
            
            responses.forEach(r => {
                if (r.pression_echeances && typeof r.pression_echeances === 'string' && r.pression_echeances.trim() !== '') {
                    const pression = r.pression_echeances.toLowerCase().trim();
                    pressure[pression] = (pressure[pression] || 0) + 1;
                }
                
                if (r.charge_travail && typeof r.charge_travail === 'string' && r.charge_travail.trim() !== '') {
                    const charge = r.charge_travail.toLowerCase().trim();
                    workload[charge] = (workload[charge] || 0) + 1;
                }
            });
            
            return { pressure, workload };
        }

        // Cr√©ation de tous les graphiques avec Chart.js
        function createAllCharts() {
            const container = document.getElementById('chartsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Nettoyer les graphiques existants
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};

            // Cr√©er les graphiques si les donn√©es existent
            if (Object.keys(analysisData.profiles).length > 0) {
                createChart('R√©partition des Profils Professionnels', 'doughnut', analysisData.profiles, 'profils');
            }

            if (Object.keys(analysisData.qvt).length > 0) {
                createChart('Qualit√© de Vie au Travail', 'pie', analysisData.qvt, 'qvt');
            }

            if (Object.keys(analysisData.stress).length > 0) {
                createChart('Sources de Stress Principales', 'bar', analysisData.stress, 'stress');
            }

            if (Object.keys(analysisData.ages).length > 0) {
                createChart('R√©partition par Tranches d\'√Çge', 'bar', analysisData.ages, 'ages');
            }

            // Graphique des notes de sant√©
            createHealthChart();

            // Graphique de la charge de travail si disponible
            if (analysisData.workload.pressure && Object.keys(analysisData.workload.pressure).length > 0) {
                createChart('Pression des √âch√©ances', 'bar', analysisData.workload.pressure, null, true);
            }
        }

        // Cr√©ation d'un graphique avec Chart.js
        function createChart(title, type, data, labelType = null, isHorizontal = false) {
            const container = document.getElementById('chartsContainer');
            if (!container) return;
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'chart-title';
            titleDiv.textContent = title;
            
            const canvas = document.createElement('canvas');
            const chartId = 'chart_' + Date.now() + Math.random().toString(36).substr(2, 5);
            canvas.id = chartId;
            canvas.className = 'chart-canvas';
            
            chartDiv.appendChild(titleDiv);
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            // Pr√©paration des donn√©es
            const labels = [];
            const values = [];
            const colors = [];

            Object.entries(data)
                .sort(([,a], [,b]) => b - a) // Tri par valeur d√©croissante
                .forEach(([key, value], index) => {
                    // Labels fran√ßais si disponibles
                    const friendlyLabel = labelType && frenchLabels[labelType] && frenchLabels[labelType][key] 
                        ? frenchLabels[labelType][key] 
                        : key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                    
                    labels.push(friendlyLabel);
                    values.push(value);
                    colors.push(colorPalette[index % colorPalette.length]);
                });

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Nombre de r√©ponses',
                    data: values,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color + '80'),
                    borderWidth: 2,
                    hoverOffset: type === 'pie' || type === 'doughnut' ? 8 : 0
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: type === 'bar' ? 'top' : 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                const labels = original.call(this, chart);
                                
                                // Ajouter les pourcentages
                                const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                labels.forEach((label, index) => {
                                    const value = chart.data.datasets[0].data[index];
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    label.text += ` (${percentage}%)`;
                                });
                                
                                return labels;
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(26, 54, 93, 0.95)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: '#4299e1',
                        borderWidth: 1,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            };

            // Configuration sp√©cifique pour les graphiques en barres
            if (type === 'bar') {
                options.indexAxis = isHorizontal ? 'y' : 'x';
                options.scales = {
                    [isHorizontal ? 'x' : 'y']: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    [isHorizontal ? 'y' : 'x']: {
                        ticks: {
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                };
            }

            try {
                charts[chartId] = new Chart(ctx, {
                    type: type,
                    data: chartData,
                    options: options
                });
            } catch (error) {
                console.error('Erreur cr√©ation graphique:', error);
            }
        }

        // Graphique sp√©cialis√© pour les notes de sant√©
        function createHealthChart() {
            const container = document.getElementById('chartsContainer');
            if (!container) return;
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'chart-title';
            titleDiv.textContent = 'Notes Moyennes de Sant√©';
            
            const canvas = document.createElement('canvas');
            const chartId = 'health_chart_' + Date.now();
            canvas.id = chartId;
            canvas.className = 'chart-canvas';
            
            chartDiv.appendChild(titleDiv);
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            const chartData = {
                labels: ['Sant√© Physique', 'Sant√© Psychologique'],
                datasets: [{
                    label: 'Note moyenne (/10)',
                    data: [analysisData.avgHealthPhys, analysisData.avgHealthPsych],
                    backgroundColor: ['#48bb78', '#4299e1'],
                    borderColor: ['#38a169', '#2b6cb0'],
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                return value + '/10';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(26, 54, 93, 0.95)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed.y.toFixed(1)}/10`;
                            }
                        }
                    }
                }
            };

            try {
                charts[chartId] = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: options
                });
            } catch (error) {
                console.error('Erreur cr√©ation graphique sant√©:', error);
            }
        }

        // Export PDF professionnel et complet
        function exportDetailedPDF() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('Biblioth√®que jsPDF non charg√©e');
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let y = 25;
                const margin = 20;
                const pageHeight = doc.internal.pageSize.getHeight();
                const pageWidth = doc.internal.pageSize.getWidth();

                // Fonction pour g√©rer les sauts de page
                function checkNewPage(additionalHeight = 30) {
                    if (y + additionalHeight > pageHeight - 25) {
                        doc.addPage();
                        y = 30;
                        return true;
                    }
                    return false;
                }

                // En-t√™te professionnel
                doc.setFontSize(24);
                doc.setTextColor(30, 58, 114);
                doc.text('BAROM√àTRE SANT√â 2025', pageWidth / 2, y, { align: 'center' });
                y += 15;
                
                doc.setFontSize(16);
                doc.setTextColor(45, 90, 160);
                doc.text('Cabinet Saint Germain Audit', pageWidth / 2, y, { align: 'center' });
                y += 12;
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                const now = new Date();
                const dateStr = now.toLocaleDateString('fr-FR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                doc.text(`Rapport g√©n√©r√© le ${dateStr}`, pageWidth / 2, y, { align: 'center' });
                y += 25;

                // Ligne de s√©paration √©l√©gante
                doc.setDrawColor(66, 153, 225);
                doc.setLineWidth(1.5);
                doc.line(margin, y, pageWidth - margin, y);
                y += 25;

                // Synth√®se ex√©cutive
                checkNewPage(80);
                doc.setFontSize(18);
                doc.setTextColor(26, 54, 93);
                doc.text('SYNTHESE EXECUTIVE', margin, y);
                y += 20;

                doc.setFontSize(12);
                doc.setTextColor(60, 60, 60);
                
                const synthese = [
                    `Nombre total de r√©pondants : ${analysisData.total}`,
                    `Note sant√© physique moyenne : ${analysisData.avgHealthPhys.toFixed(1)}/10`,
                    `Note sant√© psychologique moyenne : ${analysisData.avgHealthPsych.toFixed(1)}/10`,
                    `Pourcentage de collaborateurs stress√©s : ${Math.round(analysisData.stressPercent)}%`,
                    `QVT jug√©e satisfaisante (bonne/excellente) : ${Math.round(analysisData.qvtGoodPercent)}%`,
                    `Collaborateurs √† risque de burnout : ${Math.round(analysisData.burnoutPercent)}%`
                ];

                synthese.forEach(line => {
                    checkNewPage(10);
                    doc.text('‚Ä¢ ' + line, margin + 5, y);
                    y += 8;
                });

                y += 15;

                // Analyse d√©taill√©e par section
                const sections = [
                    { title: 'PROFILS PROFESSIONNELS', data: analysisData.profiles, labelType: 'profils' },
                    { title: 'QUALITE DE VIE AU TRAVAIL', data: analysisData.qvt, labelType: 'qvt' },
                    { title: 'SOURCES DE STRESS', data: analysisData.stress, labelType: 'stress' },
                    { title: 'REPARTITION PAR AGE', data: analysisData.ages, labelType: 'ages' }
                ];

                sections.forEach(section => {
                    if (!section.data || Object.keys(section.data).length === 0) return;

                    checkNewPage(60);
                    
                    doc.setFontSize(16);
                    doc.setTextColor(26, 54, 93);
                    doc.text(section.title, margin, y);
                    y += 15;

                    doc.setFontSize(11);
                    doc.setTextColor(60, 60, 60);

                    const total = Object.values(section.data).reduce((sum, val) => sum + val, 0);

                    Object.entries(section.data)
                        .sort(([,a], [,b]) => b - a) // Tri d√©croissant
                        .forEach(([key, count]) => {
                            const percent = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                            const label = section.labelType && frenchLabels[section.labelType] && frenchLabels[section.labelType][key] 
                                ? frenchLabels[section.labelType][key] 
                                : key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                            
                            checkNewPage(8);
                            doc.text(`‚Ä¢ ${label} : ${count} r√©ponse${count > 1 ? 's' : ''} (${percent}%)`, margin + 5, y);
                            y += 7;
                        });

                    y += 12;
                });

                // Section sant√© d√©taill√©e
                checkNewPage(50);
                doc.setFontSize(16);
                doc.setTextColor(26, 54, 93);
                doc.text('ANALYSE SANTE DETAILLEE', margin, y);
                y += 15;

                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);

                const healthAnalysis = [
                    `Sant√© physique : ${analysisData.avgHealthPhys.toFixed(1)}/10 ${getHealthStatus(analysisData.avgHealthPhys)}`,
                    `Sant√© psychologique : ${analysisData.avgHealthPsych.toFixed(1)}/10 ${getHealthStatus(analysisData.avgHealthPsych)}`,
                    `√âcart sant√© physique/psychologique : ${Math.abs(analysisData.avgHealthPhys - analysisData.avgHealthPsych).toFixed(1)} points`,
                    `Pourcentage de collaborateurs en situation de stress : ${Math.round(analysisData.stressPercent)}%`,
                    `Estimation du risque de burnout : ${Math.round(analysisData.burnoutPercent)}% ${getBurnoutRiskLevel(analysisData.burnoutPercent)}`
                ];

                healthAnalysis.forEach(line => {
                    checkNewPage(10);
                    doc.text('‚Ä¢ ' + line, margin + 5, y);
                    y += 8;
                });

                y += 15;

                // Recommandations strat√©giques
                checkNewPage(100);
                doc.setFontSize(16);
                doc.setTextColor(26, 54, 93);
                doc.text('üí° RECOMMANDATIONS STRAT√âGIQUES', margin, y);
                y += 15;

                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);

                const recommendations = generateDetailedRecommendations();
                recommendations.forEach((rec, index) => {
                    checkNewPage(20);
                    
                    // Titre de la recommandation
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${rec.title}`, margin + 5, y);
                    y += 8;
                    
                    // Description
                    doc.setFont(undefined, 'normal');
                    const lines = doc.splitTextToSize(rec.description, pageWidth - 2 * margin - 10);
                    lines.forEach(line => {
                        checkNewPage(8);
                        doc.text(line, margin + 10, y);
                        y += 6;
                    });
                    y += 5;
                });

                // Plan d'action
                checkNewPage(60);
                doc.setFontSize(16);
                doc.setTextColor(26, 54, 93);
                doc.text('üéØ PLAN D\'ACTION RECOMMAND√â', margin, y);
                y += 15;

                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);

                const actionPlan = generateActionPlan();
                actionPlan.forEach((action, index) => {
                    checkNewPage(25);
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`${action.priority} - ${action.title}`, margin + 5, y);
                    y += 8;
                    
                    doc.setFont(undefined, 'normal');
                    doc.text(`D√©lai : ${action.timeline}`, margin + 10, y);
                    y += 6;
                    
                    const descLines = doc.splitTextToSize(action.description, pageWidth - 2 * margin - 10);
                    descLines.forEach(line => {
                        checkNewPage(6);
                        doc.text(line, margin + 10, y);
                        y += 6;
                    });
                    y += 8;
                });

                // Pied de page sur toutes les pages
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setTextColor(120, 120, 120);
                    
                    // Pied de page gauche
                    doc.text(
                        'Cabinet Saint Germain Audit - Confidentiel',
                        margin,
                        pageHeight - 15
                    );
                    
                    // Pied de page centre
                    doc.text(
                        `Barom√®tre Sant√© 2025`,
                        pageWidth / 2,
                        pageHeight - 15,
                        { align: 'center' }
                    );
                    
                    // Pied de page droite
                    doc.text(
                        `Page ${i}/${totalPages}`,
                        pageWidth - margin,
                        pageHeight - 15,
                        { align: 'right' }
                    );
                }

                // Sauvegarde avec nom intelligent
                const timestamp = now.toISOString().slice(0, 10).replace(/-/g, '');
                const fileName = `Barometre_Sante_2025_${timestamp}_${analysisData.total}repondants.pdf`;
                
                doc.save(fileName);
                
                showAlert(`üìÑ Rapport PDF g√©n√©r√© avec succ√®s : ${fileName}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erreur g√©n√©ration PDF:', error);
                showAlert(`‚ùå Erreur lors de la g√©n√©ration du PDF : ${error.message}`, 'error');
            }
        }

        // Fonctions utilitaires pour le PDF
        function getHealthStatus(score) {
            if (score >= 8) return '(Excellente)';
            if (score >= 7) return '(Tr√®s bonne)';
            if (score >= 6) return '(Bonne)';
            if (score >= 5) return '(Correcte)';
            if (score >= 4) return '(Pr√©occupante)';
            return '(Critique)';
        }

        function getBurnoutRiskLevel(percent) {
            if (percent < 10) return '(Risque faible)';
            if (percent < 20) return '(Risque mod√©r√©)';
            if (percent < 30) return '(Risque √©lev√©)';
            return '(Risque critique)';
        }

        // G√©n√©ration des recommandations d√©taill√©es
        function generateDetailedRecommendations() {
            const recommendations = [];

            // Recommandations sant√© physique
            if (analysisData.avgHealthPhys < 6) {
                recommendations.push({
                    title: 'Am√©lioration de la sant√© physique',
                    description: 'Mettre en place un programme d\'ergonomie au poste de travail, organiser des sessions d\'activit√© physique adapt√©e et sensibiliser aux bonnes pratiques de sant√© au travail. Consid√©rer l\'am√©nagement des espaces de travail pour favoriser le bien-√™tre physique.'
                });
            }

            // Recommandations sant√© psychologique
            if (analysisData.avgHealthPsych < 6) {
                recommendations.push({
                    title: 'Soutien √† la sant√© psychologique',
                    description: 'D√©velopper un programme d\'accompagnement psychologique avec des professionnels qualifi√©s. Organiser des ateliers de gestion du stress et de pr√©vention des risques psychosociaux. Mettre en place une cellule d\'√©coute et de soutien.'
                });
            }

            // Recommandations gestion du stress
            if (analysisData.stressPercent > 50) {
                recommendations.push({
                    title: 'R√©duction des sources de stress',
                    description: 'Identifier et traiter les causes principales de stress organisationnel. R√©viser la r√©partition des charges de travail, am√©liorer les processus de communication interne et renforcer l\'autonomie des collaborateurs dans leurs missions.'
                });
            }

            // Recommandations QVT
            if (analysisData.qvtGoodPercent < 60) {
                recommendations.push({
                    title: 'Am√©lioration de la qualit√© de vie au travail',
                    description: 'D√©velopper un plan d\'am√©lioration de la QVT en concertation avec les √©quipes. Focus sur l\'√©quilibre vie professionnelle/personnelle, la reconnaissance du travail accompli et l\'am√©lioration de l\'environnement de travail.'
                });
            }

            // Recommandations burnout
            if (analysisData.burnoutPercent > 15) {
                recommendations.push({
                    title: 'Pr√©vention du burnout',
                    description: 'Mise en place urgente d\'un dispositif de pr√©vention et de d√©tection pr√©coce du burnout. Formation des managers √† la d√©tection des signaux d\'alerte et cr√©ation d\'un protocole d\'intervention rapide.'
                });
            }

            // Recommandations g√©n√©rales
            recommendations.push({
                title: 'Communication et dialogue social',
                description: 'Renforcer le dialogue social par des r√©unions d\'√©quipe r√©guli√®res, la mise en place d\'un syst√®me de feedback continu et l\'am√©lioration de la communication descendante et ascendante.'
            });

            return recommendations;
        }

        // G√©n√©ration du plan d'action
        function generateActionPlan() {
            const actions = [];
            
            // Actions prioritaires bas√©es sur l'analyse
            if (analysisData.burnoutPercent > 20) {
                actions.push({
                    priority: 'URGENT',
                    title: 'Dispositif de pr√©vention burnout',
                    timeline: 'Sous 30 jours',
                    description: 'Formation managers, cellule d\'√©coute, protocole d\'intervention'
                });
            }
            
            if (analysisData.avgHealthPsych < 5) {
                actions.push({
                    priority: 'PRIORIT√â 1',
                    title: 'Programme de soutien psychologique',
                    timeline: '1-2 mois',
                    description: 'Partenariat avec professionnels, ateliers de gestion du stress'
                });
            }
            
            actions.push({
                priority: 'PRIORIT√â 2',
                title: 'Analyse approfondie des sources de stress',
                timeline: '2-3 mois',
                description: 'Audit organisationnel, enqu√™te qualitative compl√©mentaire'
            });
            
            actions.push({
                priority: 'PRIORIT√â 3',
                title: 'Plan d\'am√©lioration QVT',
                timeline: '3-6 mois',
                description: 'Co-construction avec les √©quipes, mise en ≈ìuvre progressive'
            });
            
            actions.push({
                priority: 'SUIVI',
                title: 'R√©√©valuation du barom√®tre',
                timeline: '6 mois',
                description: 'Nouvelle enqu√™te pour mesurer l\'impact des actions mises en place'
            });

            return actions;
        }

        // Effacement complet et s√©curis√©
        function clearAll() {
            try {
                // R√©initialisation des donn√©es
                responses = [];
                analysisData = {};
                
                // Nettoyage de l'interface
                const elements = {
                    fileList: 'none',
                    analysisSection: 'none',
                    progressSection: 'none'
                };
                
                Object.entries(elements).forEach(([id, display]) => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = display;
                });
                
                // R√©initialisation des contr√¥les
                const analyzeBtn = document.getElementById('analyzeBtn');
                if (analyzeBtn) analyzeBtn.disabled = true;
                
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.value = '';
                
                // Nettoyage des alertes et graphiques
                const alerts = document.getElementById('alerts');
                if (alerts) alerts.innerHTML = '';
                
                const chartsContainer = document.getElementById('chartsContainer');
                if (chartsContainer) chartsContainer.innerHTML = '';
                
                // Destruction des graphiques
                Object.values(charts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                charts = {};
                
                // R√©initialisation des statistiques
                const stats = ['totalResponses', 'avgHealthPhys', 'avgHealthPsych', 'stressCount', 'qvtGood', 'burnoutRisk'];
                stats.forEach(statId => {
                    const element = document.getElementById(statId);
                    if (element) {
                        element.textContent = statId.includes('Count') || statId.includes('Good') || statId.includes('Risk') ? '0%' : '0';
                    }
                });
                
                showAlert('üóëÔ∏è Toutes les donn√©es ont √©t√© effac√©es avec succ√®s', 'info');
                
            } catch (error) {
                console.error('Erreur lors du nettoyage:', error);
                showAlert('Erreur lors de l\'effacement des donn√©es', 'error');
            }
        }

        // Syst√®me d'alertes am√©lior√©
        function showAlert(message, type) {
            const container = document.getElementById('alerts');
            if (!container) return;
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            // Animation d'apparition
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-10px)';
            container.appendChild(alert);
            
            // Transition fluide
            setTimeout(() => {
                alert.style.opacity = '1';
                alert.style.transform = 'translateY(0)';
            }, 100);
            
            // Auto-suppression avec animation
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Log de confirmation du chargement
        console.log('‚úÖ Barom√®tre Sant√© 2025 - Application enti√®rement charg√©e et fonctionnelle');
        console.log('üîß Version: Production Ready');
        console.log('üìä Features: Upload, Analyse, Charts, PDF Export');
    </script>
</body>
</html>
