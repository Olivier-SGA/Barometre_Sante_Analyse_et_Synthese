<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barom√®tre Sant√© 2025 - Analyse Compl√®te</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .header h1 { color: #2d3748; font-size: 2.5rem; margin-bottom: 10px; }
        .header h2 { color: #667eea; font-size: 1.3rem; margin-bottom: 15px; }
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .upload-zone {
            border: 3px dashed #667eea;
            padding: 50px;
            text-align: center;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        .upload-zone:hover { border-color: #764ba2; background: #f0f4ff; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-danger { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); }
        .analysis-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border-left: 5px solid #667eea;
        }
        .stat-number { font-size: 2.5rem; font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .stat-label { color: #666; font-weight: 500; }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .file-list { margin-top: 20px; background: white; border-radius: 10px; padding: 20px; }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .file-item:last-child { border-bottom: none; }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analyseur Barom√®tre Sant√© 2025</h1>
            <h2>Cabinet Saint Germain Audit</h2>
            <p>Analyse compl√®te des r√©sultats avec export PDF d√©taill√©</p>
        </div>

        <div class="upload-section">
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <h3>üìÅ Importer les fichiers JSON</h3>
                <p>Cliquez ici pour s√©lectionner les fichiers de r√©ponses du barom√®tre</p>
                <input type="file" id="fileInput" multiple accept=".json" style="display: none;">
            </div>
            
            <div id="fileList" class="file-list" style="display: none;"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="analyzeBtn" class="btn" disabled onclick="analyzeData()">
                    Analyser les donn√©es
                </button>
                <button class="btn btn-danger" onclick="clearAll()">
                    Effacer tout
                </button>
            </div>
            
            <div id="alerts"></div>
        </div>

        <div class="analysis-section" id="analysisSection">
            <h2 style="text-align: center; margin-bottom: 30px;">R√©sultats de l'Analyse</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalResponses">0</div>
                    <div class="stat-label">R√©ponses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgHealth">0</div>
                    <div class="stat-label">Sant√© (/10)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stressCount">0</div>
                    <div class="stat-label">Stress (%)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="qvtGood">0</div>
                    <div class="stat-label">QVT Bonne (%)</div>
                </div>
            </div>

            <div class="charts-grid" id="chartsContainer"></div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn" onclick="exportDetailedPDF()">
                    üìÑ G√©n√©rer Rapport PDF D√©taill√©
                </button>
            </div>
        </div>
    </div>

    <script>
        let responses = [];
        let charts = {};
        let analysisData = {};

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application charg√©e');
            
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
        });

        function handleFileSelect(event) {
            console.log('Fichiers s√©lectionn√©s:', event.target.files.length);
            handleFiles(event.target.files);
        }

        function handleFiles(files) {
            responses = [];
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<h3>Traitement des fichiers...</h3>';
            fileList.style.display = 'block';

            let processed = 0;
            let valid = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log('Traitement fichier:', file.name);

                if (!file.name.endsWith('.json')) {
                    addFileStatus(file.name, 'Format non support√©', false);
                    processed++;
                    checkComplete();
                    continue;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        console.log('JSON pars√© pour', file.name, data);
                        
                        if (validateFile(data)) {
                            responses.push(data);
                            valid++;
                            addFileStatus(file.name, 'Charg√© avec succ√®s', true);
                        } else {
                            addFileStatus(file.name, 'Structure invalide', false);
                        }
                    } catch (error) {
                        console.error('Erreur JSON pour', file.name, error);
                        addFileStatus(file.name, 'Erreur JSON', false);
                    }
                    processed++;
                    checkComplete();
                };
                reader.readAsText(file);
            }

            function checkComplete() {
                if (processed === files.length) {
                    console.log('Traitement termin√©. Fichiers valides:', valid);
                    if (valid > 0) {
                        document.getElementById('analyzeBtn').disabled = false;
                        showAlert(valid + ' fichier(s) charg√©(s) avec succ√®s', 'success');
                    } else {
                        showAlert('Aucun fichier valide trouv√©', 'error');
                    }
                }
            }
        }

        function validateFile(data) {
            console.log('Validation fichier:', data);
            
            if (!data || typeof data !== 'object') {
                console.log('Pas un objet valide');
                return false;
            }

            if (!data.id) {
                console.log('Pas d ID');
                return false;
            }

            // Validation plus permissive - au moins une donn√©e du barom√®tre
            const hasData = data.profil || data.age || data.sante_physique || 
                           data.sante_psychologique || data.qvt || data.climat_social;

            if (!hasData) {
                console.log('Aucune donn√©e barom√®tre d√©tect√©e');
                return false;
            }

            console.log('Validation OK pour ID:', data.id);
            return true;
        }

        function addFileStatus(fileName, status, isValid) {
            const fileList = document.getElementById('fileList');
            const item = document.createElement('div');
            item.className = 'file-item';
            const icon = isValid ? '‚úÖ' : '‚ùå';
            item.innerHTML = '<span>üìÑ ' + fileName + '</span><span>' + icon + ' ' + status + '</span>';
            fileList.appendChild(item);
        }

        function analyzeData() {
            console.log('D√©but analyse avec', responses.length, 'r√©ponses');
            
            if (responses.length === 0) {
                showAlert('Aucune donn√©e √† analyser', 'error');
                return;
            }

            try {
                calculateStats();
                createCharts();
                document.getElementById('analysisSection').style.display = 'block';
                showAlert('Analyse termin√©e avec succ√®s', 'success');
            } catch (error) {
                console.error('Erreur analyse:', error);
                showAlert('Erreur analyse: ' + error.message, 'error');
            }
        }

        function calculateStats() {
            const total = responses.length;
            
            // Sant√© moyenne
            let healthSum = 0;
            let healthCount = 0;
            responses.forEach(function(r) {
                if (r.sante_physique) {
                    healthSum += parseInt(r.sante_physique);
                    healthCount++;
                }
                if (r.sante_psychologique) {
                    healthSum += parseInt(r.sante_psychologique);
                    healthCount++;
                }
            });
            const avgHealth = healthCount > 0 ? healthSum / healthCount : 0;

            // Stress
            let stressCount = 0;
            responses.forEach(function(r) {
                if (r.sources_stress && Array.isArray(r.sources_stress)) {
                    const hasStress = r.sources_stress.some(function(s) { return s !== 'pas_stresse'; });
                    if (hasStress) stressCount++;
                }
            });
            const stressPercent = (stressCount / total) * 100;

            // QVT bonne
            let qvtGoodCount = 0;
            responses.forEach(function(r) {
                if (r.qvt === 'excellente' || r.qvt === 'bonne') {
                    qvtGoodCount++;
                }
            });
            const qvtGoodPercent = (qvtGoodCount / total) * 100;

            // Mise √† jour interface
            document.getElementById('totalResponses').textContent = total;
            document.getElementById('avgHealth').textContent = avgHealth.toFixed(1);
            document.getElementById('stressCount').textContent = Math.round(stressPercent) + '%';
            document.getElementById('qvtGood').textContent = Math.round(qvtGoodPercent) + '%';

            // Stockage pour PDF
            analysisData = {
                total: total,
                avgHealth: avgHealth,
                stressPercent: stressPercent,
                qvtGoodPercent: qvtGoodPercent,
                profiles: getProfileData(),
                stress: getStressData(),
                qvt: getQVTData(),
                workload: getWorkloadData(),
                health: getHealthData()
            };
        }

        function getProfileData() {
            const counts = {};
            responses.forEach(function(r) {
                if (r.profil) counts[r.profil] = (counts[r.profil] || 0) + 1;
            });
            return counts;
        }

        function getStressData() {
            const sources = {};
            responses.forEach(function(r) {
                if (r.sources_stress && Array.isArray(r.sources_stress)) {
                    r.sources_stress.forEach(function(s) {
                        if (s !== 'pas_stresse') sources[s] = (sources[s] || 0) + 1;
                    });
                }
            });
            return sources;
        }

        function getQVTData() {
            const counts = {};
            responses.forEach(function(r) {
                if (r.qvt) counts[r.qvt] = (counts[r.qvt] || 0) + 1;
            });
            return counts;
        }

        function getWorkloadData() {
            const pressure = {};
            responses.forEach(function(r) {
                if (r.pression_echeances) pressure[r.pression_echeances] = (pressure[r.pression_echeances] || 0) + 1;
            });
            return { pressure: pressure };
        }

        function getHealthData() {
            let physSum = 0, physCount = 0, psychoSum = 0, psychoCount = 0;
            responses.forEach(function(r) {
                if (r.sante_physique) { physSum += parseInt(r.sante_physique); physCount++; }
                if (r.sante_psychologique) { psychoSum += parseInt(r.sante_psychologique); psychoCount++; }
            });
            return {
                physique: physCount > 0 ? physSum / physCount : 0,
                psychologique: psychoCount > 0 ? psychoSum / psychoCount : 0
            };
        }

        function createCharts() {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';
            
            // Nettoyer les graphiques existants
            Object.keys(charts).forEach(function(key) {
                if (charts[key]) charts[key].destroy();
            });
            charts = {};

            // Cr√©er les graphiques principaux
            createChart('Profils Professionnels', 'pie', analysisData.profiles);
            createChart('Sources de Stress', 'bar', analysisData.stress);
            createChart('Qualit√© de Vie au Travail', 'doughnut', analysisData.qvt);
            createChart('Notes de Sant√©', 'bar', analysisData.health, true);
        }

        function createChart(title, type, data, isHealthChart = false) {
            const container = document.getElementById('chartsContainer');
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'chart-title';
            titleDiv.textContent = title;
            
            const canvas = document.createElement('canvas');
            const chartId = 'chart_' + Date.now() + Math.random().toString(36).substr(2, 5);
            canvas.id = chartId;
            
            chartDiv.appendChild(titleDiv);
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);

            const ctx = canvas.getContext('2d');

            let chartData;
            if (isHealthChart) {
                chartData = {
                    labels: ['Sant√© Physique', 'Sant√© Psychologique'],
                    datasets: [{
                        label: 'Note /10',
                        data: [data.physique, data.psychologique],
                        backgroundColor: ['#48bb78', '#667eea']
                    }]
                };
            } else {
                const labels = [];
                const values = [];
                const labelMaps = {
                    'Profils Professionnels': {
                        'auditeur': 'Auditeur',
                        'chef_mission': 'Chef mission',
                        'directeur_mission': 'Directeur'
                    },
                    'Sources de Stress': {
                        'gestion_clients': 'Clients',
                        'tenue_delais': 'D√©lais',
                        'pression_hierarchique': 'Hi√©rarchie'
                    },
                    'Qualit√© de Vie au Travail': {
                        'excellente': 'Excellente',
                        'bonne': 'Bonne',
                        'correcte': 'Correcte',
                        'decevante': 'D√©cevante',
                        'nocive': 'Nocive'
                    }
                };

                const labelMap = labelMaps[title] || {};
                for (let key in data) {
                    labels.push(labelMap[key] || key);
                    values.push(data[key]);
                }

                chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre',
                        data: values,
                        backgroundColor: ['#667eea', '#764ba2', '#48bb78', '#ed8936', '#f56565']
                    }]
                };
            }

            charts[chartId] = new Chart(ctx, {
                type: type,
                data: chartData,
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function exportDetailedPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let y = 30;
                const margin = 20;

                // En-t√™te
                doc.setFontSize(24);
                doc.text('BAROMETRE SANTE 2025', doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
                y += 15;
                
                doc.setFontSize(16);
                doc.text('Cabinet Saint Germain Audit', doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
                y += 20;

                // Synth√®se
                doc.setFontSize(18);
                doc.text('SYNTHESE GLOBALE', margin, y);
                y += 15;

                doc.setFontSize(12);
                const stats = [
                    'Nombre de repondants : ' + analysisData.total,
                    'Note sante moyenne : ' + analysisData.avgHealth.toFixed(1) + '/10',
                    'Collaborateurs stresses : ' + Math.round(analysisData.stressPercent) + '%',
                    'QVT bonne/excellente : ' + Math.round(analysisData.qvtGoodPercent) + '%'
                ];

                stats.forEach(function(stat) {
                    doc.text('‚Ä¢ ' + stat, margin, y);
                    y += 8;
                });

                y += 20;

                // D√©tail par question
                doc.setFontSize(16);
                doc.text('DETAIL PAR QUESTION', margin, y);
                y += 15;

                // Profils
                y = addDetailedAnalysis(doc, 'Profils professionnels', analysisData.profiles, {
                    'auditeur': 'Auditeur/Auditrice',
                    'chef_mission': 'Chef de mission',
                    'directeur_mission': 'Directeur de mission'
                }, y, margin);

                // QVT
                y = addDetailedAnalysis(doc, 'Qualite de vie au travail', analysisData.qvt, {
                    'excellente': 'Excellente',
                    'bonne': 'Bonne',
                    'correcte': 'Correcte',
                    'decevante': 'Decevante',
                    'nocive': 'Nocive'
                }, y, margin);

                // Sources de stress
                y = addDetailedAnalysis(doc, 'Sources de stress principales', analysisData.stress, {
                    'gestion_clients': 'Gestion des clients',
                    'tenue_delais': 'Respect des delais',
                    'pression_hierarchique': 'Pression hierarchique',
                    'complexite_dossiers': 'Complexite des dossiers'
                }, y, margin);

                // Sauvegarde
                const fileName = 'Barometre_Sante_2025_' + new Date().toISOString().slice(0, 10) + '.pdf';
                doc.save(fileName);
                
                showAlert('PDF genere : ' + fileName, 'success');
            } catch (error) {
                console.error('Erreur PDF:', error);
                showAlert('Erreur PDF : ' + error.message, 'error');
            }
        }

        function addDetailedAnalysis(doc, title, data, labels, y, margin) {
            if (y > 250) {
                doc.addPage();
                y = 30;
            }

            doc.setFontSize(14);
            doc.text(title + ' :', margin, y);
            y += 10;

            const total = Object.values(data).reduce(function(sum, val) { return sum + val; }, 0);

            doc.setFontSize(10);
            for (let key in data) {
                const count = data[key];
                const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                const label = labels[key] || key;
                doc.text('‚Ä¢ ' + label + ' : ' + count + ' (' + percent + '%)', margin + 5, y);
                y += 6;
            }
            
            return y + 10;
        }

        function clearAll() {
            responses = [];
            analysisData = {};
            document.getElementById('fileList').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('alerts').innerHTML = '';
            document.getElementById('chartsContainer').innerHTML = '';
            
            Object.keys(charts).forEach(function(key) {
                if (charts[key]) charts[key].destroy();
            });
            charts = {};
            
            showAlert('Donnees effacees', 'info');
        }

        function showAlert(message, type) {
            const container = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = 'alert alert-' + type;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(function() {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
