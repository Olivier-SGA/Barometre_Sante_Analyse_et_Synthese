<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baromètre Santé 2025 - Analyse Complète</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .header {
            background: rgba(255, 255, 255, 0.98);
            padding: 40px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .header h1 { 
            color: #1a365d; 
            font-size: 3rem; 
            margin-bottom: 15px;
            font-weight: 700;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header h2 { 
            color: #2d5aa0; 
            font-size: 1.4rem; 
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .header p {
            color: #4a5568;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 35px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(10px);
        }
        
        .upload-zone {
            border: 3px dashed #4299e1;
            padding: 60px 30px;
            text-align: center;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.4s ease;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            position: relative;
            overflow: hidden;
        }
        
        .upload-zone:hover { 
            border-color: #2b6cb0; 
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(66, 153, 225, 0.15);
        }
        
        .upload-zone h3 {
            font-size: 1.6rem;
            color: #2d3748;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .upload-zone p {
            color: #4a5568;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #4299e1 0%, #2b6cb0 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            margin: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover { 
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.4);
        }
        
        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }
        
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
        }
        
        .analysis-section {
            background: rgba(255, 255, 255, 0.97);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
            display: none;
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            text-align: center;
            font-size: 2.2rem;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 40px;
            position: relative;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, #4299e1, #2b6cb0);
            border-radius: 2px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 30px 25px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid transparent;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #4299e1, #2b6cb0, #1e3c72);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            border-color: #4299e1;
        }
        
        .stat-number { 
            font-size: 3rem; 
            font-weight: 800; 
            background: linear-gradient(135deg, #1e3c72, #2b6cb0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            line-height: 1;
        }
        
        .stat-label { 
            color: #4a5568; 
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(520px, 1fr));
            gap: 35px;
            margin-bottom: 50px;
        }
        
        .chart-container {
            background: #ffffff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-5px);
        }
        
        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 25px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 3px solid #e2e8f0;
            position: relative;
        }
        
        .chart-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #4299e1, #2b6cb0);
        }
        
        .file-list { 
            margin-top: 25px; 
            background: #ffffff; 
            border-radius: 16px; 
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 500;
        }
        
        .file-item:last-child { 
            border-bottom: none; 
        }
        
        .alert {
            padding: 18px 24px;
            margin: 20px 0;
            border-radius: 12px;
            font-weight: 500;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .alert-success { 
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); 
            border: 2px solid #68d391; 
            color: #1a202c; 
        }
        
        .alert-error { 
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%); 
            border: 2px solid #f56565; 
            color: #1a202c; 
        }
        
        .alert-info { 
            background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%); 
            border: 2px solid #4299e1; 
            color: #1a202c; 
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #4299e1;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #2b6cb0);
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        
        @media (max-width: 768px) {
            .charts-grid { 
                grid-template-columns: 1fr; 
            }
            .stats-grid { 
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            }
            .header h1 { 
                font-size: 2.2rem; 
            }
            .btn {
                padding: 14px 24px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 Baromètre Santé 2025</h1>
            <h2>Cabinet Saint Germain Audit</h2>
            <p>Analyse complète et professionnelle des résultats avec export PDF détaillé</p>
        </div>

        <div class="upload-section">
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <h3>📊 Importer les fichiers JSON</h3>
                <p>Cliquez ici ou glissez-déposez vos fichiers de réponses du baromètre</p>
                <p style="font-size: 0.9rem; color: #718096;">Formats acceptés: .json uniquement</p>
                <input type="file" id="fileInput" multiple accept=".json" style="display: none;">
            </div>
            
            <div id="progressSection" style="display: none;">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <p id="progressText" style="text-align: center; color: #4a5568;">Traitement en cours...</p>
            </div>
            
            <div id="fileList" class="file-list" style="display: none;"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="analyzeBtn" class="btn" disabled onclick="analyzeData()">
                    <span id="analyzeText">🔍 Analyser les données</span>
                </button>
                <button class="btn btn-danger" onclick="clearAll()">
                    🗑️ Tout effacer
                </button>
            </div>
            
            <div id="alerts"></div>
        </div>

        <div class="analysis-section" id="analysisSection">
            <h2 class="section-title">📈 Résultats de l'Analyse</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalResponses">0</div>
                    <div class="stat-label">Répondants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgHealthPhys">0</div>
                    <div class="stat-label">Santé Physique (/10)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgHealthPsych">0</div>
                    <div class="stat-label">Santé Psychologique (/10)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stressCount">0%</div>
                    <div class="stat-label">Personnes Stressées</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="qvtGood">0%</div>
                    <div class="stat-label">QVT Satisfaisante</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="burnoutRisk">0%</div>
                    <div class="stat-label">Risque Burnout</div>
                </div>
            </div>

            <div class="charts-grid" id="chartsContainer"></div>

            <div style="text-align: center; margin-top: 50px;">
                <button class="btn" onclick="exportDetailedPDF()" style="font-size: 1.2rem; padding: 20px 40px;">
                    📄 Générer Rapport PDF Complet
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let responses = [];
        let charts = {};
        let analysisData = {};

        // Configuration des couleurs professionnelles
        const colorPalette = {
            primary: ['#1e3c72', '#2a5298', '#4299e1', '#63b3ed', '#90cdf4'],
            success: ['#38a169', '#48bb78', '#68d391', '#9ae6b4', '#c6f6d5'],
            warning: ['#d69e2e', '#ed8936', '#f6ad55', '#fbb6ce', '#fed7d7'],
            danger: ['#e53e3e', '#f56565', '#fc8181', '#feb2b2', '#fed7d7'],
            neutral: ['#2d3748', '#4a5568', '#718096', '#a0aec0', '#cbd5e0']
        };

        // Labels français pour les graphiques
        const frenchLabels = {
            profils: {
                'auditeur': 'Auditeur/Auditrice',
                'chef_mission': 'Chef de mission',
                'directeur_mission': 'Directeur de mission',
                'manager': 'Manager',
                'senior': 'Senior',
                'junior': 'Junior'
            },
            qvt: {
                'excellente': 'Excellente',
                'bonne': 'Bonne',
                'correcte': 'Correcte',
                'moyenne': 'Moyenne',
                'decevante': 'Décevante',
                'mauvaise': 'Mauvaise',
                'nocive': 'Nocive'
            },
            stress: {
                'gestion_clients': 'Gestion des clients',
                'tenue_delais': 'Respect des délais',
                'pression_hierarchique': 'Pression hiérarchique',
                'complexite_dossiers': 'Complexité des dossiers',
                'charge_travail': 'Charge de travail',
                'manque_reconnaissance': 'Manque de reconnaissance',
                'equilibre_vie': 'Équilibre vie pro/perso',
                'pas_stresse': 'Pas stressé',
                'aucun': 'Aucun stress'
            },
            ages: {
                '20-25': '20-25 ans',
                '26-30': '26-30 ans',
                '31-35': '31-35 ans',
                '36-40': '36-40 ans',
                '41-45': '41-45 ans',
                '46-50': '46-50 ans',
                '51+': '51+ ans'
            }
        };

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Application Baromètre Santé chargée');
            
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }

            // Support du drag & drop
            const uploadZone = document.querySelector('.upload-zone');
            if (uploadZone) {
                uploadZone.addEventListener('dragover', handleDragOver);
                uploadZone.addEventListener('drop', handleDrop);
                uploadZone.addEventListener('dragleave', handleDragLeave);
            }
        });

        // Gestion du drag & drop
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#2b6cb0';
            event.currentTarget.style.backgroundColor = '#e6fffa';
        }

        function handleDragLeave(event) {
            event.currentTarget.style.borderColor = '#4299e1';
            event.currentTarget.style.backgroundColor = '';
        }

        function handleDrop(event) {
            event.preventDefault();
            handleDragLeave(event);
            const files = event.dataTransfer.files;
            handleFiles(files);
        }

        // Gestion de la sélection de fichiers
        function handleFileSelect(event) {
            console.log('📁 Fichiers sélectionnés:', event.target.files.length);
            handleFiles(event.target.files);
        }

        // Traitement des fichiers
        function handleFiles(files) {
            if (files.length === 0) return;
            
            responses = [];
            showProgressSection();
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<h3 style="color: #2d3748; margin-bottom: 20px;">📋 Traitement des fichiers...</h3>';
            fileList.style.display = 'block';

            let processed = 0;
            let valid = 0;
            const total = files.length;

            Array.from(files).forEach((file, index) => {
                console.log(`📄 Traitement fichier ${index + 1}/${total}:`, file.name);

                if (!file.name.toLowerCase().endsWith('.json')) {
                    addFileStatus(file.name, 'Format non supporté (.json requis)', false);
                    processed++;
                    updateProgress(processed, total);
                    checkComplete();
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        console.log('✅ JSON parsé pour', file.name);
                        
                        if (validateAndCleanData(data)) {
                            responses.push(data);
                            valid++;
                            addFileStatus(file.name, `✅ Chargé avec succès (ID: ${data.id})`, true);
                        } else {
                            addFileStatus(file.name, '❌ Structure de données invalide', false);
                        }
                    } catch (error) {
                        console.error('❌ Erreur JSON pour', file.name, error);
                        addFileStatus(file.name, '❌ Fichier JSON corrompu', false);
                    }
                    processed++;
                    updateProgress(processed, total);
                    checkComplete();
                };
                
                reader.onerror = function() {
                    addFileStatus(file.name, '❌ Erreur de lecture', false);
                    processed++;
                    updateProgress(processed, total);
                    checkComplete();
                };
                
                reader.readAsText(file, 'UTF-8');
            });

            function updateProgress(current, total) {
                const percent = (current / total) * 100;
                document.getElementById('progressFill').style.width = percent + '%';
                document.getElementById('progressText').textContent = 
                    `Traitement ${current}/${total} fichiers (${Math.round(percent)}%)`;
            }

            function checkComplete() {
                if (processed === total) {
                    hideProgressSection();
                    console.log('✅ Traitement terminé. Fichiers valides:', valid, '/', total);
                    
                    if (valid > 0) {
                        document.getElementById('analyzeBtn').disabled = false;
                        showAlert(`🎉 ${valid} fichier(s) chargé(s) avec succès sur ${total}`, 'success');
                        
                        // Pré-validation des données
                        const validationResult = validateDataIntegrity();
                        if (validationResult.warnings.length > 0) {
                            showAlert('⚠️ ' + validationResult.warnings.join(', '), 'info');
                        }
                    } else {
                        showAlert('❌ Aucun fichier valide trouvé. Vérifiez le format JSON et la structure des données.', 'error');
                    }
                }
            }
        }

        // Validation et nettoyage des données
        function validateAndCleanData(data) {
            if (!data || typeof data !== 'object') {
                return false;
            }

            // L'ID est obligatoire
            if (!data.id) {
                return false;
            }

            // Nettoyage et validation des champs essentiels
            const essentialFields = [
                'profil', 'age', 'sante_physique', 'sante_psychologique', 
                'qvt', 'climat_social', 'sources_stress', 'charge_travail',
                'pression_echeances', 'reconnaissance', 'equilibre_vie'
            ];

            let hasEssentialData = false;
            essentialFields.forEach(field => {
                if (data[field] !== undefined && data[field] !== null && data[field] !== '') {
                    hasEssentialData = true;
                    
                    // Nettoyage des données numériques
                    if (['sante_physique', 'sante_psychologique', 'age'].includes(field)) {
                        const num = parseFloat(data[field]);
                        if (!isNaN(num)) {
                            data[field] = num;
                        }
                    }
                    
                    // Nettoyage des chaînes
                    if (typeof data[field] === 'string') {
                        data[field] = data[field].trim().toLowerCase();
                    }
                }
            });

            return hasEssentialData;
        }

        // Validation de l'intégrité des données
        function validateDataIntegrity() {
            const warnings = [];
            let totalFields = 0;
            let missingFields = 0;
            
            const expectedFields = [
                'profil', 'age', 'sante_physique', 'sante_psychologique', 
                'qvt', 'sources_stress', 'charge_travail'
            ];
            
            responses.forEach(response => {
                expectedFields.forEach(field => {
                    totalFields++;
                    if (!response[field] || response[field] === '') {
                        missingFields++;
                    }
                });
            });
            
            const missingPercent = (missingFields / totalFields) * 100;
            if (missingPercent > 20) {
                warnings.push(`${Math.round(missingPercent)}% de données manquantes détectées`);
            }
            
            return { warnings };
        }

        // Ajout du statut des fichiers
        function addFileStatus(fileName, status, isValid) {
            const fileList = document.getElementById('fileList');
            const item = document.createElement('div');
            item.className = 'file-item';
            
            const fileInfo = document.createElement('span');
            fileInfo.style.fontWeight = '600';
            fileInfo.textContent = `📄 ${fileName}`;
            
            const statusInfo = document.createElement('span');
            statusInfo.style.color = isValid ? '#38a169' : '#e53e3e';
            statusInfo.style.fontWeight = '600';
            statusInfo.textContent = status;
            
            item.appendChild(fileInfo);
            item.appendChild(statusInfo);
            fileList.appendChild(item);
        }

        // Gestion de la barre de progression
        function showProgressSection() {
            document.getElementById('progressSection').style.display = 'block';
        }

        function hideProgressSection() {
            setTimeout(() => {
                document.getElementById('progressSection').style.display = 'none';
            }, 1000);
        }

        // Analyse des données
        function analyzeData() {
            console.log('🔄 Début analyse avec', responses.length, 'réponses');
            
            if (responses.length === 0) {
                showAlert('❌ Aucune donnée à analyser', 'error');
                return;
            }

            // Animation du bouton
            const btn = document.getElementById('analyzeBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Analyse en cours...';
            btn.disabled = true;

            try {
                // Délai pour l'animation
                setTimeout(() => {
                    calculateComprehensiveStats();
                    createAllCharts();
                    document.getElementById('analysisSection').style.display = 'block';
                    document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    
                    showAlert('🎉 Analyse terminée avec succès !', 'success');
                }, 500);
                
            } catch (error) {
                console.error('❌ Erreur analyse:', error);
                showAlert('❌ Erreur lors de l\'analyse: ' + error.message, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Calcul des statistiques complètes
        function calculateComprehensiveStats() {
            const total = responses.length;
            
            // Santé physique et psychologique séparées
            let physSum = 0, physCount = 0;
            let psychoSum = 0, psychoCount = 0;
            
            responses.forEach(r => {
                if (r.sante_physique && !isNaN(r.sante_physique)) {
                    physSum += parseFloat(r.sante_physique);
                    physCount++;
                }
                if (r.sante_psychologique && !isNaN(r.sante_psychologique)) {
                    psychoSum += parseFloat(r.sante_psychologique);
                    psychoCount++;
                }
            });

            const avgHealthPhys = physCount > 0 ? physSum / physCount : 0;
            const avgHealthPsych = psychoCount > 0 ? psychoSum / psychoCount : 0;

            // Calcul du stress
            let stressCount = 0;
            responses.forEach(r => {
                if (r.sources_stress) {
                    if (Array.isArray(r.sources_stress)) {
                        const hasStress = r.sources_stress.some(s => s !== 'pas_stresse' && s !== 'aucun' && s !== '');
                        if (hasStress && r.sources_stress.length > 0) stressCount++;
                    } else if (typeof r.sources_stress === 'string' && 
                              r.sources_stress !== 'pas_stresse' && 
                              r.sources_stress !== 'aucun' && 
                              r.sources_stress !== '') {
                        stressCount++;
                    }
                }
            });

            // QVT satisfaisante (bonne + excellente)
            let qvtGoodCount = 0;
            responses.forEach(r => {
                if (r.qvt === 'excellente' || r.qvt === 'bonne') {
                    qvtGoodCount++;
                }
            });

            // Risque de burnout (combinaison de facteurs)
            let burnoutRiskCount = 0;
            responses.forEach(r => {
                const lowHealth = (r.sante_psychologique && parseFloat(r.sante_psychologique) < 5);
                const highStress = r.sources_stress && (
                    Array.isArray(r.sources_stress) ? r.sources_stress.length > 2 : 
                    (r.sources_stress !== 'pas_stresse' && r.sources_stress !== 'aucun')
                );
                const poorQVT = r.qvt === 'decevante' || r.qvt === 'mauvaise' || r.qvt === 'nocive';
                
                if ((lowHealth && highStress) || (lowHealth && poorQVT) || (highStress && poorQVT)) {
                    burnoutRiskCount++;
                }
            });

            // Mise à jour de l'interface
            document.getElementById('totalResponses').textContent = total;
            document.getElementById('avgHealthPhys').textContent = avgHealthPhys.toFixed(1);
            document.getElementById('avgHealthPsych').textContent = avgHealthPsych.toFixed(1);
            document.getElementById('stressCount').textContent = Math.round((stressCount / total) * 100) + '%';
            document.getElementById('qvtGood').textContent = Math.round((qvtGoodCount / total) * 100) + '%';
            document.getElementById('burnoutRisk').textContent = Math.round((burnoutRiskCount / total) * 100) + '%';

            // Stockage des données pour l'export PDF
            analysisData = {
                total: total,
                avgHealthPhys: avgHealthPhys,
                avgHealthPsych: avgHealthPsych,
                stressPercent: (stressCount / total) * 100,
                qvtGoodPercent: (qvtGoodCount / total) * 100,
                burnoutPercent: (burnoutRiskCount / total) * 100,
                profiles: getProfileData(),
                stress: getStressData(),
                qvt: getQVTData(),
                ages: getAgeData(),
                health: {
                    physique: avgHealthPhys,
                    psychologique: avgHealthPsych
                },
                workload: getWorkloadData()
            };

            console.log('📊 Données analysées:', analysisData);
        }

        // Collecte des données par profil
        function getProfileData() {
            const counts = {};
            responses.forEach(r => {
                if (r.profil && r.profil !== '') {
                    const profil = r.profil.toLowerCase().trim();
                    counts[profil] = (counts[profil] || 0) + 1;
                }
            });
            return counts;
        }

        // Collecte des données de stress
        function getStressData() {
            const sources = {};
            responses.forEach(r => {
                if (r.sources_stress) {
                    if (Array.isArray(r.sources_stress)) {
                        r.sources_stress.forEach(s => {
                            if (s && s !== 'pas_stresse' && s !== 'aucun' && s !== '') {
                                const stress = s.toLowerCase().trim();
                                sources[stress] = (sources[stress] || 0) + 1;
                            }
                        });
                    } else if (typeof r.sources_stress === 'string' && 
                              r.sources_stress !== 'pas_stresse' && 
                              r.sources_stress !== 'aucun' && 
                              r.sources_stress !== '') {
                        const stress = r.sources_stress.toLowerCase().trim();
                        sources[stress] = (sources[stress] || 0) + 1;
                    }
                }
            });
            return sources;
        }

        // Collecte des données QVT
        function getQVTData() {
            const counts = {};
            responses.forEach(r => {
                if (r.qvt && r.qvt !== '') {
                    const qvt = r.qvt.toLowerCase().trim();
                    counts[qvt] = (counts[qvt] || 0) + 1;
                }
            });
            return counts;
        }

        // Collecte des données d'âge
        function getAgeData() {
            const counts = {};
            responses.forEach(r => {
                if (r.age) {
                    let ageGroup;
                    const age = typeof r.age === 'number' ? r.age : parseInt(r.age);
                    
                    if (!isNaN(age)) {
                        if (age <= 25) ageGroup = '20-25';
                        else if (age <= 30) ageGroup = '26-30';
                        else if (age <= 35) ageGroup = '31-35';
                        else if (age <= 40) ageGroup = '36-40';
                        else if (age <= 45) ageGroup = '41-45';
                        else if (age <= 50) ageGroup = '46-50';
                        else ageGroup = '51+';
                        
                        counts[ageGroup] = (counts[ageGroup] || 0) + 1;
                    } else if (typeof r.age === 'string') {
                        const ageStr = r.age.toLowerCase().trim();
                        counts[ageStr] = (counts[ageStr] || 0) + 1;
                    }
                }
            });
            return counts;
        }

        // Collecte des données de charge de travail
        function getWorkloadData() {
            const pressure = {};
            const workload = {};
            
            responses.forEach(r => {
                if (r.pression_echeances && r.pression_echeances !== '') {
                    const pression = r.pression_echeances.toLowerCase().trim();
                    pressure[pression] = (pressure[pression] || 0) + 1;
                }
                
                if (r.charge_travail && r.charge_travail !== '') {
                    const charge = r.charge_travail.toLowerCase().trim();
                    workload[charge] = (workload[charge] || 0) + 1;
                }
            });
            
            return { pressure, workload };
        }

        // Création de tous les graphiques
        function createAllCharts() {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';
            
            // Nettoyer les graphiques existants
            Object.keys(charts).forEach(key => {
                if (charts[key]) {
                    charts[key].destroy();
                }
            });
            charts = {};

            // Créer les graphiques
            if (Object.keys(analysisData.profiles).length > 0) {
                createChart('Répartition des Profils Professionnels', 'doughnut', analysisData.profiles, 'profils');
            }

            if (Object.keys(analysisData.qvt).length > 0) {
                createChart('Qualité de Vie au Travail', 'pie', analysisData.qvt, 'qvt');
            }

            if (Object.keys(analysisData.stress).length > 0) {
                createChart('Sources de Stress Principales', 'bar', analysisData.stress, 'stress');
            }

            if (Object.keys(analysisData.ages).length > 0) {
                createChart('Répartition par Tranches d\'Âge', 'bar', analysisData.ages, 'ages');
            }

            // Graphique des notes de santé
            createHealthChart();

            // Graphique de la charge de travail si disponible
            if (analysisData.workload.pressure && Object.keys(analysisData.workload.pressure).length > 0) {
                createChart('Pression des Échéances', 'horizontalBar', analysisData.workload.pressure);
            }
        }

        // Création d'un graphique
        function createChart(title, type, data, labelType = null) {
            const container = document.getElementById('chartsContainer');
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'chart-title';
            titleDiv.textContent = title;
            
            const canvas = document.createElement('canvas');
            const chartId = 'chart_' + Date.now() + Math.random().toString(36).substr(2, 5);
            canvas.id = chartId;
            
            chartDiv.appendChild(titleDiv);
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);

            const ctx = canvas.getContext('2d');

            // Préparation des données
            const labels = [];
            const values = [];
            const colors = [];

            Object.entries(data).forEach(([key, value], index) => {
                // Utiliser les labels français si disponibles
                const friendlyLabel = labelType && frenchLabels[labelType] && frenchLabels[labelType][key] 
                    ? frenchLabels[labelType][key] 
                    : key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                
                labels.push(friendlyLabel);
                values.push(value);
                colors.push(colorPalette.primary[index % colorPalette.primary.length]);
            });

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Nombre de réponses',
                    data: values,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color + '80'),
                    borderWidth: 2,
                    hoverOffset: 4
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: '#4299e1',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            };

            // Options spécifiques selon le type de graphique
            if (type === 'bar' || type === 'horizontalBar') {
                options.scales = {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                };
            }

            canvas.height = 300;

            charts[chartId] = new Chart(ctx, {
                type: type === 'horizontalBar' ? 'bar' : type,
                data: chartData,
                options: options
            });
        }

        // Création du graphique de santé
        function createHealthChart() {
            const container = document.getElementById('chartsContainer');
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'chart-title';
            titleDiv.textContent = 'Notes Moyennes de Santé';
            
            const canvas = document.createElement('canvas');
            const chartId = 'health_chart_' + Date.now();
            canvas.id = chartId;
            
            chartDiv.appendChild(titleDiv);
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);

            const ctx = canvas.getContext('2d');

            const chartData = {
                labels: ['Santé Physique', 'Santé Psychologique'],
                datasets: [{
                    label: 'Note moyenne (/10)',
                    data: [analysisData.avgHealthPhys, analysisData.avgHealthPsych],
                    backgroundColor: ['#48bb78', '#4299e1'],
                    borderColor: ['#38a169', '#2b6cb0'],
                    borderWidth: 2
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed.toFixed(1)}/10`;
                            }
                        }
                    }
                }
            };

            canvas.height = 300;

            charts[chartId] = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: options
            });
        }

        // Export PDF détaillé
        function exportDetailedPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let y = 20;
                const margin = 20;
                const pageHeight = doc.internal.pageSize.getHeight();

                // Fonction pour ajouter une nouvelle page si nécessaire
                function checkNewPage(additionalHeight = 30) {
                    if (y + additionalHeight > pageHeight - 20) {
                        doc.addPage();
                        y = 30;
                        return true;
                    }
                    return false;
                }

                // En-tête du rapport
                doc.setFontSize(22);
                doc.setTextColor(30, 58, 114);
                doc.text('BAROMÈTRE SANTÉ 2025', doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
                y += 15;
                
                doc.setFontSize(14);
                doc.setTextColor(45, 90, 160);
                doc.text('Cabinet Saint Germain Audit', doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
                y += 10;
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('Rapport généré le ' + new Date().toLocaleDateString('fr-FR'), doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
                y += 25;

                // Ligne de séparation
                doc.setDrawColor(66, 153, 225);
                doc.setLineWidth(1);
                doc.line(margin, y, doc.internal.pageSize.getWidth() - margin, y);
                y += 20;

                // Synthèse exécutive
                checkNewPage(60);
                doc.setFontSize(16);
                doc.setTextColor(26, 54, 93);
                doc.text('📊 SYNTHÈSE EXÉCUTIVE', margin, y);
                y += 15;

                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);
                
                const synthese = [
                    `Nombre total de répondants : ${analysisData.total}`,
                    `Note santé physique moyenne : ${analysisData.avgHealthPhys.toFixed(1)}/10`,
                    `Note santé psychologique moyenne : ${analysisData.avgHealthPsych.toFixed(1)}/10`,
                    `Pourcentage de collaborateurs stressés : ${Math.round(analysisData.stressPercent)}%`,
                    `QVT jugée satisfaisante (bonne/excellente) : ${Math.round(analysisData.qvtGoodPercent)}%`,
                    `Collaborateurs à risque de burnout : ${Math.round(analysisData.burnoutPercent)}%`
                ];

                synthese.forEach(line => {
                    doc.text('• ' + line, margin + 5, y);
                    y += 8;
                });

                y += 10;

                // Analyse détaillée par section
                const sections = [
                    { title: '👥 PROFILS PROFESSIONNELS', data: analysisData.profiles, labelType: 'profils' },
                    { title: '💼 QUALITÉ DE VIE AU TRAVAIL', data: analysisData.qvt, labelType: 'qvt' },
                    { title: '⚡ SOURCES DE STRESS', data: analysisData.stress, labelType: 'stress' },
                    { title: '📅 RÉPARTITION PAR ÂGE', data: analysisData.ages, labelType: 'ages' }
                ];

                sections.forEach(section => {
                    if (Object.keys(section.data).length === 0) return;

                    checkNewPage(50);
                    
                    doc.setFontSize(14);
                    doc.setTextColor(26, 54, 93);
                    doc.text(section.title, margin, y);
                    y += 12;

                    doc.setFontSize(10);
                    doc.setTextColor(60, 60, 60);

                    const total = Object.values(section.data).reduce((sum, val) => sum + val, 0);

                    Object.entries(section.data)
                        .sort(([,a], [,b]) => b - a) // Tri par nombre décroissant
                        .forEach(([key, count]) => {
                            const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                            const label = section.labelType && frenchLabels[section.labelType] && frenchLabels[section.labelType][key] 
                                ? frenchLabels[section.labelType][key] 
                                : key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                            
                            checkNewPage(8);
                            doc.text(`• ${label}: ${count} réponses (${percent}%)`, margin + 5, y);
                            y += 7;
                        });

                    y += 10;
                });

                // Recommandations
                checkNewPage(80);
                doc.setFontSize(16);
                doc.setTextColor(26, 54, 93);
                doc.text('💡 RECOMMANDATIONS', margin, y);
                y += 15;

                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);

                const recommendations = generateRecommendations();
                recommendations.forEach(rec => {
                    checkNewPage(15);
                    const lines = doc.splitTextToSize('• ' + rec, doc.internal.pageSize.getWidth() - 2 * margin - 10);
                    lines.forEach(line => {
                        doc.text(line, margin + 5, y);
                        y += 7;
                    });
                    y += 3;
                });

                // Pied de page sur chaque page
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(
                        `Cabinet Saint Germain Audit - Baromètre Santé 2025 - Page ${i}/${totalPages}`,
                        doc.internal.pageSize.getWidth() / 2,
                        doc.internal.pageSize.getHeight() - 10,
                        { align: 'center' }
                    );
                }

                // Sauvegarde
                const fileName = `Barometre_Sante_2025_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(fileName);
                
                showAlert(`📄 Rapport PDF généré avec succès : ${fileName}`, 'success');
            } catch (error) {
                console.error('❌ Erreur génération PDF:', error);
                showAlert('❌ Erreur lors de la génération du PDF : ' + error.message, 'error');
            }
        }

        // Génération des recommandations basées sur l'analyse
        function generateRecommendations() {
            const recommendations = [];

            // Recommandations basées sur la santé
            if (analysisData.avgHealthPhys < 6) {
                recommendations.push('Santé physique préoccupante: Organiser des sessions de sensibilisation aux bonnes pratiques ergonomiques et encourager l\'activité physique.');
            }

            if (analysisData.avgHealthPsych < 6) {
                recommendations.push('Santé psychologique fragile: Mettre en place un programme d\'accompagnement psychologique et des ateliers de gestion du stress.');
            }

            // Recommandations basées sur le stress
            if (analysisData.stressPercent > 60) {
                recommendations.push('Niveau de stress élevé: Identifier et traiter les sources principales de stress organisationnel, réviser la répartition des charges de travail.');
            }

            // Recommandations basées sur la QVT
            if (analysisData.qvtGoodPercent < 50) {
                recommendations.push('QVT insuffisante: Développer un plan d\'amélioration des conditions de travail en concertation avec les équipes.');
            }

            // Recommandations basées sur le risque de burnout
            if (analysisData.burnoutPercent > 20) {
                recommendations.push('Risque de burnout préoccupant: Mise en place urgente d\'un dispositif de prévention et de détection précoce du burnout.');
            }

            // Recommandations générales
            recommendations.push('Organiser des réunions d\'équipe régulières pour maintenir le dialogue et identifier les points d\'amélioration.');
            recommendations.push('Mettre en place un système de feedback continu et de reconnaissance du travail accompli.');
            recommendations.push('Planifier une réévaluation dans 6 mois pour mesurer l\'impact des actions mises en place.');

            return recommendations;
        }

        // Effacement de toutes les données
        function clearAll() {
            responses = [];
            analysisData = {};
            document.getElementById('fileList').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('alerts').innerHTML = '';
            document.getElementById('chartsContainer').innerHTML = '';
            document.getElementById('fileInput').value = '';
            
            // Nettoyer les graphiques
            Object.keys(charts).forEach(key => {
                if (charts[key]) {
                    charts[key].destroy();
                }
            });
            charts = {};
            
            // Réinitialiser les statistiques
            document.getElementById('totalResponses').textContent = '0';
            document.getElementById('avgHealthPhys').textContent = '0';
            document.getElementById('avgHealthPsych').textContent = '0';
            document.getElementById('stressCount').textContent = '0%';
            document.getElementById('qvtGood').textContent = '0%';
            document.getElementById('burnoutRisk').textContent = '0%';
            
            showAlert('🗑️ Toutes les données ont été effacées', 'info');
        }

        // Affichage des alertes
        function showAlert(message, type) {
            const container = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            // Auto-suppression après 5 secondes
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-10px)';
                    setTimeout(() => alert.remove(), 300);
                }
            }, 5000);
        }

        // Log de fin de script
        console.log('✅ Script Baromètre Santé entièrement chargé et fonctionnel');
    </script>
</body>
</html>
