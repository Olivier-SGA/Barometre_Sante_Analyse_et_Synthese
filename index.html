<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barom√®tre Sant√© 2025 - Analyse Compl√®te</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .header h1 { color: #2d3748; font-size: 2.5rem; margin-bottom: 10px; }
        .header h2 { color: #667eea; font-size: 1.3rem; margin-bottom: 15px; }
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .upload-zone {
            border: 3px dashed #667eea;
            padding: 50px;
            text-align: center;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        .upload-zone:hover { border-color: #764ba2; background: #f0f4ff; }
        .upload-zone h3 { color: #667eea; margin-bottom: 10px; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-danger { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); }
        .analysis-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border-left: 5px solid #667eea;
        }
        .stat-number { font-size: 2.5rem; font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .stat-label { color: #666; font-weight: 500; }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .file-list { margin-top: 20px; background: white; border-radius: 10px; padding: 20px; }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .file-item:last-child { border-bottom: none; }
        .file-icon { color: #667eea; font-size: 1.2rem; margin-right: 10px; }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .progress-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
            color: #1976d2;
        }
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .header h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analyse Compl√®te - Barom√®tre Sant√© 2025</h1>
            <h2>Cabinet Saint Germain Audit</h2>
            <p>Analyse approfondie de toutes les dimensions du bien-√™tre au travail</p>
        </div>

        <div class="upload-section">
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <h3>üìÅ Importer les r√©ponses JSON</h3>
                <p>Cliquez ici ou glissez-d√©posez tous les fichiers de r√©ponses du barom√®tre</p>
                <input type="file" id="fileInput" multiple accept=".json" style="display: none;">
            </div>
            
            <div id="fileList" class="file-list" style="display: none;"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="analyzeBtn" class="btn" disabled onclick="startCompleteAnalysis()">
                    üîç Lancer l'analyse compl√®te
                </button>
                <button class="btn btn-danger" onclick="clearAll()">
                    üóëÔ∏è Effacer tout
                </button>
            </div>
            
            <div id="alerts"></div>
        </div>

        <div class="analysis-section" id="analysisSection">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2d3748;">üìä Synth√®se Compl√®te des R√©sultats</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalResponses">0</div>
                    <div class="stat-label">R√©ponses collect√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSanteGlobale">0</div>
                    <div class="stat-label">Sant√© globale (/10)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSatisfaction">0</div>
                    <div class="stat-label">Satisfaction moyenne (/10)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stressPercent">0%</div>
                    <div class="stat-label">Collaborateurs stress√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="qvtExcellente">0%</div>
                    <div class="stat-label">QVT excellente/bonne</div>
                </div>
            </div>

            <div class="charts-grid" id="chartsContainer">
                <!-- Les graphiques seront g√©n√©r√©s dynamiquement -->
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn" onclick="generateCompletePDF()" style="font-size: 1.2rem; padding: 20px 40px;">
                    üìÑ G√©n√©rer le Rapport PDF Complet
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let responses = [];
        let charts = {};
        let analysisResults = {};

        // Initialisation apr√®s chargement du DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Configuration des √©v√©nements pour l'input file
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    handleFiles(e.target.files);
                });
            }

            // Drag & Drop sur la zone d'upload
            const uploadZone = document.querySelector('.upload-zone');
            if (uploadZone) {
                uploadZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadZone.style.borderColor = '#764ba2';
                });
                uploadZone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadZone.style.borderColor = '#667eea';
                });
                uploadZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadZone.style.borderColor = '#667eea';
                    handleFiles(e.dataTransfer.files);
                });
            }
        });

        // Gestion des fichiers
        function handleFiles(files) {
            responses = [];
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<h3>Fichiers en cours de traitement :</h3>';
            fileList.style.display = 'block';

            let processedFiles = 0;
            let validFiles = 0;

            Array.from(files).forEach(function(file, index) {
                if (!file.name.endsWith('.json')) {
                    processedFiles++;
                    addFileStatus(file.name, '‚ùå Format non support√©', fileList);
                    checkProcessingComplete();
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (validateJsonStructure(data)) {
                            responses.push(data);
                            validFiles++;
                            addFileStatus(file.name, '‚úÖ Charg√© avec succ√®s', fileList);
                        } else {
                            addFileStatus(file.name, '‚ö†Ô∏è Structure invalide', fileList);
                        }
                    } catch (error) {
                        addFileStatus(file.name, '‚ùå Erreur JSON: ' + error.message, fileList);
                    }
                    processedFiles++;
                    checkProcessingComplete();
                };
                reader.readAsText(file);
            });

            function checkProcessingComplete() {
                if (processedFiles === files.length) {
                    if (validFiles > 0) {
                        document.getElementById('analyzeBtn').disabled = false;
                        showAlert(validFiles + ' fichier(s) valide(s) charg√©(s) sur ' + files.length, 'success');
                    } else {
                        showAlert('Aucun fichier valide trouv√©', 'error');
                    }
                }
            }
        }

        function addFileStatus(fileName, status, container) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = '<span><span class="file-icon">üìÑ</span>' + fileName + '</span><span>' + status + '</span>';
            container.appendChild(fileItem);
        }

        function validateJsonStructure(data) {
            // Validation stricte de la structure JSON du barom√®tre
            return data && 
                   typeof data === 'object' &&
                   data.id &&
                   data.cabinet === 'Saint Germain Audit' &&
                   data.version_barometre === '2025.1' &&
                   (data.profil || data.age || data.sante_physique || data.sante_psychologique);
        }

        // Analyse compl√®te
        function startCompleteAnalysis() {
            if (responses.length === 0) {
                showAlert('Aucune donn√©e √† analyser', 'error');
                return;
            }

            showProgress('D√©marrage de l\'analyse compl√®te...');
            
            try {
                // Calcul des statistiques g√©n√©rales
                calculateGlobalStats();
                
                showProgress('Calcul des moyennes par dimension...');
                
                // Analyse d√©taill√©e par dimension
                analyzeAllDimensions();
                
                showProgress('G√©n√©ration des graphiques...');
                
                // Cr√©ation des graphiques
                createAllCharts();
                
                showProgress('Finalisation...');
                
                // Affichage des r√©sultats
                document.getElementById('analysisSection').style.display = 'block';
                document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
                
                showAlert('Analyse compl√®te termin√©e avec succ√®s !', 'success');
                
            } catch (error) {
                showAlert('Erreur lors de l\'analyse : ' + error.message, 'error');
                console.error('Erreur analyse:', error);
            }
        }

        function calculateGlobalStats() {
            const total = responses.length;
            
            // Sant√© globale (moyenne physique + psychologique)
            let santePhysiqueSum = 0, santePhysiqueCount = 0;
            let santePsychoSum = 0, santePsychoCount = 0;
            
            responses.forEach(function(r) {
                if (r.sante_physique) {
                    santePhysiqueSum += parseInt(r.sante_physique);
                    santePhysiqueCount++;
                }
                if (r.sante_psychologique) {
                    santePsychoSum += parseInt(r.sante_psychologique);
                    santePsychoCount++;
                }
            });
            
            const avgSantePhysique = santePhysiqueCount > 0 ? santePhysiqueSum / santePhysiqueCount : 0;
            const avgSantePsycho = santePsychoCount > 0 ? santePsychoSum / santePsychoCount : 0;
            const avgSanteGlobale = (avgSantePhysique + avgSantePsycho) / 2;

            // Satisfaction moyenne (calcul√©e sur toutes les dimensions)
            const satisfactionScores = calculateAllSatisfactionScores();
            const avgSatisfaction = Object.keys(satisfactionScores).length > 0 ?
                Object.values(satisfactionScores).reduce((a, b) => a + b, 0) / Object.keys(satisfactionScores).length : 0;

            // Stress
            let stressCount = 0;
            responses.forEach(function(r) {
                if (r.sources_stress && Array.isArray(r.sources_stress)) {
                    const hasStress = r.sources_stress.some(s => s !== 'pas_stresse');
                    if (hasStress) stressCount++;
                }
            });
            const stressPercent = (stressCount / total) * 100;

            // QVT excellente/bonne
            let qvtGoodCount = 0;
            responses.forEach(function(r) {
                if (r.qvt === 'excellente' || r.qvt === 'bonne') {
                    qvtGoodCount++;
                }
            });
            const qvtGoodPercent = (qvtGoodCount / total) * 100;

            // Mise √† jour de l'interface
            document.getElementById('totalResponses').textContent = total;
            document.getElementById('avgSanteGlobale').textContent = avgSanteGlobale.toFixed(1);
            document.getElementById('avgSatisfaction').textContent = avgSatisfaction.toFixed(1);
            document.getElementById('stressPercent').textContent = Math.round(stressPercent) + '%';
            document.getElementById('qvtExcellente').textContent = Math.round(qvtGoodPercent) + '%';

            // Stockage pour l'export PDF
            analysisResults.globalStats = {
                total: total,
                avgSanteGlobale: avgSanteGlobale,
                avgSatisfaction: avgSatisfaction,
                stressPercent: stressPercent,
                qvtGoodPercent: qvtGoodPercent
            };
        }

        function calculateAllSatisfactionScores() {
            const allMappings = {
                // Questions avec √©chelles qualitatives
                'gestion_pression': { 'tres_bien': 10, 'bien': 8, 'moyennement': 6, 'difficilement': 4, 'tres_difficilement': 2 },
                'climat_social': { 'tres_bon': 10, 'bon': 8, 'correct': 6, 'difficile': 4, 'tres_difficile': 2 },
                'qvt': { 'excellente': 10, 'bonne': 8, 'correcte': 6, 'decevante': 4, 'nocive': 2 },
                'qualite_sommeil': { 'correct_qualite': 10, 'correct': 7, 'perturbe': 4, 'tres_mauvais': 2 },
                
                // Questions binaires
                'charge_travail': { 'oui': 10, 'non': 3 },
                'sommeil_suffisant': { 'oui': 10, 'non': 4 },
                'alimentation_saine': { 'oui': 8, 'non': 4 },
                'offre_restauration': { 'oui': 8, 'non': 3 },
                'activite_physique': { 'oui': 8, 'non': 3 },
                'cabinet_facilite_sport': { 'oui': 8, 'non': 3 },
                'prevention_cabinet': { 'oui': 8, 'non': 3 },
                
                // Ergonomie
                'ergonomie_poste': { 'oui_totalement': 10, 'oui_en_partie': 7, 'non_pas_vraiment': 4, 'non_pas_du_tout': 2 },
                'douleurs_poste': { 'non': 10, 'oui': 2 },
                
                // Soutien
                'soutien_equipe': { 'oui_collegues_hierarchie': 10, 'oui_uniquement_collegues': 7, 'oui_uniquement_hierarchie': 7, 'non': 2 }
            };

            const scores = {};
            
            for (let question in allMappings) {
                const mapping = allMappings[question];
                const values = [];
                
                responses.forEach(function(r) {
                    if (r[question] && mapping[r[question]] !== undefined) {
                        values.push(mapping[r[question]]);
                    }
                });
                
                if (values.length > 0) {
                    scores[question] = values.reduce((a, b) => a + b, 0) / values.length;
                }
            }

            return scores;
        }

        function analyzeAllDimensions() {
            try {
                analysisResults.dimensions = {
                    profiles: analyzeProfiles(),
                    ages: analyzeAges(),
                    health: analyzeHealth(),
                    workload: analyzeWorkload(),
                    stress: analyzeStress(),
                    ergonomics: analyzeErgonomics(),
                    workEnvironment: analyzeWorkEnvironment(),
                    nutrition: analyzeNutrition(),
                    sleep: analyzeSleep(),
                    physicalActivity: analyzePhysicalActivity(),
                    prevention: analyzePrevention(),
                    telework: analyzeTelework()
                };
            } catch (error) {
                console.error('Erreur dans analyzeAllDimensions:', error);
                showAlert('Erreur lors de l analyse des dimensions: ' + error.message, 'error');
            }
        }

        function analyzeProfiles() {
            const counts = {};
            responses.forEach(r => {
                if (r.profil) counts[r.profil] = (counts[r.profil] || 0) + 1;
            });
            return {
                data: counts,
                labels: {
                    'auditeur': 'Auditeur/Auditrice',
                    'chef_mission': 'Chef de mission',
                    'directeur_mission': 'Directeur de mission'
                }
            };
        }

        function analyzeAges() {
            const counts = {};
            responses.forEach(r => {
                if (r.age) counts[r.age] = (counts[r.age] || 0) + 1;
            });
            return {
                data: counts,
                labels: {
                    'moins_25': 'Moins de 25 ans',
                    '25_30': '25-30 ans',
                    '30_40': '30-40 ans',
                    '40_50': '40-50 ans',
                    '50_60': '50-60 ans',
                    'plus_60': 'Plus de 60 ans'
                }
            };
        }

        function analyzeHealth() {
            let physSum = 0, physCount = 0, psychoSum = 0, psychoCount = 0;
            responses.forEach(r => {
                if (r.sante_physique) { physSum += parseInt(r.sante_physique); physCount++; }
                if (r.sante_psychologique) { psychoSum += parseInt(r.sante_psychologique); psychoCount++; }
            });
            return {
                physique: physCount > 0 ? physSum / physCount : 0,
                psychologique: psychoCount > 0 ? psychoSum / psychoCount : 0
            };
        }

        function analyzeWorkload() {
            const travailExtra = {}, pressionEcheances = {}, gestionPression = {}, chargeTravail = {};
            responses.forEach(r => {
                if (r.travail_extra) travailExtra[r.travail_extra] = (travailExtra[r.travail_extra] || 0) + 1;
                if (r.pression_echeances) pressionEcheances[r.pression_echeances] = (pressionEcheances[r.pression_echeances] || 0) + 1;
                if (r.gestion_pression) gestionPression[r.gestion_pression] = (gestionPression[r.gestion_pression] || 0) + 1;
                if (r.charge_travail) chargeTravail[r.charge_travail] = (chargeTravail[r.charge_travail] || 0) + 1;
            });
            return { travailExtra, pressionEcheances, gestionPression, chargeTravail };
        }

        function analyzeStress() {
            const sources = {}, symptoms = {};
            responses.forEach(r => {
                if (r.sources_stress && Array.isArray(r.sources_stress)) {
                    r.sources_stress.forEach(s => {
                        if (s !== 'pas_stresse') sources[s] = (sources[s] || 0) + 1;
                    });
                }
                if (r.symptomes_stress && Array.isArray(r.symptomes_stress)) {
                    r.symptomes_stress.forEach(s => symptoms[s] = (symptoms[s] || 0) + 1);
                }
            });
            return { sources, symptoms };
        }

        function analyzeErgonomics() {
            const ergonomie = {}, douleurs = {}, consultation = {};
            responses.forEach(r => {
                if (r.ergonomie_poste) ergonomie[r.ergonomie_poste] = (ergonomie[r.ergonomie_poste] || 0) + 1;
                if (r.douleurs_poste) douleurs[r.douleurs_poste] = (douleurs[r.douleurs_poste] || 0) + 1;
                if (r.consultation_pro_sante) consultation[r.consultation_pro_sante] = (consultation[r.consultation_pro_sante] || 0) + 1;
            });
            return { ergonomie, douleurs, consultation };
        }

        function analyzeWorkEnvironment() {
            const climat = {}, soutien = {}, qvt = {};
            responses.forEach(r => {
                if (r.climat_social) climat[r.climat_social] = (climat[r.climat_social] || 0) + 1;
                if (r.soutien_equipe) soutien[r.soutien_equipe] = (soutien[r.soutien_equipe] || 0) + 1;
                if (r.qvt) qvt[r.qvt] = (qvt[r.qvt] || 0) + 1;
            });
            return { climat, soutien, qvt };
        }

        function analyzeNutrition() {
            const restauration = {}, pauseDejeuner = {}, alimentationSaine = {}, grignotage = {};
            responses.forEach(r => {
                if (r.offre_restauration) restauration[r.offre_restauration] = (restauration[r.offre_restauration] || 0) + 1;
                if (r.temps_pause_dejeuner) pauseDejeuner[r.temps_pause_dejeuner] = (pauseDejeuner[r.temps_pause_dejeuner] || 0) + 1;
                if (r.alimentation_saine) alimentationSaine[r.alimentation_saine] = (alimentationSaine[r.alimentation_saine] || 0) + 1;
                if (r.grignotage) grignotage[r.grignotage] = (grignotage[r.grignotage] || 0) + 1;
            });
            return { restauration, pauseDejeuner, alimentationSaine, grignotage };
        }

        function analyzeSleep() {
            const heures = {}, suffisant = {}, qualite = {}, travailNuit = {};
            responses.forEach(r => {
                if (r.heures_sommeil) heures[r.heures_sommeil] = (heures[r.heures_sommeil] || 0) + 1;
                if (r.sommeil_suffisant) suffisant[r.sommeil_suffisant] = (suffisant[r.sommeil_suffisant] || 0) + 1;
                if (r.qualite_sommeil) qualite[r.qualite_sommeil] = (qualite[r.qualite_sommeil] || 0) + 1;
                if (r.penser_travail_nuit) travailNuit[r.penser_travail_nuit] = (travailNuit[r.penser_travail_nuit] || 0) + 1;
            });
            return { heures, suffisant, qualite, travailNuit };
        }

        function analyzePhysicalActivity() {
            const activite = {}, frequence = {}, obstacles = {}, facilitation = {};
            responses.forEach(r => {
                if (r.activite_physique) activite[r.activite_physique] = (activite[r.activite_physique] || 0) + 1;
                if (r.frequence_sport) frequence[r.frequence_sport] = (frequence[r.frequence_sport] || 0) + 1;
                if (r.obstacles_sport && Array.isArray(r.obstacles_sport)) {
                    r.obstacles_sport.forEach(o => obstacles[o] = (obstacles[o] || 0) + 1);
                }
                if (r.cabinet_facilite_sport) facilitation[r.cabinet_facilite_sport] = (facilitation[r.cabinet_facilite_sport] || 0) + 1;
            });
            return { activite, frequence, obstacles, facilitation };
        }

        function analyzePrevention() {
            const prevention = {}, efficacite = {};
            responses.forEach(r => {
                if (r.prevention_cabinet) prevention[r.prevention_cabinet] = (prevention[r.prevention_cabinet] || 0) + 1;
                if (r.efficacite_prevention) efficacite[r.efficacite_prevention] = (efficacite[r.efficacite_prevention] || 0) + 1;
            });
            return { prevention, efficacite };
        }

        function analyzeTelework() {
            const rythme = {};
            responses.forEach(r => {
                if (r.rythme_teletravail) rythme[r.rythme_teletravail] = (rythme[r.rythme_teletravail] || 0) + 1;
            });
            return { rythme };
        }

        function createAllCharts() {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';

            // D√©truire les graphiques existants
            Object.keys(charts).forEach(key => {
                if (charts[key]) charts[key].destroy();
            });
            charts = {};

            // Cr√©ation de tous les graphiques
            createChart('Profils Professionnels', 'pie', analysisResults.dimensions.profiles);
            createChart('R√©partition par √Çge', 'bar', analysisResults.dimensions.ages);
            createChart('Notes de Sant√©', 'bar', analysisResults.dimensions.health, true);
            createChart('Qualit√© de Vie au Travail', 'doughnut', analysisResults.dimensions.workEnvironment.qvt);
            createChart('Sources de Stress', 'horizontalBar', analysisResults.dimensions.stress.sources);
            createChart('Sympt√¥mes de Stress', 'bar', analysisResults.dimensions.stress.symptoms);
            createChart('Ergonomie du Poste', 'pie', analysisResults.dimensions.ergonomics.ergonomie);
            createChart('Climat Social', 'bar', analysisResults.dimensions.workEnvironment.climat);
            createChart('Heures de Sommeil', 'bar', analysisResults.dimensions.sleep.heures);
            createChart('Activit√© Physique', 'pie', analysisResults.dimensions.physicalActivity.activite);
            createChart('T√©l√©travail', 'doughnut', analysisResults.dimensions.telework.rythme);
            createSatisfactionChart();
        }

        function createChart(title, type, data, isHealthChart = false) {
            const container = document.getElementById('chartsContainer');
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            
            const chartTitle = document.createElement('div');
            chartTitle.className = 'chart-title';
            chartTitle.textContent = title;
            
            const canvas = document.createElement('canvas');
            const chartId = 'chart_' + Math.random().toString(36).substr(2, 9);
            canvas.id = chartId;
            
            chartContainer.appendChild(chartTitle);
            chartContainer.appendChild(canvas);
            container.appendChild(chartContainer);

            const ctx = canvas.getContext('2d');

            let chartData, options;

            if (isHealthChart) {
                // Graphique sp√©cial pour la sant√©
                chartData = {
                    labels: ['Sant√© Physique', 'Sant√© Psychologique'],
                    datasets: [{
                        label: 'Note moyenne (/10)',
                        data: [data.physique, data.psychologique],
                        backgroundColor: ['#48bb78', '#667eea']
                    }]
                };
                options = {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, max: 10 }
                    }
                };
            } else if (data.data) {
                // Graphique avec labels mapp√©s
                const labels = [];
                const values = [];
                for (let key in data.data) {
                    labels.push(data.labels[key] || key);
                    values.push(data.data[key]);
                }
                
                chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre de r√©ponses',
                        data: values,
                        backgroundColor: generateColors(values.length)
                    }]
                };
            } else {
                // Graphique simple
                const labels = [];
                const values = [];
                const labelMappings = getLabelMappings(title);
                
                for (let key in data) {
                    labels.push(labelMappings[key] || key);
                    values.push(data[key]);
                }
                
                chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre de mentions',
                        data: values,
                        backgroundColor: generateColors(values.length)
                    }]
                };
            }

            options = options || {
                responsive: true,
                plugins: {
                    legend: {
                        position: type === 'horizontalBar' ? 'top' : 'bottom'
                    }
                }
            };

            if (type === 'horizontalBar') {
                options.indexAxis = 'y';
                options.scales = { x: { beginAtZero: true } };
                type = 'bar';
            }

            charts[chartId] = new Chart(ctx, {
                type: type,
                data: chartData,
                options: options
            });
        }

        function createSatisfactionChart() {
            const container = document.getElementById('chartsContainer');
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.gridColumn = 'span 2'; // Graphique plus large
            
            const chartTitle = document.createElement('div');
            chartTitle.className = 'chart-title';
            chartTitle.textContent = 'Notes de Satisfaction par Dimension (/10)';
            
            const canvas = document.createElement('canvas');
            const chartId = 'satisfactionChart';
            canvas.id = chartId;
            
            chartContainer.appendChild(chartTitle);
            chartContainer.appendChild(canvas);
            container.appendChild(chartContainer);

            const ctx = canvas.getContext('2d');
            const scores = calculateAllSatisfactionScores();

            const labels = [];
            const values = [];
            const colors = [];

            const labelMappings = {
                'gestion_pression': 'Gestion de la pression',
                'climat_social': 'Climat social',
                'qvt': 'Qualit√© de vie au travail',
                'qualite_sommeil': 'Qualit√© du sommeil',
                'charge_travail': 'Charge de travail raisonnable',
                'sommeil_suffisant': 'Temps de sommeil suffisant',
                'alimentation_saine': 'Alimentation saine',
                'offre_restauration': 'Offre de restauration',
                'activite_physique': 'Activit√© physique r√©guli√®re',
                'cabinet_facilite_sport': 'Facilitation sport par cabinet',
                'prevention_cabinet': 'Actions de pr√©vention',
                'ergonomie_poste': 'Ergonomie du poste',
                'douleurs_poste': 'Absence de douleurs',
                'soutien_equipe': 'Soutien √©quipe/hi√©rarchie'
            };

            // Trier par score d√©croissant
            const sortedScores = Object.entries(scores).sort((a, b) => b[1] - a[1]);

            sortedScores.forEach(function([key, score]) {
                labels.push(labelMappings[key] || key);
                values.push(score);
                
                // Code couleur selon le score
                if (score >= 8) colors.push('#48bb78'); // Vert
                else if (score >= 6) colors.push('#ed8936'); // Orange
                else if (score >= 4) colors.push('#f56565'); // Rouge
                else colors.push('#e53e3e'); // Rouge fonc√©
            });

            charts[chartId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Note moyenne (/10)',
                        data: values,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 10,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            ticks: { maxRotation: 45 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function generateColors(count) {
            const baseColors = ['#667eea', '#764ba2', '#48bb78', '#ed8936', '#f56565', '#e53e3e', '#38b2ac', '#805ad5', '#d69e2e', '#e53e3e'];
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        }

        function getLabelMappings(chartTitle) {
            const mappings = {
                'Sources de Stress': {
                    'gestion_clients': 'Gestion des clients',
                    'complexite_dossiers': 'Complexit√© des dossiers',
                    'tenue_delais': 'Respect des d√©lais',
                    'outils_inefficaces': 'Outils inefficaces',
                    'pression_hierarchique': 'Pression hi√©rarchique',
                    'horaires_contraintes': 'Contraintes horaires',
                    'manque_formation': 'Manque de formation'
                },
                'Sympt√¥mes de Stress': {
                    'fatigue': 'Fatigue',
                    'troubles_sommeil': 'Troubles du sommeil',
                    'maux_tete': 'Maux de t√™te',
                    'tensions_musculaires': 'Tensions musculaires',
                    'problemes_digestifs': 'Probl√®mes digestifs',
                    'troubles_alimentaires': 'Troubles alimentaires'
                },
                'Ergonomie du Poste': {
                    'oui_totalement': 'Oui, totalement',
                    'oui_en_partie': 'Oui, en partie',
                    'non_pas_vraiment': 'Non, pas vraiment',
                    'non_pas_du_tout': 'Non, pas du tout'
                },
                'Climat Social': {
                    'tres_bon': 'Tr√®s bon',
                    'bon': 'Bon',
                    'correct': 'Correct',
                    'difficile': 'Difficile',
                    'tres_difficile': 'Tr√®s difficile'
                },
                'Heures de Sommeil': {
                    'moins_5h': 'Moins de 5h',
                    'environ_5h': 'Environ 5h',
                    'environ_6h': 'Environ 6h',
                    'environ_7h': 'Environ 7h',
                    'environ_8h': 'Environ 8h',
                    'plus_8h': 'Plus de 8h'
                },
                'Activit√© Physique': {
                    'oui': 'Oui',
                    'non': 'Non'
                },
                'T√©l√©travail': {
                    'jamais_cabinet_interdit': 'Jamais (interdit)',
                    'jamais_choix': 'Jamais (choix)',
                    '1j_semaine': '1 jour/semaine',
                    '2j_semaine': '2 jours/semaine',
                    'plus_2j_semaine': '+ 2 jours/semaine',
                    '100_pourcent': '100% t√©l√©travail'
                }
            };
            return mappings[chartTitle] || {};
        }

        function generateCompletePDF() {
            showProgress('G√©n√©ration du rapport PDF avec analyse d√©taill√©e...');

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 30;
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();

                // En-t√™te
                doc.setFontSize(24);
                doc.text('BAROMETRE SANTE 2025', pageWidth / 2, yPos, { align: 'center' });
                yPos += 12;
                
                doc.setFontSize(16);
                doc.text('ANALYSE DETAILLEE DES RESULTATS', pageWidth / 2, yPos, { align: 'center' });
                yPos += 8;
                
                doc.setFontSize(14);
                doc.text('Cabinet Saint Germain Audit', pageWidth / 2, yPos, { align: 'center' });
                yPos += 15;
                
                doc.setFontSize(10);
                const now = new Date();
                doc.text('Rapport genere le ' + now.toLocaleDateString('fr-FR') + ' a ' + now.toLocaleTimeString('fr-FR'), 
                         pageWidth / 2, yPos, { align: 'center' });
                yPos += 25;

                // Synth√®se ex√©cutive
                doc.setFontSize(18);
                doc.text('SYNTHESE EXECUTIVE', margin, yPos);
                yPos += 12;

                const stats = analysisResults.globalStats;
                const executiveSummary = [
                    'Nombre total de participants : ' + stats.total,
                    'Taux de participation : 100% (echantillon complet)',
                    'Note sante globale moyenne : ' + stats.avgSanteGlobale.toFixed(1) + '/10',
                    'Note satisfaction moyenne generale : ' + stats.avgSatisfaction.toFixed(1) + '/10',
                    'Proportion collaborateurs en situation de stress : ' + Math.round(stats.stressPercent) + '%',
                    'Proportion QVT evaluee comme excellente/bonne : ' + Math.round(stats.qvtGoodPercent) + '%'
                ];

                doc.setFontSize(11);
                executiveSummary.forEach(function(item) {
                    doc.text('‚Ä¢ ' + item, margin, yPos);
                    yPos += 7;
                });

                yPos += 15;

                // Analyse d√©taill√©e par section
                doc.setFontSize(18);
                doc.text('ANALYSE DETAILLEE PAR QUESTION', margin, yPos);
                yPos += 15;

                // Section 1: Profils professionnels
                yPos = addDetailedSection(doc, 'SECTION 1 - PROFILS PROFESSIONNELS', yPos, margin, pageWidth);
                
                const profileData = analysisResults.dimensions.profiles;
                yPos = addQuestionAnalysis(doc, 'Question : Quel est votre profil professionnel ?', 
                    profileData.data, profileData.labels, yPos, margin, pageWidth);

                // Section 2: Tranches d'√¢ge  
                yPos = addDetailedSection(doc, 'SECTION 2 - REPARTITION PAR AGE', yPos, margin, pageWidth);
                
                const ageData = analysisResults.dimensions.ages;
                yPos = addQuestionAnalysis(doc, 'Question : Votre tranche d\'age ?', 
                    ageData.data, ageData.labels, yPos, margin, pageWidth);

                // Section 3: Sant√© globale
                yPos = addDetailedSection(doc, 'SECTION 3 - SANTE GLOBALE', yPos, margin, pageWidth);
                
                const healthData = analysisResults.dimensions.health;
                doc.setFontSize(12);
                doc.text('Question : Comment evaluez-vous votre sante physique ? (Note /10)', margin, yPos);
                yPos += 8;
                doc.setFontSize(10);
                doc.text('Moyenne obtenue : ' + healthData.physique.toFixed(2) + '/10', margin + 10, yPos);
                yPos += 10;

                doc.setFontSize(12);
                doc.text('Question : Comment evaluez-vous votre sante psychologique ? (Note /10)', margin, yPos);
                yPos += 8;
                doc.setFontSize(10);
                doc.text('Moyenne obtenue : ' + healthData.psychologique.toFixed(2) + '/10', margin + 10, yPos);
                yPos += 15;

                // Section 4: Organisation et charge de travail
                yPos = addDetailedSection(doc, 'SECTION 4 - ORGANISATION ET CHARGE DE TRAVAIL', yPos, margin, pageWidth);
                
                const workloadData = analysisResults.dimensions.workload;
                const workloadLabels = {
                    'travailExtra': {
                        'jamais': 'Jamais',
                        'plusieurs_fois_an': 'Plusieurs fois par an',
                        'plusieurs_fois_mois': 'Plusieurs fois par mois',
                        'plusieurs_fois_semaine': 'Plusieurs fois par semaine'
                    },
                    'pressionEcheances': {
                        'jamais': 'Jamais',
                        'rarement': 'Rarement',
                        'souvent': 'Souvent',
                        'tres_regulierement': 'Tres regulierement'
                    },
                    'gestionPression': {
                        'tres_bien': 'Tres bien',
                        'bien': 'Bien',
                        'moyennement': 'Moyennement',
                        'difficilement': 'Difficilement',
                        'tres_difficilement': 'Tres difficilement'
                    },
                    'chargeTravail': {
                        'oui': 'Oui, raisonnable',
                        'non': 'Non, pas raisonnable'
                    }
                };

                yPos = addQuestionAnalysis(doc, 'Question : Frequence travail soir/week-end ?', 
                    workloadData.travailExtra, workloadLabels.travailExtra, yPos, margin, pageWidth);
                
                yPos = addQuestionAnalysis(doc, 'Question : Ressentez-vous pression liee aux echeances ?', 
                    workloadData.pressionEcheances, workloadLabels.pressionEcheances, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Comment gerez-vous cette pression ?', 
                    workloadData.gestionPression, workloadLabels.gestionPression, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Charge de travail raisonnable ?', 
                    workloadData.chargeTravail, workloadLabels.chargeTravail, yPos, margin, pageWidth);

                // Section 5: Stress
                yPos = addDetailedSection(doc, 'SECTION 5 - STRESS AU TRAVAIL', yPos, margin, pageWidth);
                
                const stressData = analysisResults.dimensions.stress;
                const stressLabels = {
                    'sources': {
                        'gestion_clients': 'Gestion des clients',
                        'complexite_dossiers': 'Complexite des dossiers',
                        'tenue_delais': 'Tenue des delais',
                        'outils_inefficaces': 'Outils inefficaces',
                        'pression_hierarchique': 'Pression hierarchique',
                        'horaires_contraintes': 'Contraintes horaires',
                        'manque_formation': 'Manque de formation'
                    },
                    'symptoms': {
                        'fatigue': 'Fatigue',
                        'troubles_sommeil': 'Troubles du sommeil',
                        'maux_tete': 'Maux de tete/migraines',
                        'tensions_musculaires': 'Tensions musculaires',
                        'problemes_digestifs': 'Problemes digestifs',
                        'troubles_alimentaires': 'Troubles alimentaires'
                    }
                };

                yPos = addQuestionAnalysis(doc, 'Question : Principales sources de stress (choix multiples)', 
                    stressData.sources, stressLabels.sources, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Symptomes physiques lies au stress (choix multiples)', 
                    stressData.symptoms, stressLabels.symptoms, yPos, margin, pageWidth);

                // Section 6: Ergonomie
                yPos = addDetailedSection(doc, 'SECTION 6 - ERGONOMIE ET SEDENTARITE', yPos, margin, pageWidth);
                
                const ergoData = analysisResults.dimensions.ergonomics;
                const ergoLabels = {
                    'ergonomie': {
                        'oui_totalement': 'Oui, totalement',
                        'oui_en_partie': 'Oui, en partie',
                        'non_pas_vraiment': 'Non, pas vraiment',
                        'non_pas_du_tout': 'Non, pas du tout'
                    },
                    'douleurs': {
                        'oui': 'Oui',
                        'non': 'Non'
                    },
                    'consultation': {
                        'oui': 'Oui',
                        'non': 'Non'
                    }
                };

                yPos = addQuestionAnalysis(doc, 'Question : Poste adapte en termes d\'ergonomie ?', 
                    ergoData.ergonomie, ergoLabels.ergonomie, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Douleurs physiques liees au poste ?', 
                    ergoData.douleurs, ergoLabels.douleurs, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Consultation professionnel sante pour probleme travail ?', 
                    ergoData.consultation, ergoLabels.consultation, yPos, margin, pageWidth);

                // Section 7: Ambiance de travail
                yPos = addDetailedSection(doc, 'SECTION 7 - AMBIANCE DE TRAVAIL', yPos, margin, pageWidth);
                
                const workEnvData = analysisResults.dimensions.workEnvironment;
                const workEnvLabels = {
                    'climat': {
                        'tres_bon': 'Tres bon',
                        'bon': 'Bon',
                        'correct': 'Correct',
                        'difficile': 'Difficile',
                        'tres_difficile': 'Tres difficile'
                    },
                    'soutien': {
                        'oui_collegues_hierarchie': 'Oui, collegues et hierarchie',
                        'oui_uniquement_collegues': 'Oui, uniquement collegues',
                        'oui_uniquement_hierarchie': 'Oui, uniquement hierarchie',
                        'non': 'Non, pas soutenu'
                    },
                    'qvt': {
                        'excellente': 'Excellente',
                        'bonne': 'Bonne',
                        'correcte': 'Correcte',
                        'decevante': 'Decevante',
                        'nocive': 'Nocive'
                    }
                };

                yPos = addQuestionAnalysis(doc, 'Question : Comment jugez-vous le climat social ?', 
                    workEnvData.climat, workEnvLabels.climat, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Vous sentez-vous soutenu ?', 
                    workEnvData.soutien, workEnvLabels.soutien, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Comment definiriez-vous votre QVT ?', 
                    workEnvData.qvt, workEnvLabels.qvt, yPos, margin, pageWidth);

                // Section 8: Alimentation
                yPos = addDetailedSection(doc, 'SECTION 8 - ALIMENTATION', yPos, margin, pageWidth);
                
                const nutritionData = analysisResults.dimensions.nutrition;
                const nutritionLabels = {
                    'restauration': { 'oui': 'Oui', 'non': 'Non' },
                    'pauseDejeuner': {
                        'plus_1h': 'Plus de 1 heure',
                        '30min_1h': '30min a 1h',
                        'moins_30min': 'Moins de 30min',
                        'au_poste': 'Au poste de travail'
                    },
                    'alimentationSaine': { 'oui': 'Oui', 'non': 'Non' },
                    'grignotage': { 'oui': 'Oui', 'non': 'Non' }
                };

                yPos = addQuestionAnalysis(doc, 'Question : Offre restauration de qualite ?', 
                    nutritionData.restauration, nutritionLabels.restauration, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Temps consacre a la pause dejeuner ?', 
                    nutritionData.pauseDejeuner, nutritionLabels.pauseDejeuner, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Estimez-vous avoir une alimentation saine ?', 
                    nutritionData.alimentationSaine, nutritionLabels.alimentationSaine, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Vous arrive-t-il de grignoter au travail ?', 
                    nutritionData.grignotage, nutritionLabels.grignotage, yPos, margin, pageWidth);

                // Section 9: Sommeil
                yPos = addDetailedSection(doc, 'SECTION 9 - SOMMEIL', yPos, margin, pageWidth);
                
                const sleepData = analysisResults.dimensions.sleep;
                const sleepLabels = {
                    'heures': {
                        'moins_5h': 'Moins de 5 heures',
                        'environ_5h': 'Environ 5 heures',
                        'environ_6h': 'Environ 6 heures',
                        'environ_7h': 'Environ 7 heures',
                        'environ_8h': 'Environ 8 heures',
                        'plus_8h': 'Plus de 8 heures'
                    },
                    'suffisant': { 'oui': 'Oui', 'non': 'Non' },
                    'qualite': {
                        'correct_qualite': 'Correct et de qualite',
                        'correct': 'Correct',
                        'perturbe': 'Perturbe',
                        'tres_mauvais': 'Tres mauvais'
                    },
                    'travailNuit': { 'oui': 'Oui', 'non': 'Non' }
                };

                yPos = addQuestionAnalysis(doc, 'Question : Heures de sommeil par nuit en moyenne ?', 
                    sleepData.heures, sleepLabels.heures, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Temps de sommeil suffisant pour vous ?', 
                    sleepData.suffisant, sleepLabels.suffisant, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Comment qualifiez-vous la qualite de votre sommeil ?', 
                    sleepData.qualite, sleepLabels.qualite, yPos, margin, pageWidth);

                yPos = addQuestionAnalysis(doc, 'Question : Vous arrive-t-il de penser au travail la nuit ?', 
                    sleepData.travailNuit, sleepLabels.travailNuit, yPos, margin, pageWidth);

                // Section 10: Activit√© physique
                yPos = addDetailedSection(doc, 'SECTION 10 - ACTIVITE PHYSIQUE', yPos, margin, pageWidth);
                
                const activityData = analysisResults.dimensions.physicalActivity;
                const activityLabels = {
                    'activite': { 'oui': 'Oui', 'non': 'Non' },
                    'frequence': {
                        'plusieurs_fois_semaine': 'Plusieurs fois par semaine',
                        'toutes_semaines': 'Toutes les semaines',
                        'quelques_fois_mois': 'Quelques fois par mois'
                    },
                    'obstacles': {
                        'manque_temps': 'Manque de temps',
                        'manque_motivation': 'Manque de motivation',
                        'forme_insuffisante': 'Forme physique insuffisante',
                        'autres_raisons': 'Autres raisons'
                    },
                    'facilitation': { 'oui': 'Oui', 'non': 'Non' }
                };

                yPos = addQuestionAnalysis(doc, 'Question : Pratiquez-vous une activite physique reguliere ?', 
                    activityData.activite, activityLabels.activite, yPos, margin, pageWidth);

                if (Object.keys(activityData.frequence).length > 0) {
                    yPos = addQuestionAnalysis(doc, 'Question : Frequence de l\'activite physique ?', 
                        activityData.frequence, activityLabels.frequence, yPos, margin, pageWidth);
                }

                if (Object.keys(activityData.obstacles).length > 0) {
                    yPos = addQuestionAnalysis(doc, 'Question : Obstacles a la pratique sportive (choix multiples)', 
                        activityData.obstacles, activityLabels.obstacles, yPos, margin, pageWidth);
                }

                yPos = addQuestionAnalysis(doc, 'Question : Cabinet facilite-t-il activite sportive sur pause ?', 
                    activityData.facilitation, activityLabels.facilitation, yPos, margin, pageWidth);

                // Section 11: Pr√©vention
                yPos = addDetailedSection(doc, 'SECTION 11 - PREVENTION SANTE', yPos, margin, pageWidth);
                
                const preventionData = analysisResults.dimensions.prevention;
                const preventionLabels = {
                    'prevention': { 'oui': 'Oui', 'non': 'Non', 'ne_sais_pas': 'Je ne sais pas' },
                    'efficacite': {
                        'interessante': 'Interessante',
                        'utile_effets': 'Utile et suivie d effets',
                        'inutile': 'Inutile'
                    }
                };

                yPos = addQuestionAnalysis(doc, 'Question : Cabinet a-t-il mis en place actions prevention ?', 
                    preventionData.prevention, preventionLabels.prevention, yPos, margin, pageWidth);

                if (Object.keys(preventionData.efficacite).length > 0) {
                    yPos = addQuestionAnalysis(doc, 'Question : Comment avez-vous trouve cette prevention ?', 
                        preventionData.efficacite, preventionLabels.efficacite, yPos, margin, pageWidth);
                }

                // Section 12: T√©l√©travail
                yPos = addDetailedSection(doc, 'SECTION 12 - TELETRAVAIL', yPos, margin, pageWidth);
                
                const teleworkData = analysisResults.dimensions.telework;
                const teleworkLabels = {
                    'rythme': {
                        'jamais_cabinet_interdit': 'Jamais, cabinet ne le permet pas',
                        'jamais_choix': 'Jamais, mais c est mon choix',
                        '1j_semaine': '1 jour par semaine en moyenne',
                        '2j_semaine': '2 jours par semaine en moyenne',
                        'plus_2j_semaine': 'Plus de 2 jours par semaine',
                        '100_pourcent': '100% en teletravail'
                    }
                };

                yPos = addQuestionAnalysis(doc, 'Question : A quel rythme avez-vous recours au teletravail ?', 
                    teleworkData.rythme, teleworkLabels.rythme, yPos, margin, pageWidth);

                // Recommandations
                yPos += 15;
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 30;
                }

                doc.setFontSize(18);
                doc.text('RECOMMANDATIONS STRATEGIQUES', margin, yPos);
                yPos += 15;

                const recommendations = generateRecommendations();
                doc.setFontSize(11);
                
                recommendations.forEach(function(rec) {
                    const lines = doc.splitTextToSize('‚Ä¢ ' + rec, pageWidth - 2 * margin);
                    lines.forEach(function(line) {
                        if (yPos > 280) {
                            doc.addPage();
                            yPos = 30;
                        }
                        doc.text(line, margin, yPos);
                        yPos += 7;
                    });
                    yPos += 5;
                });

                // Footer avec pagination
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text('Page ' + i + ' sur ' + pageCount + ' - Barometre Sante 2025 - Cabinet Saint Germain Audit', 
                            pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                }

                // Sauvegarde
                const fileName = 'Barometre_Sante_2025_Analyse_Detaillee_' + now.toISOString().slice(0, 10) + '.pdf';
                doc.save(fileName);

                showAlert('Rapport PDF avec analyse detaillee genere : ' + fileName, 'success');

            } catch (error) {
                showAlert('Erreur lors de la generation du PDF : ' + error.message, 'error');
                console.error('Erreur PDF:', error);
            }
        }

        function addDetailedSection(doc, sectionTitle, yPos, margin, pageWidth) {
            if (yPos > 250) {
                doc.addPage();
                yPos = 30;
            }
            
            doc.setFontSize(14);
            doc.text(sectionTitle, margin, yPos);
            yPos += 12;
            
            return yPos;
        }

        function addQuestionAnalysis(doc, questionTitle, data, labels, yPos, margin, pageWidth) {
            // V√©rifier si on a besoin d'une nouvelle page
            if (yPos > 230) {
                doc.addPage();
                yPos = 30;
            }
            
            doc.setFontSize(12);
            doc.text(questionTitle, margin, yPos);
            yPos += 8;
            
            // Calculer le total des r√©ponses
            const total = Object.values(data).reduce((sum, count) => sum + count, 0);
            
            doc.setFontSize(10);
            doc.text('Total repondants a cette question : ' + total, margin + 5, yPos);
            yPos += 8;
            
            // Tableau des r√©sultats
            doc.setFontSize(9);
            doc.text('Reponse', margin + 10, yPos);
            doc.text('Nb', margin + 120, yPos);
            doc.text('%', margin + 140, yPos);
            yPos += 2;
            
            // Ligne de s√©paration
            doc.line(margin + 5, yPos, margin + 160, yPos);
            yPos += 5;
            
            // Donn√©es du tableau
            for (let key in data) {
                const count = data[key];
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                const label = labels && labels[key] ? labels[key] : key;
                
                // Gestion du retour √† la ligne pour les labels longs
                const labelLines = doc.splitTextToSize(label, 100);
                labelLines.forEach(function(line, index) {
                    if (yPos > 280) {
                        doc.addPage();
                        yPos = 30;
                    }
                    
                    if (index === 0) {
                        doc.text(line, margin + 10, yPos);
                        doc.text(count.toString(), margin + 120, yPos);
                        doc.text(percentage + '%', margin + 140, yPos);
                    } else {
                        doc.text(line, margin + 10, yPos);
                    }
                    yPos += 5;
                });
            }
            
            yPos += 8;
            return yPos;
        }image/png', 0.8);
                            const imgHeight = graphCount % 2 === 0 ? 80 : 80;
                            const imgY = graphCount % 2 === 0 ? yPos : yPos + 100;
                            
                            doc.addImage(imgData, 'PNG', margin, imgY, pageWidth - 2*margin, imgHeight);
                            
                            if (graphCount % 2 === 0) {
                                yPos += 90;
                            } else {
                                yPos += 180;
                            }
                            
                            graphCount++;
                        } catch (error) {
                            console.warn('Erreur export graphique:', error);
                        }
                    }
                });

                // Nouvelle page pour les d√©tails textuels
                doc.addPage();
                yPos = 30;

                // Notes de satisfaction d√©taill√©es
                doc.setFontSize(16);
                doc.text('NOTES DE SATISFACTION DETAILLEES', margin, yPos);
                yPos += 10;

                const scores = calculateAllSatisfactionScores();
                const labelMappings = {
                    'gestion_pression': 'Gestion de la pression',
                    'climat_social': 'Climat social',
                    'qvt': 'Qualite de vie au travail',
                    'qualite_sommeil': 'Qualite du sommeil',
                    'charge_travail': 'Charge de travail raisonnable',
                    'sommeil_suffisant': 'Temps de sommeil suffisant',
                    'alimentation_saine': 'Alimentation saine',
                    'offre_restauration': 'Offre de restauration',
                    'activite_physique': 'Activite physique reguliere',
                    'cabinet_facilite_sport': 'Facilitation sport par cabinet',
                    'prevention_cabinet': 'Actions de prevention',
                    'ergonomie_poste': 'Ergonomie du poste',
                    'douleurs_poste': 'Absence de douleurs',
                    'soutien_equipe': 'Soutien equipe/hierarchie'
                };

                doc.setFontSize(10);
                const sortedScores = Object.entries(scores).sort((a, b) => b[1] - a[1]);
                
                sortedScores.forEach(function([key, score]) {
                    const label = labelMappings[key] || key;
                    const indicator = score >= 8 ? 'EXCELLENT' : score >= 6 ? 'CORRECT' : score >= 4 ? 'FAIBLE' : 'CRITIQUE';
                    doc.text('‚Ä¢ ' + label + ' : ' + score.toFixed(1) + '/10 (' + indicator + ')', margin, yPos);
                    yPos += 6;
                    
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 30;
                    }
                });

                // Analyse d√©taill√©e par section
                yPos += 15;
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 30;
                }

                doc.setFontSize(16);
                doc.text('ANALYSE DETAILLEE', margin, yPos);
                yPos += 12;

                // Profils
                doc.setFontSize(12);
                doc.text('Repartition des profils professionnels :', margin, yPos);
                yPos += 8;

                const profiles = analysisResults.dimensions.profiles;
                doc.setFontSize(10);
                for (let key in profiles.data) {
                    const label = profiles.labels[key] || key;
                    const count = profiles.data[key];
                    const percent = ((count / stats.total) * 100).toFixed(1);
                    doc.text('‚Ä¢ ' + label + ' : ' + count + ' (' + percent + '%)', margin, yPos);
                    yPos += 6;
                }

                yPos += 10;

                // QVT d√©taill√©e
                doc.setFontSize(12);
                doc.text('Qualite de vie au travail :', margin, yPos);
                yPos += 8;

                const qvtLabels = {
                    'excellente': 'Excellente',
                    'bonne': 'Bonne', 
                    'correcte': 'Correcte',
                    'decevante': 'Decevante',
                    'nocive': 'Nocive'
                };

                doc.setFontSize(10);
                const qvt = analysisResults.dimensions.workEnvironment.qvt;
                for (let key in qvt) {
                    const label = qvtLabels[key] || key;
                    const count = qvt[key];
                    const percent = ((count / stats.total) * 100).toFixed(1);
                    doc.text('‚Ä¢ ' + label + ' : ' + count + ' (' + percent + '%)', margin, yPos);
                    yPos += 6;
                }

                yPos += 15;

                // Recommandations
                doc.setFontSize(16);
                doc.text('RECOMMANDATIONS', margin, yPos);
                yPos += 10;

                const recommendations = generateRecommendations();
                doc.setFontSize(10);
                
                recommendations.forEach(function(rec) {
                    const lines = doc.splitTextToSize('‚Ä¢ ' + rec, pageWidth - 2 * margin);
                    lines.forEach(function(line) {
                        if (yPos > 280) {
                            doc.addPage();
                            yPos = 30;
                        }
                        doc.text(line, margin, yPos);
                        yPos += 6;
                    });
                    yPos += 3;
                });

                // Footer avec pagination
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text('Page ' + i + ' sur ' + pageCount + ' - Barometre Sante 2025 - Cabinet Saint Germain Audit', 
                            pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                }

                // Sauvegarde
                const fileName = 'Barometre_Sante_2025_Rapport_Complet_Graphiques_' + now.toISOString().slice(0, 10) + '.pdf';
                doc.save(fileName);

                showAlert('Rapport PDF avec graphiques genere avec succes : ' + fileName, 'success');

            } catch (error) {
                showAlert('Erreur lors de la generation du PDF : ' + error.message, 'error');
                console.error('Erreur PDF:', error);
            }
        }

        function generateRecommendations() {
            const recommendations = [];
            const stats = analysisResults.globalStats;
            const scores = calculateAllSatisfactionScores();

            // Recommandations bas√©es sur les scores faibles
            if (stats.avgSanteGlobale < 6) {
                recommendations.push('Mettre en place un programme de sante au travail comprenant prevention physique et psychologique.');
            }

            if (stats.stressPercent > 50) {
                recommendations.push('Organiser des formations sur la gestion du stress et evaluer les sources principales de pression.');
            }

            if (stats.qvtGoodPercent < 60) {
                recommendations.push('Conduire un audit approfondi de la qualite de vie au travail avec plan d\'action corrective.');
            }

            // Recommandations sp√©cifiques par dimension
            if (scores.ergonomie_poste && scores.ergonomie_poste < 6) {
                recommendations.push('Ameliorer l\'ergonomie des postes de travail avec audit professionnel et equipements adaptes.');
            }

            if (scores.activite_physique && scores.activite_physique < 5) {
                recommendations.push('Favoriser l\'activite physique par des partenariats avec des salles de sport ou des cours sur site.');
            }

            if (scores.prevention_cabinet && scores.prevention_cabinet < 5) {
                recommendations.push('Developper des actions de prevention sante : sensibilisation, depistage, accompagnement.');
            }

            // Recommandation g√©n√©rale si tout va bien
            if (stats.avgSatisfaction >= 7 && stats.stressPercent < 30 && stats.qvtGoodPercent > 70) {
                recommendations.push('Les resultats montrent une situation globalement positive. Maintenir les bonnes pratiques et surveiller l\'evolution.');
            }

            return recommendations.length > 0 ? recommendations : ['Analyser les resultats en detail pour identifier les axes d\'amelioration prioritaires.'];
        }

        function clearAll() {
            responses = [];
            analysisResults = {};
            
            document.getElementById('fileList').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('alerts').innerHTML = '';
            document.getElementById('chartsContainer').innerHTML = '';
            
            // Destruction des graphiques
            Object.keys(charts).forEach(function(key) {
                if (charts[key]) charts[key].destroy();
            });
            charts = {};
            
            showAlert('Toutes les donnees ont ete effacees avec succes', 'info');
        }

        function showProgress(message) {
            const alertsContainer = document.getElementById('alerts');
            alertsContainer.innerHTML = '<div class="progress-info">' + message + '</div>';
        }

        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = 'alert alert-' + type;
            alert.textContent = message;
            alertsContainer.appendChild(alert);
            
            setTimeout(function() {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
