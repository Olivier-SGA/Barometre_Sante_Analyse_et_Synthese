<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barom√®tre Sant√© 2025 - Analyse Compl√®te</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #2a5298, #4299e1, #38b2ac);
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      background: #fff;
      padding: 40px;
      border-radius: 16px;
      margin-bottom: 30px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .header h1 {
      font-size: 2.8rem;
      background: linear-gradient(90deg, #2a5298, #38b2ac);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .header h2 {
      color: #2a5298;
      font-size: 1.4rem;
      margin-bottom: 10px;
    }
    .header p {
      color: #555;
    }
    .btn {
      background: linear-gradient(135deg, #4299e1, #2b6cb0);
      color: #fff;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin: 10px;
    }
    .btn:hover {
      opacity: 0.9;
    }
    .analysis-section {
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      margin-top: 20px;
      display: none;
    }
    .chart-container {
      margin-bottom: 40px;
    }
    .chart-title {
      text-align: center;
      font-size: 1.3rem;
      font-weight: bold;
      color: #2a5298;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Barom√®tre Sant√© 2025</h1>
      <h2>Cabinet Saint Germain Audit</h2>
      <p>Analyse compl√®te et export PDF professionnel avec graphiques</p>
    </div>

    <div style="text-align:center;">
      <input type="file" id="fileInput" multiple accept=".json" />
      <button id="analyzeBtn" class="btn" onclick="analyzeData()">Analyser les donn√©es</button>
    </div>

    <div class="analysis-section" id="analysisSection">
      <h2 style="text-align:center; color:#2a5298;">R√©sultats de l'Analyse</h2>
      <div id="chartsContainer"></div>
      <div style="text-align:center;">
        <button class="btn" onclick="exportDetailedPDF()">üìÑ G√©n√©rer le PDF</button>
      </div>
    </div>
  </div>

  <script>
    let responses = [];
    let charts = {};
    let analysisData = {};
    
    // Exemple r√©duit de configuration questions (reprendre ton questionConfig complet)
    const questionConfig = [
      {
        key: 'sante_physique',
        label: 'Sant√© physique',
        question: 'Comment √©valuez-vous votre sant√© physique actuelle ?',
        type: 'scale',
        min: 1,
        max: 10
      },
      {
        key: 'sante_psychologique',
        label: 'Sant√© psychologique',
        question: 'Comment √©valuez-vous votre sant√© psychologique actuelle ?',
        type: 'scale',
        min: 1,
        max: 10
      },
      {
        key: 'commentaires',
        label: 'Commentaires et suggestions',
        question: 'Vos remarques ?',
        type: 'text'
      }
    ];

    document.getElementById('fileInput').addEventListener('change', function(e){
      const files = e.target.files;
      responses = [];
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(ev) {
          try {
            const data = JSON.parse(ev.target.result);
            responses.push(data);
          } catch(err) {
            console.error("Erreur JSON", err);
          }
        };
        reader.readAsText(file);
      });
    });

    function analyzeData() {
      if (responses.length === 0) {
        alert("Aucun fichier charg√© !");
        return;
      }
      const container = document.getElementById("chartsContainer");
      container.innerHTML = "";
      charts = {};
      questionConfig.forEach((q, idx) => {
        if (q.type === "text") return; // pas de graphique
        const chartDiv = document.createElement("div");
        chartDiv.className = "chart-container";
        const title = document.createElement("div");
        title.className = "chart-title";
        title.textContent = q.label;
        const canvas = document.createElement("canvas");
        canvas.id = "chart_"+q.key;
        chartDiv.appendChild(title);
        chartDiv.appendChild(canvas);
        container.appendChild(chartDiv);
        const ctx = canvas.getContext("2d");
        // exemple simple : compter
        const counts = {};
        responses.forEach(r=>{
          if (r[q.key]) {
            const val = r[q.key].toString();
            counts[val] = (counts[val]||0)+1;
          }
        });
        const labels = Object.keys(counts);
        const data = Object.values(counts);
        charts[q.key] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{data:data, backgroundColor:"#4299e1"}]
          },
          options: {responsive:true, plugins:{legend:{display:false}}}
        });
      });
      document.getElementById("analysisSection").style.display = "block";
    }

    async function exportDetailedPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:"portrait", unit:"pt", format:"a4"});
      const pageWidth = doc.internal.pageSize.getWidth();
      let y = 60;

      doc.setFontSize(20);
      doc.setTextColor(42,82,152);
      doc.text("Barom√®tre Sant√© 2025", pageWidth/2, y, {align:"center"});
      y += 30;
      doc.setFontSize(12);
      doc.setTextColor(60);
      doc.text(`Nombre de r√©pondants : ${responses.length}`, pageWidth/2, y, {align:"center"});
      y += 50;

      // Parcours questions
      for (const q of questionConfig) {
        doc.setFontSize(14);
        doc.setTextColor(42,82,152);
        doc.text(q.label, 40, y);
        y += 20;
        doc.setFontSize(11);
        doc.setTextColor(50);
        doc.text(q.question, 50, y);
        y += 20;

        if (q.type === "text") {
          const commentaires = responses.map(r=>r[q.key]).filter(Boolean);
          if (commentaires.length === 0) {
            doc.text("Aucun commentaire saisi", 60, y);
            y+=30;
          } else {
            commentaires.forEach(c=>{
              const lines = doc.splitTextToSize("‚Ä¢ "+c, pageWidth-100);
              doc.text(lines, 60, y);
              y += lines.length*14+10;
              if (y>750){doc.addPage(); y=60;}
            });
          }
        } else {
          // ins√©rer graphique si existant
          const chart = charts[q.key];
          if (chart) {
            const canvas = chart.canvas;
            const imgData = canvas.toDataURL("image/png",1.0);
            doc.addImage(imgData, "PNG", 80, y, pageWidth-160, 200);
            y += 220;
          }
        }
        if (y>750){doc.addPage(); y=60;}
      }

      doc.save("Barometre_Sante_2025.pdf");
    }
  </script>
</body>
</html>
